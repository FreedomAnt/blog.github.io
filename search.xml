<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Android 7.0 以上网络安全配置</title>
    <url>/Bug%E8%A7%A3%E5%86%B3/Android/Android-7-0-%E4%BB%A5%E4%B8%8A%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h1 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h1><p>开发中遇到 Android 模拟器跑项目一直请求不到网络链接。Android 版本 9.0 API28</p>
<span id="more"></span>

<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>在 Android 7.0 以上的系统中，Google 引入了一种名为网络安全配置（Network Security Configuration）的功能。<br>全面禁止了非安全的加密，如果要使用非加密的链接，需要配置 network_security_config.xml</p>
<ol>
<li>在 res/xml 下面新建一个 xml 文件，取名为 network_security_config.xml<br>配置如下<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>network-security-config</span><span class="token punctuation">></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>base-config</span> <span class="token attr-name">cleartextTrafficPermitted</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>network-security-config</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>在 res 下面的 AndroidManifest.xml 中的 application 标签中 添加<code>android:networkSecurityConfig=&quot;@xml/network_security_config&quot;</code></li>
</ol>
]]></content>
      <categories>
        <category>Bug解决</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>network</tag>
      </tags>
  </entry>
  <entry>
    <title>Android上canvas不显示</title>
    <url>/Bug%E8%A7%A3%E5%86%B3/Android/Android%E4%B8%8Acanvas%E4%B8%8D%E6%98%BE%E7%A4%BA/</url>
    <content><![CDATA[<h1 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h1><p>这次遇到的问题是 echarts 的图形在 android 模拟器中不显示，Android 版本 9.0 API28</p>
<span id="more"></span>

<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>Android 在 API14 以上默认启用硬件加速，如果启用硬件加速导致了视图的绘制，Android 允许您在多个级别选择是启用还是停用硬件加速。详见<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYW5kcm9pZC5nb29nbGUuY24vZ3VpZGUvdG9waWNzL2dyYXBoaWNzL2hhcmR3YXJlLWFjY2VsP2hsPXpoLWNuI2NvbnRyb2xsaW5n">控制硬件加速<i class="fa fa-external-link-alt"></i></span><br>可以从以下四个级别控制硬件加速</p>
<ul>
<li>应用 Application<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span> <span class="token attr-name"><span class="token namespace">android:</span>hardwareAccelerated</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">...</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li>Activity<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span> <span class="token attr-name"><span class="token namespace">android:</span>hardwareAccelerated</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li>窗口 Window<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>
      <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span>FLAG_HARDWARE_ACCELERATED<span class="token punctuation">,</span>
      <span class="token class-name">WindowManager<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">.</span>FLAG_HARDWARE_ACCELERATED<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
<li>视图 View<pre class="line-numbers language-java" data-language="java"><code class="language-java">myView<span class="token punctuation">.</span><span class="token function">setLayerType</span><span class="token punctuation">(</span><span class="token class-name">View</span><span class="token punctuation">.</span>LAYER_TYPE_SOFTWARE<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
<p>在这四个层次中，应用和 Activity 是可以选择打开或者关闭加速的，窗口只能打开加速，视图层只能关闭加速。<br>关闭硬件加速后，canvas 可以显示。</p>
]]></content>
      <categories>
        <category>Bug解决</category>
        <category>Android</category>
      </categories>
      <tags>
        <tag>android</tag>
        <tag>canvas</tag>
      </tags>
  </entry>
  <entry>
    <title>Sentry部署</title>
    <url>/%E5%BC%80%E5%8F%91/%E9%94%99%E8%AF%AF%E8%BF%BD%E8%B8%AA/Sentry%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dldHNlbnRyeS9zZW50cnk=">Sentry<i class="fa fa-external-link-alt"></i></span>是一个实时事件记录和聚合平台。本身是基于 Django 开发的，而且也依赖到其他的如 Postgresql、 Redis 等数据库，所以一般有两种途径进行安装：通过 Docker 或用 Python 搭建。</p>
<span id="more"></span>

<p>如果你选择了通过 Docker 进行安装，有更加便捷的方式——docker-compose 。在 github 上有一个开源项目<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2dldHNlbnRyeS9vbnByZW1pc2U=">onpremise<i class="fa fa-external-link-alt"></i></span>用于部署 Sentry，可以直接运行该项目中的 <code>./install.sh</code> 将 Sentry 及其依赖都通过 docker 安装。</p>
<p>我们这里使用常规的 docker 安装，<span class="exturl" data-url="aHR0cHM6Ly9odWIuZG9ja2VyLmNvbS9fL3NlbnRyeQ==">文档地址<i class="fa fa-external-link-alt"></i></span></p>
<h1 id="启动一个-Redis-容器"><a href="#启动一个-Redis-容器" class="headerlink" title="启动一个 Redis 容器"></a>启动一个 Redis 容器</h1><p>Start a Redis container</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d --name sentry-redis redis<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="启动一个-Postgres-容器"><a href="#启动一个-Postgres-容器" class="headerlink" title="启动一个 Postgres 容器"></a>启动一个 Postgres 容器</h1><p>Start a Postgres container</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d --name sentry-postgres -e POSTGRES_PASSWORD&#x3D;secret -e POSTGRES_USER&#x3D;sentry postgres<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="生成唯一秘钥"><a href="#生成唯一秘钥" class="headerlink" title="生成唯一秘钥"></a>生成唯一秘钥</h1><p>生成一个密钥，用于后面所有 sentry 容器之间握手。请记住这串密钥，在后面的 docker 命令中，密钥需要以环境变量形式传入</p>
<p>Generate a new secret key to be shared by all <code>sentry</code> containers. This value will then be used as the <code>SENTRY_SECRET_KEY</code> environment variable.</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run --rm sentry config generate-secret-key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="连接-Redis、Postgres-和-Sentry"><a href="#连接-Redis、Postgres-和-Sentry" class="headerlink" title="连接 Redis、Postgres 和 Sentry"></a>连接 Redis、Postgres 和 Sentry</h1><p>运行后会自动执行初始化操作.</p>
<p>If this is a new database, you’ll need to run <code>upgrade</code></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -it --rm -e SENTRY_SECRET_KEY&#x3D;&#39;&lt;secret-key&gt;&#39; --link sentry-postgres:postgres --link sentry-redis:redis sentry upgrade<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>Note: the <code>-it</code> is important as the initial upgrade will prompt to create an initial user and will fail without it</strong></p>
<blockquote>
<p>此处执行过程中会提示创建账号和密码，如果此处不想创建，等所有步骤执行完成后，再运行命令来创建：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker exec -it my-sentry &#x2F;bin&#x2F;sh &#x3D;&#x3D;&gt; sentry createuser<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</blockquote>
<p>创建账号密码<span class="exturl" data-url="bWFpbHRvOiYjNTc7JiN4MzI7JiN4MzU7JiN4MzU7JiM1NjsmI3gzMzsmI3gzODsmIzUyOyYjNTc7JiN4NDA7JiN4NzE7JiMxMTM7JiM0NjsmI3g2MzsmIzExMTsmIzEwOTs=">&#57;&#x32;&#x35;&#x35;&#56;&#x33;&#x38;&#52;&#57;&#x40;&#x71;&#113;&#46;&#x63;&#111;&#109;<i class="fa fa-external-link-alt"></i></span>/123456</p>
<h1 id="启动-Sentry-Server，同时添加端口映射"><a href="#启动-Sentry-Server，同时添加端口映射" class="headerlink" title="启动 Sentry Server，同时添加端口映射"></a>启动 Sentry Server，同时添加端口映射</h1><p>启动 Sentry Server，同时添加端口映射。Sentry 的端口为 9000，可以使用 <code>-p 9000:9000</code> 参数，再启动后可以通过访问 <code>http://localhost:9000</code> 或 <code>http://host-ip:9000</code> 进入 Sentry 的 web 管理页面</p>
<p>Now start up Sentry server</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d --name my-sentry -p 9000:9000 -e SENTRY_SECRET_KEY&#x3D;&#39;&lt;secret-key&gt;&#39; --link sentry-redis:redis --link sentry-postgres:postgres sentry<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="默认配置中需要-Celery"><a href="#默认配置中需要-Celery" class="headerlink" title="默认配置中需要 Celery"></a>默认配置中需要 Celery</h1><p>因此启动一个 Celery 主节点与执行节点（worker 节点可按需多启几个）：</p>
<p>The default config needs a celery beat and celery workers, start as many workers as you need (each with a unique name)</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d --name sentry-cron -e SENTRY_SECRET_KEY&#x3D;&#39;&lt;secret-key&gt;&#39; --link sentry-postgres:postgres --link sentry-redis:redis sentry run cron
$ docker run -d --name sentry-worker-1 -e SENTRY_SECRET_KEY&#x3D;&#39;&lt;secret-key&gt;&#39; --link sentry-postgres:postgres --link sentry-redis:redis sentry run worker<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h1 id="登录-sentry"><a href="#登录-sentry" class="headerlink" title="登录 sentry"></a>登录 sentry</h1><p>地址:<code>http://127.0.0.1:9000</code>，账号密码是<span class="exturl" data-url="bWFpbHRvOiYjeDM5OyYjeDMyOyYjNTM7JiM1MzsmIzU2OyYjNTE7JiM1NjsmI3gzNDsmIzU3OyYjNjQ7JiN4NzE7JiMxMTM7JiN4MmU7JiN4NjM7JiMxMTE7JiMxMDk7">&#x39;&#x32;&#53;&#53;&#56;&#51;&#56;&#x34;&#57;&#64;&#x71;&#113;&#x2e;&#x63;&#111;&#109;<i class="fa fa-external-link-alt"></i></span>/123456</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510170805.png"></p>
<p>我们可以创建一个 Vue 项目，在 Browser 里面可以选</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512163352.png"></p>
<h2 id="配置邮箱告警"><a href="#配置邮箱告警" class="headerlink" title="配置邮箱告警"></a>配置邮箱告警</h2><ul>
<li><p>进入控制台</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker exec -it my-sentry bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>修改配置文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ vi &#x2F;etc&#x2F;sentry&#x2F;config.yml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>腾讯示例：</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>作用</th>
<th>腾讯企业邮箱</th>
</tr>
</thead>
<tbody><tr>
<td>SENTRY_EMAIL_HOST</td>
<td>SMTP 服务器地址</td>
<td>smtp.exmail.qq.com</td>
</tr>
<tr>
<td>SENTRY_EMAIL_USER</td>
<td>登录的邮箱账号</td>
<td><span class="exturl" data-url="bWFpbHRvOiYjeDY1OyYjeDc4OyYjeDYxOyYjMTA5OyYjeDcwOyYjMTA4OyYjeDY1OyYjeDQwOyYjeDZkOyYjOTc7JiN4Njk7JiMxMDg7JiM0NjsmI3g2MzsmIzExMTsmIzEwOTs=">&#x65;&#x78;&#x61;&#109;&#x70;&#108;&#x65;&#x40;&#x6d;&#97;&#x69;&#108;&#46;&#x63;&#111;&#109;<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>SENTRY_EMAIL_PASSWORD</td>
<td>登录的邮箱密码</td>
<td>password</td>
</tr>
<tr>
<td>SENTRY_EMAIL_PORT</td>
<td>登录的端口</td>
<td>587</td>
</tr>
<tr>
<td>SENTRY_EMAIL_USE_TLS</td>
<td>是否使用 ssl 连接</td>
<td>true</td>
</tr>
<tr>
<td>SENTRY_SERVER_EMAIL</td>
<td>发送的账户，跟 SENTRY_EMAIL_USER 相同</td>
<td><span class="exturl" data-url="bWFpbHRvOiYjMTAxOyYjeDc4OyYjOTc7JiMxMDk7JiN4NzA7JiN4NmM7JiMxMDE7JiN4NDA7JiN4NmQ7JiN4NjE7JiMxMDU7JiN4NmM7JiN4MmU7JiN4NjM7JiMxMTE7JiMxMDk7">&#101;&#x78;&#97;&#109;&#x70;&#x6c;&#101;&#x40;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#x63;&#111;&#109;<i class="fa fa-external-link-alt"></i></span></td>
</tr>
</tbody></table>
<pre><code>网易邮箱示例：

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">
<span class="token key atrule">mail.backend</span><span class="token punctuation">:</span> <span class="token string">"smtp"</span>
<span class="token key atrule">mail.host</span><span class="token punctuation">:</span> <span class="token string">"smtp.126.com"</span>
<span class="token key atrule">mail.port</span><span class="token punctuation">:</span> <span class="token number">25</span>
<span class="token key atrule">mail.username</span><span class="token punctuation">:</span> <span class="token string">"fswuming@126.com"</span>
<span class="token key atrule">mail.password</span><span class="token punctuation">:</span> <span class="token string">"XXXXX"</span>
<span class="token key atrule">mail.use-tls</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">mail.from</span><span class="token punctuation">:</span> <span class="token string">"fswuming@126.com"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</code></pre>
<pre class="line-numbers language-none"><code class="language-none">
## 配置 Vue 项目

详见[配置文档](https:&#x2F;&#x2F;docs.sentry.io&#x2F;platforms&#x2F;javascript&#x2F;guides&#x2F;vue&#x2F;)

&#96;&#96;&#96;javascript
import Vue from &quot;vue&quot;;
import * as Sentry from &quot;@sentry&#x2F;browser&quot;;
import &#123; Vue as VueIntegration &#125; from &quot;@sentry&#x2F;integrations&quot;;
Sentry.init(&#123;
  dsn: &quot;http:&#x2F;&#x2F;d6168c0c5ba947f0b7fafbb288522b0e@127.0.0.1:9000&#x2F;2&quot;,
  integrations: [new VueIntegration(&#123; Vue, attachProps: true &#125;)],
&#125;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<p>这里的 dsn 可以在该项目的<code>设置 =&gt; Client Keys (DSN)</code>客户端密钥里面找到</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512165049.png"></p>
<h3 id="参数解释"><a href="#参数解释" class="headerlink" title="参数解释"></a>参数解释</h3><ol>
<li><p>传递 Vue 是可选的，如果不传递，则 window.Vue 必须存在。</p>
</li>
<li><p>传递 attachProps 是可选的，默认 true。如果将其设置为 false，Sentry 将禁止发送所有 Vue 组件的道具进行记录。</p>
</li>
<li><p>传递 logErrors 是可选的，默认 false。如果将其设置为 true，Sentry 也将调用原始 Vue 的 logError 函数。</p>
</li>
</ol>
<blockquote>
<p>Vue 错误处理<br>请注意，如果启用此集成，则 Vue 不会在 logError 内部调用它。这意味着在 Vue 渲染器中发生的错误将不会显示在开发人员控制台中。如果要保留此功能，请确保通过该 logErrors: true 选项。</p>
</blockquote>
<ol start="4">
<li><p>跟踪 Vue 应用程序的最基本配置（仅跟踪顶级组件）如下所示</p>
<p><code>@sentry/tracing</code>监控性能，<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNlbnRyeS5pby9wbGF0Zm9ybXMvamF2YXNjcmlwdC9ndWlkZXMvdnVlL3BlcmZvcm1hbmNlLyNjb25maWd1cmUtdGhlLXNhbXBsZS1yYXRl">配置采样率<i class="fa fa-external-link-alt"></i></span>，</p>
</li>
</ol>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Sentry <span class="token keyword">from</span> <span class="token string">"@sentry/browser"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Vue <span class="token keyword">as</span> VueIntegration <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"@sentry/integrations"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Integrations <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"@sentry/tracing"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">"vue"</span><span class="token punctuation">;</span>
Sentry<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  integrations<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">Integrations<span class="token punctuation">.</span>BrowserTracing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">VueIntegration</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      Vue<span class="token punctuation">,</span>
      tracing<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  tracesSampleRate<span class="token operator">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token comment">// Be sure to lower this in production</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果要跟踪子组件，并查看有关渲染过程的更多详细信息，请配置集成以跟踪所有子组件：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">VueIntegration</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  Vue<span class="token punctuation">,</span>
  tracing<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  tracingOptions<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    trackComponents<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="启用-sourceMap-以方便定位-bug"><a href="#启用-sourceMap-以方便定位-bug" class="headerlink" title="启用 sourceMap 以方便定位 bug"></a>启用 sourceMap 以方便定位 bug</h2><p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNlbnRyeS5pby9wbGF0Zm9ybXMvamF2YXNjcmlwdC9ndWlkZXMvdnVlL3NvdXJjZW1hcHMv">配置 sourceMap 文档地址<i class="fa fa-external-link-alt"></i></span></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ npm install --save-dev @sentry&#x2F;webpack-plugin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> SentryWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"@sentry/webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// other configuration</span>
  configureWebpack<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">SentryWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token comment">// sentry-cli configuration</span>
        authToken<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SENTRY_AUTH_TOKEN</span><span class="token punctuation">,</span>
        org<span class="token operator">:</span> <span class="token string">"exmaple-org"</span><span class="token punctuation">,</span>
        project<span class="token operator">:</span> <span class="token string">"example-project"</span><span class="token punctuation">,</span>

        <span class="token comment">// webpack specific configuration</span>
        include<span class="token operator">:</span> <span class="token string">"."</span><span class="token punctuation">,</span>
        ignore<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"node_modules"</span><span class="token punctuation">,</span> <span class="token string">"webpack.config.js"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>In Vue 2.x, you should use vue.config.js instead of webpack.config.js, and use include: “./dist” instead of include: “.”</p>
</blockquote>
<p>也可以通过配置文件的方式</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">plugins<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">"development"</span>
  <span class="token operator">?</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">SentryWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        release<span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 唯一标识，可以用其他的比如 hash</span>
        <span class="token comment">// webpack specific configuration</span>
        include<span class="token operator">:</span> <span class="token string">"./dist"</span><span class="token punctuation">,</span>
        ignore<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"node_modules"</span><span class="token punctuation">,</span> <span class="token string">"vue.config.js"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        configFile<span class="token operator">:</span> <span class="token string">".sentryclirc"</span><span class="token punctuation">,</span> <span class="token comment">// 默认同级，如果不一样需要用node path模块处理一下</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>.sentryclirc</code>配置文件<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNlbnRyeS5pby9wcm9kdWN0L2NsaS9jb25maWd1cmF0aW9uLw==">详见文档<i class="fa fa-external-link-alt"></i></span>如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">[</span>defaults<span class="token punctuation">]</span>
<span class="token comment">### 你的域名</span>
url='http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>9000'
<span class="token comment">### 组织团队名默认是 sentry</span>
org=sentry
<span class="token comment">### 项目名称</span>
project=vue
<span class="token comment">### 步骤1创建的</span>
<span class="token punctuation">[</span>auth<span class="token punctuation">]</span>
token=1ef3e7b88d614ca9aa155fe693b5a68eb73fa88aacd941cdb9cd0a86091c0894<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中<code>token</code>生成方式: 登陆 sentry 控制台页面，点击左上角头像，再点击<code>API keys-&gt;授权令牌</code></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512170506.png"></p>
<p><strong>提示：docker 生成版本较低，建议 github 上下载或者直接用线上的 Saas 做。</strong></p>
]]></content>
      <categories>
        <category>开发</category>
        <category>错误追踪</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>sentry</tag>
      </tags>
  </entry>
  <entry>
    <title>code-server搭建在线VSCode环境</title>
    <url>/%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/code-server%E6%90%AD%E5%BB%BA%E5%9C%A8%E7%BA%BFVSCode%E7%8E%AF%E5%A2%83/</url>
    <content><![CDATA[<p>code-server 可以使用户能在浏览器端搭建 VSCode 环境。<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nkci9jb2RlLXNlcnZlcg==">地址<i class="fa fa-external-link-alt"></i></span></p>
<span id="more"></span>

<h1 id="创建-code-server"><a href="#创建-code-server" class="headerlink" title="创建 code-server"></a>创建 code-server</h1><p>根据 docker 创建</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -itd --name code-server -p 8080:8080 \
  -v d:&#x2F;docker&#x2F;code-server&#x2F;project:&#x2F;home&#x2F;coder&#x2F;project \
  codercom&#x2F;code-server:latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果需要设置密码的话</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -itd --name code-server -u root -p 8080:8080 \
  -v d:&#x2F;docker&#x2F;code-server&#x2F;project:&#x2F;home&#x2F;coder&#x2F;project \
  -e PASSWORD&#x3D;123456 \
  codercom&#x2F;code-server:latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建之后打开<code>http://localhost:8080</code>登录</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512161008.png"></p>
<p>如果创建的时候没有设置密码，第一次需要输入密码，密码查看方式为：</p>
<ul>
<li><p>登录到控制台</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker exec -it code-server &#x2F;bin&#x2F;bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>查看密码</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ vi ~&#x2F;.config&#x2F;code-server&#x2F;config.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
<p>登录成功之后可以看到界面，后面就和我们平时写代码一样了</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512161220.png"></p>
]]></content>
      <categories>
        <category>搭建教程</category>
      </categories>
      <tags>
        <tag>code-server</tag>
        <tag>vscode</tag>
      </tags>
  </entry>
  <entry>
    <title>chrome插件简易入门</title>
    <url>/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/chrome%E6%8F%92%E4%BB%B6%E7%AE%80%E6%98%93%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<p>项目上需要统计市面上的一些电视型号信息，想到可以用 chrome 插件来做，这里记录一下简易插件的实现过程。</p>
<span id="more"></span>

<h1 id="manifest-json"><a href="#manifest-json" class="headerlink" title="manifest.json"></a>manifest.json</h1><p>主要文件 manifest.json 包含了插件一些基础配置，代码如下：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"manifest_version"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"GetAndroidTVList"</span><span class="token punctuation">,</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"获取安卓版本的电视列表"</span><span class="token punctuation">,</span>
  <span class="token property">"icons"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"16"</span><span class="token operator">:</span> <span class="token string">"img/icon.png"</span><span class="token punctuation">,</span>
    <span class="token property">"48"</span><span class="token operator">:</span> <span class="token string">"img/icon.png"</span><span class="token punctuation">,</span>
    <span class="token property">"128"</span><span class="token operator">:</span> <span class="token string">"img/icon.png"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"browser_action"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"default_icon"</span><span class="token operator">:</span> <span class="token string">"img/icon.png"</span><span class="token punctuation">,</span>
    <span class="token property">"default_title"</span><span class="token operator">:</span> <span class="token string">"获取安卓版本的电视列表"</span><span class="token punctuation">,</span>
    <span class="token property">"default_popup"</span><span class="token operator">:</span> <span class="token string">"popup.html"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"background"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"background.js"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"permissions"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"contextMenus"</span><span class="token punctuation">,</span> <span class="token string">"notifications"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"content_scripts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"matches"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"http://detail.zol.com.cn/digital_tv_advSearch/*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"js"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"content-script.js"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"run_at"</span><span class="token operator">:</span> <span class="token string">"document_end"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"homepage_url"</span><span class="token operator">:</span> <span class="token string">"https://xxxxx/"</span><span class="token punctuation">,</span>
  <span class="token property">"options_page"</span><span class="token operator">:</span> <span class="token string">"options.html"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里我们使用的 v2 版本，现在 v3 版本也可以用了，<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuY2hyb21lLmNvbS9kb2NzL2V4dGVuc2lvbnMvbXYzL2dldHN0YXJ0ZWQv">地址<i class="fa fa-external-link-alt"></i></span></p>
<p>主要介绍几个常用的属性，</p>
<ul>
<li>browser_action：浏览器右上角图标设置</li>
<li>background：后台常驻 script</li>
<li>permissions：此插件用到的浏览器的权限，我们这里用到了右键菜单<code>contextMenus</code>和通知<code>notifications</code></li>
<li>content_scripts：<strong>需要直接注入页面的 js</strong><ul>
<li>matches：匹配地址</li>
<li>js：待注入的 js</li>
<li>run_at：注入的时间，可选 document_start、document_end、document_idle</li>
</ul>
</li>
<li>homepage_url：扩展的主页 url</li>
<li>options_page：插件选项页</li>
</ul>
<p>这里贴一下其他文件的示例代码</p>
<h1 id="background-js"><a href="#background-js" class="headerlink" title="background.js"></a>background.js</h1><pre class="line-numbers language-js" data-language="js"><code class="language-js">chrome<span class="token punctuation">.</span>contextMenus<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  title<span class="token operator">:</span> <span class="token string">"添加TV数据"</span><span class="token punctuation">,</span>
  id<span class="token operator">:</span> <span class="token string">"GetTV"</span><span class="token punctuation">,</span>
  <span class="token function-variable function">onclick</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    chrome<span class="token punctuation">.</span>notifications<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      type<span class="token operator">:</span> <span class="token string">"basic"</span><span class="token punctuation">,</span>
      iconUrl<span class="token operator">:</span> <span class="token string">"img/icon.png"</span><span class="token punctuation">,</span>
      title<span class="token operator">:</span> <span class="token string">"这是标题"</span><span class="token punctuation">,</span>
      message<span class="token operator">:</span> <span class="token string">"您刚才点击了自定义右键菜单！"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="content-script-js"><a href="#content-script-js" class="headerlink" title="content-script.js"></a>content-script.js</h1><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> l <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">"pro_detail"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token keyword">var</span> str <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  str <span class="token operator">+=</span>
    document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">"pro_detail"</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token punctuation">.</span>textContent<span class="token punctuation">;</span>
  str <span class="token operator">+=</span> <span class="token string">"、"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就实现了一个简易的获取 androidTV 的名称的 chrome 插件，名称打印到 console 的。</p>
<h1 id="安装扩展"><a href="#安装扩展" class="headerlink" title="安装扩展"></a>安装扩展</h1><p>这里我们打开 chrome 浏览器输入<code>chrome://extensions/</code>，点击页面右上角打开<code>开发者模式</code>，选择左上角<code>加载已解压的扩展程序</code>，选中我们的测试插件即可。</p>
]]></content>
      <categories>
        <category>工作笔记</category>
      </categories>
      <tags>
        <tag>chromeExtension</tag>
      </tags>
  </entry>
  <entry>
    <title>docker+gitlab-ci+ssh+gitlab-pages实现代码自动构建部署</title>
    <url>/%E5%BC%80%E5%8F%91/Devops/docker-gitlab-ci-ssh-pages%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h1 id="主要操作步骤"><a href="#主要操作步骤" class="headerlink" title="主要操作步骤"></a>主要操作步骤</h1><p>这里我们使用 docker 创建一台用于部署的 centos 服务器，一台用于 gitlab-runner 的服务器</p>
<ol>
<li><strong>使用 ssh-keygen 在本地创建新的 SSH 密钥对。</strong></li>
<li><strong>将私钥作为变量添加到您的项目中。</strong></li>
<li><strong>运行 ssh-agent 以加载私钥。</strong></li>
<li><strong>将公共密钥复制到您想要访问的服务器上（通常在 <code>~/.ssh/authorized_keys</code>中），或者在访问私有 GitLab 存储库时将其添加为部署密钥。</strong></li>
</ol>
<span id="more"></span>

<h1 id="配置部署服务器"><a href="#配置部署服务器" class="headerlink" title="配置部署服务器"></a>配置部署服务器</h1><p>由于 docker 启动的 centos 不能使用 systemctl，包括安装 server 命令都不行，网上有解决方法如下：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -itd -p 10022:22 --name centos8 --privileged&#x3D;true centos &#x2F;sbin&#x2F;init<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>但不适合于 docker 的 windows 版本，所以这里安装 centos7 以下的版本，不使用 systemctl。</p>
<h2 id="下载-centos6-10-并进入控制台"><a href="#下载-centos6-10-并进入控制台" class="headerlink" title="下载 centos6.10 并进入控制台"></a>下载 centos6.10 并进入控制台</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -itd -p 10022:22 --name centos6 centos:6.10 bash
$ docker exec -it centos6 bash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这里直接 run 一个 container 。如果 run 之前没有 pull centos6 的话，在 run 的时候 docker 会自动去找相应的 image 去拉取，把 22 端口映射到宿主机的 10022 端口，方便 ssh。</p>
<h2 id="安装-openssh-server"><a href="#安装-openssh-server" class="headerlink" title="安装 openssh-server"></a>安装 openssh-server</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ rpm -qa | grep ssh
$ yum update -y &amp;&amp; yum install openssh-server -y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="设置-ssh-允许-root-登录"><a href="#设置-ssh-允许-root-登录" class="headerlink" title="设置 ssh 允许 root 登录"></a>设置 ssh 允许 root 登录</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ vi &#x2F;etc&#x2F;ssh&#x2F;sshd_config<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>PermitRootLogin 修改为 yes。方便 gitlab-runner 的机器登录</p>
<h2 id="开启-ssh-服务"><a href="#开启-ssh-服务" class="headerlink" title="开启 ssh 服务"></a>开启 ssh 服务</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ &#x2F;etc&#x2F;init.d&#x2F;sshd start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看 ssh 是否已经启动</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ ps -ef|grep ssh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="安装-rsync"><a href="#安装-rsync" class="headerlink" title="安装 rsync"></a>安装 rsync</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ yum install rsync -y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>如果用 scp 传的话本地和远程都需要安装 openssh-client，如果用 rsync 传的话本地和远程都需要安装 rsync。</strong></p>
<h2 id="修改-root-密码"><a href="#修改-root-密码" class="headerlink" title="修改 root 密码"></a>修改 root 密码</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ passwd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里设置为 123456，方便登录验证。</p>
<h1 id="配置-gitlab-runner"><a href="#配置-gitlab-runner" class="headerlink" title="配置 gitlab-runner"></a>配置 gitlab-runner</h1><h2 id="下载-gitlab-runner-并进入控制台"><a href="#下载-gitlab-runner-并进入控制台" class="headerlink" title="下载 gitlab-runner 并进入控制台"></a>下载 gitlab-runner 并进入控制台</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d --name gitlab-runner -v d:&#x2F;docker&#x2F;gitlab-runner&#x2F;config:&#x2F;etc&#x2F;gitlab-runner gitlab&#x2F;gitlab-runner:latest
$ docker exec -it gitlab-runner bash<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="注册-gitlab-runner"><a href="#注册-gitlab-runner" class="headerlink" title="注册 gitlab-runner"></a>注册 gitlab-runner</h2><p>注册一个 gitlab-runner，<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vcnVubmVyL3JlZ2lzdGVyLyNsaW51eA==">注册文档<i class="fa fa-external-link-alt"></i></span></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ gitlab-runner register<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以用<code>gitlab-runner --help</code>查看 gitlab-runner 的<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vcnVubmVyL2NvbW1hbmRzL1JFQURNRS5odG1sI2dpdGxhYi1ydW5uZXItY29tbWFuZHM=">所有命令<i class="fa fa-external-link-alt"></i></span>，配置文件在<code>/etc/gitlab-runner/config.toml</code></p>
<p>打开<code>Setting =&gt; CI/CD =&gt; Runners</code>可以看到注册需要的 url 和 token，注册的时候需要填写，这里注意填写下 tags，后面方便用到。执行环境选择的 shell，如果执行环境选 docker 的话，相应的版本可以选 alpine:latest。<br>试过 docker，因为没有映射<code>/var/run/docker.sock</code>，用 docker 执行 jobs 有时候会报错。所以这里我改成了 shell。这里 runner 名称我们定为 testci，在<code>Setting =&gt; CI/CD =&gt; Runners</code>里面可以看到我们的 runner</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510204111.png"></p>
<h1 id="配置-CI-CD"><a href="#配置-CI-CD" class="headerlink" title="配置 CI/CD"></a>配置 CI/CD</h1><p>这里我们使用 SSH 的方式来达到 CI/CD 的目的，<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vZWUvY2kvc3NoX2tleXMvaW5kZXguaHRtbCN1c2luZy1zc2gta2V5cy13aXRoLWdpdGxhYi1jaWNk">详见文档<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="在本机生成密钥对"><a href="#在本机生成密钥对" class="headerlink" title="在本机生成密钥对"></a>在本机生成密钥对</h2><p>在本机上<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vZWUvc3NoL1JFQURNRS5odG1sI2dlbmVyYXRlLWFuLXNzaC1rZXktcGFpcg==">生成密钥<i class="fa fa-external-link-alt"></i></span>，密钥名称我们改为了 runnerkey，避免生成的密钥文件将原来的其他密钥覆盖掉。密钥的类型官方推荐是 ed25519，<strong>但是 centos6.10 不支持 ed25519，这里还是换成 rsa。</strong>linux 用户生成文件在<code>/home/用户名/.ssh</code>文件夹，windows 用户在<code>C:\Users\用户名\.ssh</code>文件夹。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ ssh-keygen -t rsa -f runnerkey<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="公钥放到要部署的服务器"><a href="#公钥放到要部署的服务器" class="headerlink" title="公钥放到要部署的服务器"></a>公钥放到要部署的服务器</h2><p>切换到<code>.ssh</code>目录，公钥放到要部署的服务器的<code>~/.ssh/authorized_keys</code>文件里，这里由于我们是用的 docker，端口是映射出来的，所有我们这里用的 localhost，实际环境中需要换成要部署的服务器地址。注意这里如果要查看 authorized_keys 文件的话，需注意是否为隐藏文件，显示隐藏文件为<code>ls -a</code>，带<code>-a</code>参数。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ ssh-copy-id -i runnerkey.pub root@localhost -p 10022<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>按照提示输入密码就行了。</p>
<h2 id="私钥配置到-gitlab-变量"><a href="#私钥配置到-gitlab-变量" class="headerlink" title="私钥配置到 gitlab 变量"></a>私钥配置到 gitlab 变量</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ cat runnerkey<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里可以把服务器地址、端口都配置上，这里我们的项目名称为 testpagecenter，进入到项目的配置里面，路径为 gitlab 页面上项目里的<code>Setting =&gt; CI/CD =&gt; Variables =&gt; Add Variables</code>。</p>
<ul>
<li><code>SSH_KNOWN_HOSTS</code>：这里我们配置为本机的局域网地址<code>192.168.9.200</code></li>
<li><code>SSH_KNOWN_HOSTS_PORT</code>：10022</li>
<li><code>SSH_PRIVATE_KEY</code>：配置为你的私钥，即文件 runnerkey 内容</li>
</ul>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510200906.png" alt="配置变量"></p>
<h2 id="用-root-登录-gitlab-runner-服务器"><a href="#用-root-登录-gitlab-runner-服务器" class="headerlink" title="用 root 登录 gitlab-runner 服务器"></a>用 root 登录 gitlab-runner 服务器</h2><p>用 root 登录 gitlab-runner 服务器并设置为可无密码切换到 root。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ apt-get install sudo -y
$ apt-get install vim -y
$ vim &#x2F;etc&#x2F;sudoers<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>由于操作命令是用户<code>gitlab-runner</code>来操作的，每次需要 sudo，所以这里设置允许<code>gitlab-runner</code>的无密码切换，在<code>/etc/sudoers</code>添加以下命令</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ gitlab-runner ALL&#x3D;(ALL) NOPASSWD: ALL<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="编写-gitlab-ci-yml"><a href="#编写-gitlab-ci-yml" class="headerlink" title="编写 gitlab-ci.yml"></a>编写 gitlab-ci.yml</h1><p>gitlab-ci.yml 编写的 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vZWUvY2kveWFtbC9SRUFETUUuaHRtbA==">具体文档<i class="fa fa-external-link-alt"></i></span></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> deploy
<span class="token key atrule">deploy_by_192</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">before_script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"command -v ssh-agent || ( sudo apt-get update -y &amp;&amp; sudo apt-get install openssh-client -y )"</span>
    <span class="token punctuation">-</span> eval $(ssh<span class="token punctuation">-</span>agent <span class="token punctuation">-</span>s)
    <span class="token punctuation">-</span> echo "$SSH_PRIVATE_KEY" <span class="token punctuation">|</span> tr <span class="token punctuation">-</span>d '\r' <span class="token punctuation">|</span> ssh<span class="token punctuation">-</span>add <span class="token punctuation">-</span>
    <span class="token punctuation">-</span> mkdir <span class="token punctuation">-</span>p ~/.ssh
    <span class="token punctuation">-</span> chmod 700 ~/.ssh
    <span class="token comment"># - '[[ -f /.dockerenv ]] &amp;&amp; echo -e "Host *\n\tStrictHostKeyChecking no\n\n" >> ~/.ssh/config'</span>
    <span class="token punctuation">-</span> ssh<span class="token punctuation">-</span>keyscan <span class="token punctuation">-</span>p "$SSH_KNOWN_HOSTS_PORT" "$SSH_KNOWN_HOSTS" <span class="token punctuation">></span><span class="token punctuation">></span> ~/.ssh/known_hosts
    <span class="token punctuation">-</span> chmod 644 ~/.ssh/known_hosts
    <span class="token punctuation">-</span> command <span class="token punctuation">-</span>v rsync <span class="token punctuation">|</span><span class="token punctuation">|</span> ( sudo apt<span class="token punctuation">-</span>get install rsync <span class="token punctuation">-</span>y )
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> rsync <span class="token punctuation">-</span>avze "ssh <span class="token punctuation">-</span>p $SSH_KNOWN_HOSTS_PORT" ./dist root@$SSH_KNOWN_HOSTS<span class="token punctuation">:</span>/home/
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> master
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> testci<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里如果是用的 docker executor, 可以将上面文件中的部分代码</p>
<pre class="line-numbers language-none"><code class="language-none">- ssh-keyscan -p &quot;$SSH_KNOWN_HOSTS_PORT&quot; &quot;$SSH_KNOWN_HOSTS&quot; &gt;&gt; ~&#x2F;.ssh&#x2F;known_hosts
- chmod 644 ~&#x2F;.ssh&#x2F;known_hosts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>替换为</p>
<pre class="line-numbers language-none"><code class="language-none">-&#39;[[ -f &#x2F;.dockerenv ]] &amp;&amp; echo -e &quot;Host *\n\tStrictHostKeyChecking no\n\n&quot; &gt;&gt; ~&#x2F;.ssh&#x2F;config&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="脚本解释"><a href="#脚本解释" class="headerlink" title="脚本解释"></a>脚本解释</h1><h2 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h2><p><code>eval $(ssh-agent -s)</code></p>
<p>解释如下：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ ssh-agent
SSH_AUTH_SOCK&#x3D;&#x2F;tmp&#x2F;ssh-GiORRAqMXEFt&#x2F;agent.28161; export SSH_AUTH_SOCK;
SSH_AGENT_PID&#x3D;28162; export SSH_AGENT_PID;
echo Agent pid 28162;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出结果中明确说明了导出了几个环境变量，<strong>上面的 ssh-agent 尽管运行成功了，但是那两个环境变量并没有导出。所以更多时候，会使用 eval 来执行 ssh-agent，使得这些环境变量也被导出。</strong><br>如下两种方式均可启动 ssh-gent。</p>
<p>方式一：创建子 shell，在子 shell 中运行 ssh-agent 进程，退出子 shell 自动结束代理。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ ssh-agent $SHELL<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>方式二：单独启动一个代理进程，退出当前 shell 时最好使用 <code>ssh-agent -k</code> 关闭对应代理</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ eval &#96;ssh-agent&#96;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>参数说明：<br>-s 生成 Bourne shell 风格的命令输出</strong></p>
<h2 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h2><p><code>echo &quot;$SSH_PRIVATE_KEY&quot; | tr -d &#39;\r&#39; | ssh-add -</code></p>
<p>解释如下：<br>删除私钥字符串的空格（针对 ed25519 的一个 bug），然后作为输入传给 ssh-add 添加到 ssh-agent 代理中<br><strong>参数说明：<br>“tr”:用于转换或删除文件中的字符。<br>“-d”:–delete 删除指令字符。<br>“-“:指令会从标准输入设备读取数据。</strong></p>
<h2 id="ssh-keyscan"><a href="#ssh-keyscan" class="headerlink" title="ssh-keyscan"></a>ssh-keyscan</h2><p><code>ssh-keyscan -p &quot;$SSH_KNOWN_HOSTS_PORT&quot; &quot;$SSH_KNOWN_HOSTS&quot; &gt;&gt; ~/.ssh/known_hosts</code></p>
<p>解释如下：<br>将远程机器的主机公钥 (host key，<strong>注意这里的主机公钥是针对主机来说的，不是前面提到的生成的公私密钥</strong>)添加到 runner 机器的 known_hosts 中，目录在<code>/home/gitlab-runner/.ssh/known_hosts</code>。<br>ssh-keyscan 的主要用途是用于批量获取机器的公钥，这样以后再用 ssh 登录到已经获取过公钥的服务器时，不需要再输入 yes 之类去保存公钥了。这里会一直往<code>~/.ssh/known_hosts</code>文件写入，后续如果已经有了相关机器公钥的话也可以跳过这步。<br><strong>参数说明：<br>“-p”，端口。</strong></p>
<h2 id="f-amp-amp-echo"><a href="#f-amp-amp-echo" class="headerlink" title="-f &amp;&amp; echo"></a>-f &amp;&amp; echo</h2><p><code>&#39;[[ -f /.dockerenv ]] &amp;&amp; echo -e &quot;Host *\n\tStrictHostKeyChecking no\n\n&quot; &gt;&gt; ~/.ssh/config&#39;</code></p>
<p>解释如下：<br>如果存在 <code>/.dockerenv</code> 且为常规文件，则添加以下字符串到<code>~/.ssh/config</code> 文件，实现当第一次连接服务器时，自动接受新的公钥，不必询问。<br>但这里会一直往<code>~/.ssh/config</code> 里面写数据，并不是覆盖原有的数据，方式不太好</p>
<pre class="line-numbers language-none"><code class="language-none">Host *
  StrictHostKeyChecking no<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如果服务器（系统重装，服务器间 IP 地址交换，DHCP，虚拟机重建，中间人劫持等），由于新连接服务器都需要进行公钥确认，可配置<code>StrictHostKeyChecking=no</code>绕过公钥检查<br>也可以用</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ ssh-keygen -l -f ~&#x2F;.ssh&#x2F;known_hosts
$ ssh-keygen -R 服务器端的ip地址<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>来删除旧的地址</p>
<p><strong>参数说明：<br>“[[]]”：这里相当于 test。<br>“-f”：如果 file 存在且是一个普通文件则为真。<br>“echo -e”：处理特殊字符，开启转义。</strong></p>
<p><strong>如果配置了 ssh 一次都没有登录过的话，第一次登录是需要绕过公钥检查，也可以用 <code>ssh -o stricthostkeychecking=no</code> 来绕过。<br>用命令 <code>cat /etc/issue</code> 可以查看 linux 版本</strong></p>
<p>执行之前最好到 gitlab 的 pipelines 用 CI Lint 验证下 gitlab-ci.yml 的格式是否正确，如果不正确是不触发 jobs 的。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510202407.png">当我们修改代码并提交之后，触发 CI/CD，到 gitlab 上该项目查看，jobs 执行成功 passed，到这里就大功告成。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510202637.png"></p>
<p>如果当前 runner 和需要部署的机器是一台的话可以直接用 cp 拷贝了。<br>可以用 <code>echo whoami</code> 和<code>echo pwd</code>查看当前用户和路径的。可以看到当前用户为 gitlab-runner，路径为<code>/home/gitlab-runner/builds/qmPHwZRG/0/userNameXXX/gitdirXXXX</code>，拷贝之前先执行</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ chown -R gitlab-runner:gitlab-runner .&#x2F;share<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>执行的时候前面添加 sudo，例如</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ sudo mkdir -p &#x2F;usr&#x2F;local&#x2F;share&#x2F;html
$ sudo cp -r .&#x2F;dist&#x2F; &#x2F;usr&#x2F;local&#x2F;share&#x2F;html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>就可以实现直接拷贝</p>
<p><strong>即执行 gitlab-ci.yml 是用户 gitlab-runner 在 runner 注册的服务器上执行的。如果要部署在 runner 服务器，就直接 cp 拷贝，如果要部署到其他服务器，就设置 ssh 无密码登录再 rsync 或者 scp 都可以</strong></p>
<h1 id="gitlab-pages"><a href="#gitlab-pages" class="headerlink" title="gitlab pages"></a>gitlab pages</h1><p>pages 是一个特殊的 job，gitlab pages 是 gitlab 的静态托管页面，只需要在 gitlab-ci.yml 里设置 pages 即可。以下两点是必须的：</p>
<ul>
<li><p>静态资源必须放到 public 文件夹下</p>
</li>
<li><p>artifacts 的路径必须为 public/</p>
</li>
</ul>
<p>在提交的时候会默认把 public 里面的文件部署到 pages 作为静态页面。见<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vZWUvY2kveWFtbC9SRUFETUUuaHRtbCNwYWdlcw==">文档<i class="fa fa-external-link-alt"></i></span>，注意这里不能照搬文档的<code>mv .public public</code>，这里会默认新建一个 public 的文件夹，如果使用<code>mv .public public</code>命令，在 public 文件夹已经存在的情况下，会把<code>.public</code>整改文件夹拷贝到了<code>public</code>文件夹，导致 404.可以使用<code>mv .public/* public</code>代替。<br>这里我们简单粗暴的直接删除 public 文件夹，再复制</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">pages</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> rm <span class="token punctuation">-</span>rf public/*
    <span class="token punctuation">-</span> mv dist/* public
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> public
  <span class="token key atrule">when</span><span class="token punctuation">:</span> manual
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> master
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> testci<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里设置了手动触发。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210511190813.png"></p>
<p><u><strong>特别需要注意的一点是顶层的 stages 名称，必须是 pages</strong></u>，不然 gitlab 的 pages 部署不会显示 pages 的地址。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210511190844.png"></p>
<p>部署好了之后在 gitlab 中的 <code>Settings =&gt; Pages</code> 就可以看到部署的地址了，如果需要设置所有人可见的话，在单个项目的设置<code>Settings =&gt; General =&gt; Visibility, project features, permissions =&gt; Pages</code>。设置为<code>Everyone</code></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510201104.png" alt="生成的部署地址"></p>
]]></content>
      <categories>
        <category>开发</category>
        <category>Devops</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>gitlab</tag>
        <tag>gitlab-ci</tag>
        <tag>gitlab-pages</tag>
        <tag>ssh</tag>
      </tags>
  </entry>
  <entry>
    <title>git push 报错解决</title>
    <url>/Bug%E8%A7%A3%E5%86%B3/Git/git-push-%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3/</url>
    <content><![CDATA[<p>记一次 <code>git push</code> 的报错解决。</p>
<span id="more"></span>

<h1 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h1><p>用 hexo 写博客提交的时候报错了 fatal: TaskCanceledException encountered.，有时候是这个 fatal: HttpRequestException encountered.<br>使用网上的方式均不管用，下载了<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL01pY3Jvc29mdC9HaXQtQ3JlZGVudGlhbC1NYW5hZ2VyLWZvci1XaW5kb3dzL3JlbGVhc2Vz">凭证管理<i class="fa fa-external-link-alt"></i></span>安装完成，也下载了新版本的 git 并更新。用以下命令行的方式也试过。</p>
<p>配置 credential.helper 为 manager。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ git config --global credential.helper manager<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>试过了，不行。</p>
<p>删除系统级别的 credential.helper。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ git config --system --unset credential.helper<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>也不行。</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>git 的配置指令有 3 个层级，详细信息可参考 <span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS8=">git-scm.com<i class="fa fa-external-link-alt"></i></span> 的 <span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS9kb2NzL2dpdC1jb25maWc=">git-config<i class="fa fa-external-link-alt"></i></span>。<br>分别是</p>
<ul>
<li>system（系统级别）</li>
<li>global（用户级别）</li>
<li>local（仓库级别）</li>
</ul>
<p>优先级为 local &gt; global &gt; system。local 位置在项目的<code>.git/config</code>，global 位置在每个用户的<code>~/.gitconfig</code>，system 位置在 git 安装目录的<code>etc/gitconfig</code>。我们可以直接修改文件，或者用命令行的方式修改。详细查看<span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS9ib29rL3poL3YyLyVFOCU4NyVBQSVFNSVBRSU5QSVFNCVCOSU4OS1HaXQtJUU5JTg1JThEJUU3JUJEJUFFLUdpdA==">自定义 Git - 配置 Git<i class="fa fa-external-link-alt"></i></span></p>
<p>读取配置命令分别为：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ git config --local --list
$ git config --global --list
$ git config --system --list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>查找<span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS9ib29rL3poL3YyL0dpdC0lRTUlQjclQTUlRTUlODUlQjctJUU1JTg3JUFEJUU4JUFGJTgxJUU1JUFEJTk4JUU1JTgyJUE4">Git 的系统凭证管理<i class="fa fa-external-link-alt"></i></span>，credential.helper 可选的存储方式为:</p>
<h2 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h2><p>将凭证存放在内存中一段时间。 密码永远不会被存储在磁盘中，并且在 15 分钟后从内存中清除。</p>
<h2 id="store"><a href="#store" class="headerlink" title="store"></a>store</h2><p>将凭证用明文的形式存放在磁盘中，并且永不过期。 这意味着除非你修改了你在 Git 服务器上的密码，否则你永远不需要再次输入你的凭证信息。 这种方式的缺点是你的密码是用明文的方式存放在你的 home 目录下。</p>
<h2 id="osxkeychain"><a href="#osxkeychain" class="headerlink" title="osxkeychain"></a>osxkeychain</h2><p>如果你使用的是 Mac，Git 还有一种 “osxkeychain” 模式，它会将凭证缓存到你系统用户的钥匙串中。 这种方式将凭证存放在磁盘中，并且永不过期，但是是被加密的，这种加密方式与存放 HTTPS 凭证以及 Safari 的自动填写是相同的。</p>
<h2 id="manager"><a href="#manager" class="headerlink" title="manager"></a>manager</h2><p>如果你使用的是 Windows，你可以安装一个叫做 “Git Credential Manager for Windows” 的辅助工具。 这和上面说的 <code>osxkeychain</code>十分类似，但是是使用 <code>Windows Credential Store</code> 来控制敏感信息。 可以在<code>https://github.com/Microsoft/Git-Credential-Manager-for-Windows</code> 下载。</p>
<p>git 在本地有多种方式来存储本地凭证。存储方式有三种：manager、wincred 和 store，可以在 git 安装目录的<code>mingw64/libexec/git-core</code> 路径下找到对应的 exe 文件：<code>git-credential-manager</code>、<code>git-credential-store</code> 和 <code>git-credential-wincred</code>。wincred 是 Windows 默认的凭证存储模式，其中 manager 模式也是采用的 store 的方式来存储。</p>
<p>其中用 manager 会把用户信息加密，wincred 则不会。</p>
<p>这里可以先把原有的 credential.helper 删除</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ git config --local --unset credential.helper
$ git config --global --unset credential.helper
$ git config --system --unset credential.helper<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后再配置 credential.helper 为 manager</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ git config --global credential.helper manager<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看是否配置成功</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ git config --global --list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>问题解决。</p>
]]></content>
      <categories>
        <category>Bug解决</category>
        <category>Git</category>
      </categories>
      <tags>
        <tag>git</tag>
        <tag>credential</tag>
      </tags>
  </entry>
  <entry>
    <title>docker+gitlab+jenkins+ssh实现代码自动构建部署</title>
    <url>/%E5%BC%80%E5%8F%91/Devops/docker-gitlab-jenkins-ssh%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h1 id="安装-gitlab"><a href="#安装-gitlab" class="headerlink" title="安装 gitlab"></a>安装 gitlab</h1><p>这里我是 docker 安装的，由于电脑板载内存只有 8g，就没装 gitlab 的 docker 镜像 gitlab/gitlab-ce，换了一个汉化的社区版，都可以实现自动构建部署。<br>首先，docker 安装 gitlab，这里 gitlab 端口映射为 10080</p>
<span id="more"></span>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d -p 10080:80 --name gitlab twang2218&#x2F;gitlab-ce-zh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512091947.png"></p>
<p>如果是本机 windows 想要尝试社区镜像的，可以使用下面的代码，正式部的<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vb21uaWJ1cy9kb2NrZXIvI2luc3RhbGwtZ2l0bGFiLXVzaW5nLWRvY2tlci1lbmdpbmU=">不支持 windows 的 docker<i class="fa fa-external-link-alt"></i></span>，<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vb21uaWJ1cy9kb2NrZXIvI2luc3RhbGwtZ2l0bGFiLXVzaW5nLWRvY2tlci1lbmdpbmU=">官网 docker 安装文档<i class="fa fa-external-link-alt"></i></span></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker volume create gitlab-logs
$ docker volume create gitlab-data
$ docker run -d -p 10443:443 -p 10080:80 -p 10822:22 --name gitlab -v d:&#x2F;docker&#x2F;gitlab&#x2F;config:&#x2F;etc&#x2F;gitlab -v gitlab-logs:&#x2F;var&#x2F;log&#x2F;gitlab -v gitlab-data:&#x2F;var&#x2F;opt&#x2F;gitlab gitlab&#x2F;gitlab-ce<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果是 linux 的话要尝试社区镜像网上就很多了。</p>
<h1 id="配置-gitlab"><a href="#配置-gitlab" class="headerlink" title="配置 gitlab"></a>配置 gitlab</h1><h2 id="配置允许内网访问"><a href="#配置允许内网访问" class="headerlink" title="配置允许内网访问"></a>配置允许内网访问</h2><p>需要注意 <strong>gitlab 的 webhook 配置的钩子地址是不允许内网的，比如 192.168、172.16 或者 10 开头的，这时候需要用 gitlab 的管理员账号（root）登录去修改允许 webhook 的本地请求</strong>。</p>
<p>这里就涉及到管理员账号的密码，网上很多参考说是系统默认的用户名：<code>root</code>，密码：<code>5iveL!fe</code>，试过了没有用，就只能自己去修改。修改密码这里可以参考官方<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vZWUvc2VjdXJpdHkvcmVzZXRfdXNlcl9wYXNzd29yZC5odG1sI3Jlc2V0LXlvdXItcm9vdC1wYXNzd29yZA==">reset-your-root-password<i class="fa fa-external-link-alt"></i></span></p>
<ul>
<li><p>如果是官方社区版 gitlab/gitlab-ce</p>
<p>进入控制台</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker exec -it gitlab bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vZWUvYWRtaW5pc3RyYXRpb24vb3BlcmF0aW9ucy9yYWlsc19jb25zb2xlLmh0bWwjc3RhcnRpbmctYS1yYWlscy1jb25zb2xlLXNlc3Npb24=">进入 Rails console<i class="fa fa-external-link-alt"></i></span></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ gitlab-rails console -e production<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>修改密码代码如下：</p>
<pre class="line-numbers language-none"><code class="language-none">user &#x3D; User.find(1)或者user &#x3D; User.find_by(email: &#39;admin@example.com&#39;)
user.password &#x3D; 12345678
user.password_confirmation &#x3D; 12345678
user.save!<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>如果是汉化版</p>
<p>可以直接设置 root 密码。这里我们修改为 12345678</p>
</li>
</ul>
<p>用 root 账号登录之后左上角有一个小扳手的图标。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512095712.png"></p>
<p><code>Admin area =&gt; Settings =&gt; Network</code>勾选允许本地网络的请求即可。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512100032.png"></p>
<h2 id="配置-gitlab-的-ip-port"><a href="#配置-gitlab-的-ip-port" class="headerlink" title="配置 gitlab 的 ip+port"></a>配置 gitlab 的 ip+port</h2><p>我们新建项目发现 clone 的地址目前是显示为一串字母。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512100759.png"></p>
<p>这里我们需要设置 gitlab 的 ip 和 port。</p>
<p>进入控制台</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker exec -it gitlab bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>编辑配置文档</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ vi &#x2F;opt&#x2F;gitlab&#x2F;embedded&#x2F;service&#x2F;gitlab-rails&#x2F;config&#x2F;gitlab.yml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里我们修改为 localhost，端口修改为 10080，如果需要修改 ssh 端口，修改<code>/etc/gitlab/gitlab.rb</code>中的<code>gitlab_rails[&#39;gitlab_shell_ssh_port&#39;]= 10022</code>即可</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">## GitLab settings</span>
<span class="token key atrule">gitlab</span><span class="token punctuation">:</span>
  <span class="token comment">## Web server settings (note: host is the FQDN, do not include http://)</span>
  <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10080</span>
  <span class="token key atrule">https</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmdpdGxhYi5jb20vZWUvYWRtaW5pc3RyYXRpb24vcmVzdGFydF9naXRsYWIuaHRtbCNvbW5pYnVzLWdpdGxhYi1yZXN0YXJ0">重启 gitlab<i class="fa fa-external-link-alt"></i></span></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ gitlab-ctl restart<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>可以看到地址已经变了</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512102211.png"></p>
<p>同样，我们在<code>设置=&gt;SSH密钥</code>配置好之后可以看到拉取成功</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512102320.png"></p>
<h1 id="安装-jenkins"><a href="#安装-jenkins" class="headerlink" title="安装 jenkins"></a>安装 jenkins</h1><p>安装 jenkins 就简便许多，端口映射到 18080，这里 jenkins 的配置文件后面都在<code>/var/jenkins_home/</code>这个文件夹下，我们这里映射到我们 window 的<code>d:/docker/jenkins</code>文件夹。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d -p 18080:8080 -p 50000:50000 --name jenkins -v d:&#x2F;docker&#x2F;jenkins:&#x2F;var&#x2F;jenkins_home jenkins&#x2F;jenkins:lts<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>打开<code>http://localhost:18080</code>能看到已经安装成功</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512103553.png"></p>
<h2 id="初始密码"><a href="#初始密码" class="headerlink" title="初始密码"></a>初始密码</h2><p>打开网页，管理员账户为 admin，需要输入首次的密码，可以在<code>/var/jenkins_home/secrets/initialAdminPassword</code>找到。如果映射到本地文件，可以相应的在本地文件夹下查找。进入之后可以选择配置插件，也可以跳过后面再来配置。这里选择的跳过。<br><strong>如果退出之后不知道管理员的密码</strong>，还可以打开<code>/var/jenkins_home/users/adminXXX</code>里面的 config.xml，找到 passwordHash，设置为<code>#jbcrypt:$2a$10$MiIVR0rr/UhQBqT.bBq0QehTiQVqgNpUGyWW2nJObaVAM/2xSQdSq</code><br>这个是编码过后的 123456，这样你的管理员账号就设置为了 123456.</p>
<h2 id="安装-jenkins-插件"><a href="#安装-jenkins-插件" class="headerlink" title="安装 jenkins 插件"></a>安装 jenkins 插件</h2><p>进入 jenkins 之后，点击左侧<code>Manage Jenkins =&gt; Manage Plugins</code></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512104536.png"></p>
<p>安装插件这里由于官方的仓库比较慢而且经常失败，这里可以换其他源，这里可以选择清华大学的<code> https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/2.60/update-center.json</code>，选择<code>Advanced</code>，填入清华的源</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512104816.png"></p>
<p>这里有个坑是清华是把这个文件镜像过来了，但是没有把里面的插件升级地址改成清华，所以下载还是有问题，这里解决方式有两种</p>
<h3 id="nginx-代理"><a href="#nginx-代理" class="headerlink" title="nginx 代理"></a>nginx 代理</h3><p>将所有<code>https://updates.jenkins.io/download</code>代理到<code>https://mirrors.tuna.tsinghua.edu.cn/jenkins</code> 。</p>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>打开<code>/var/jenkins_home/updates/default.json</code>，将所有的<code>https://updates.jenkins.io/download</code>批量修改为<code>https://mirrors.tuna.tsinghua.edu.cn/jenkins</code>，一劳永逸。</p>
<p>这里添加几个常用的插件<strong>Maven Integration</strong>、<strong>GitLab</strong>、<strong>GitLab Hook</strong>、<strong>Publish Over SSH</strong></p>
<h1 id="配置-jenkins"><a href="#配置-jenkins" class="headerlink" title="配置 jenkins"></a>配置 jenkins</h1><h2 id="配置凭据"><a href="#配置凭据" class="headerlink" title="配置凭据"></a>配置凭据</h2><h3 id="gitlab-的-accessToken"><a href="#gitlab-的-accessToken" class="headerlink" title="gitlab 的 accessToken"></a>gitlab 的 accessToken</h3><p>首先登录 gitlab<code>用户 =&gt; 设置 =&gt; accessToken</code>，填写名称和过期时间，勾选 api，点击生成 accessToken，这里要记录下 token，如果刷新了 token 就没了。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512105206.png"></p>
<p>登录到 jenkins，<code>Manage Jenkins =&gt; Manage Credentials</code>。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512105327.png"></p>
<p>点击全局凭证</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512105825.png"></p>
<p><code>Add Credentials</code>选择<code>Gitlab API token</code>，填写 accessToken。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512110010.png"></p>
<h3 id="gitlab-的登录账号和密码"><a href="#gitlab-的登录账号和密码" class="headerlink" title="gitlab 的登录账号和密码"></a>gitlab 的登录账号和密码</h3><p>还是在全局凭证，点击添加凭证，类型选择<code>Username with password</code>，填写用户拉取代码的 gitlab 账号和用户名</p>
<h2 id="配置-gitlab-的连接地址"><a href="#配置-gitlab-的连接地址" class="headerlink" title="配置 gitlab 的连接地址"></a>配置 gitlab 的连接地址</h2><p>点击<code>Manage Jenkins =&gt; Configure System</code></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512110229.png"></p>
<p>找到 gitlab 配置（前面我们已经添加了相应的插件），填写你的 gitlab 名称 <code>Connection name</code>，gitlab 地址，我这里是<code>http://192.168.7.104:10080</code>，<strong>注意这里必须填写内网地址，不能填写 localhost 或者 127.0.0.1</strong>，名称为”jenkins_for_gitlab”，凭证选择刚才新建的第一个凭证<code>Gitlab API token</code>，添加完成之后点击<code>Test Connection</code>测试，如果配置正确提示 Success。点击保存</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512111745.png"></p>
<h2 id="配置-ssh-部署的地址"><a href="#配置-ssh-部署的地址" class="headerlink" title="配置 ssh 部署的地址"></a>配置 ssh 部署的地址</h2><p>还是在<code>Manage Jenkins =&gt; Configure System</code>中，找到 ssh 配置（前面我们已经添加了相应的插件） <code>Publish over SSH</code>，<code>SSH Servers</code> 填写 ssh 的地址，账号，以及远程位置，这里可以直接设置为想要部署的位置，我这里设置为根目录<code>/</code>。<br>高级里面填写端口、密码，之后测试<code>Test Configuration</code>，之后 save 保存。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512112010.png"></p>
<h2 id="配置全局-jdk-和-maven"><a href="#配置全局-jdk-和-maven" class="headerlink" title="配置全局 jdk 和 maven"></a>配置全局 jdk 和 maven</h2><p>这一步需要在安装 jenkins 的机器上面安装 jdk 和 maven。一般安装 jenkins 的时候已经安装了 jdk，这里还需要安装 maven。</p>
<p>进入 bash 环境的时候可以<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vZW5naW5lL3JlZmVyZW5jZS9jb21tYW5kbGluZS9leGVjLyNvcHRpb25z">指定账号<i class="fa fa-external-link-alt"></i></span>，这里我们需要以 root 登录，才能修改编辑环境变量。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker exec -it -u 0 jenkins bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里-u 可以指定 username 或者 uid，也可以写成</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker exec -it -u root jenkins bash<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里下载了压缩包到<code>/usr/local/</code>下面然后 unzip 解压，文件夹名为 apache-maven-3.6.3。<br>需要修改环境变量，先下载一个 vim。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ apt-get update -y
$ apt-get install vim -y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这里我 jdk 的文件名为 openjdk-8。maven 和 jdk 都放在了<code>/usr/local</code> 下面。安装完成后编辑环境变量</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ vi &#x2F;etc&#x2F;profile<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在文件末尾添加</p>
<pre class="line-numbers language-properties" data-language="properties"><code class="language-properties"><span class="token attr-name">MAVEN_HOME</span><span class="token punctuation">=</span><span class="token attr-value">/usr/local/apache-maven-3.6.3</span>
<span class="token attr-name">JAVA_HOME</span><span class="token punctuation">=</span><span class="token attr-value">/usr/local/openjdk-8</span>
<span class="token attr-name">CLASS_PATH</span><span class="token punctuation">=</span><span class="token attr-value">$JAVA_HOME/lib/</span>
<span class="token attr-name">PATH</span><span class="token punctuation">=</span><span class="token attr-value">$PATH:$MAVEN_HOME/bin:$JAVA_HOME/bin</span>
<span class="token attr-name">export</span> <span class="token attr-value">PATH MAVEN_HOME JAVA_HOME CLASS_PATH</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512113214.png"></p>
<p>配置完成之后输入</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ source &#x2F;etc&#x2F;profile<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>使配置文件生效。到这里可以测试下安装是否成功</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ mvn -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ java -version<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512114041.png"></p>
<p>点击<code>Manage Jenkins =&gt; Global Tool Configuration</code>。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512114208.png">选择 <code>JDK installations</code>，填写 jdk 名称和路径<code>/usr/local/openjdk-8</code>。<br>选择 Maven installations，填写 maven 的名称和路径<code>/usr/local/apache-maven-3.6.3</code>，然后 save 保存。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512114333.png"></p>
<h2 id="创建部署项目"><a href="#创建部署项目" class="headerlink" title="创建部署项目"></a>创建部署项目</h2><h3 id="前端部署"><a href="#前端部署" class="headerlink" title="前端部署"></a>前端部署</h3><p>到 jenkins 主界面，左侧导航栏选择 <code>New Item</code>,填写名称，选择 <code>Freestyle project</code>，在配置 <code>configure</code> 里面，</p>
<ul>
<li><p><code>General</code>—在 <code>Gitlab Connection</code> 选择在配置里面设置的 gitlab 的连接”jenkins for gitlab”。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512114740.png"></p>
</li>
<li><p><code>Source Code Management</code>—选择 git，仓库地址填写需要部署的项目的仓库地址，凭证选择建立好的 gitlab 的登录账号密码，分支这里测试是直接选的 master 分支，</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512114829.png"></p>
</li>
<li><p><code>Build Triggers</code>—勾选<code>Build when a change is pushed to GitLab. GitLab webhook URL: http://192.168.7.104:18080/project/testDist</code>，这里需要记录下这个 webhook 地址，填写到 gitlab 的时候需要。<br>点击高级选项，点击 Generate 生成 <code>Secret token</code>，这里我们记录下这个 token</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512115051.png"></p>
</li>
<li><p><code>Build Environment</code>—这里可以配置在 build 之前或者 build 之后的操作，比如我们需要 build 之后将生成的<code>/dist</code> 文件夹通过 SSH 部署到远程服务器。<br><code>SSH Server</code> 选择配置的地址.<br><code>Source files</code> 填写<code>dist/</code>即为 dist 下面所有文件.<br><code>Remote directory</code> 填写<code>home/</code><br>意思是将 jenkins 下面 workspace 的文件拷贝到远程服务器的 home 文件夹下，其中 <code>Exec command</code> 还可以填写需要在远程服务器执行的操作，比如 tomcat 的关闭与启动等等。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512115225.png"></p>
</li>
</ul>
<h3 id="后端-jar-包部署"><a href="#后端-jar-包部署" class="headerlink" title="后端 jar 包部署"></a>后端 jar 包部署</h3><p>jar 包部署与前端部署一样，在 <code>Build Environment</code> 中 <code>Source files</code> 填写<code>target/*.jar</code>。<br><code>Remove prefix</code> 删除前缀这里填写<code>target</code>。<br><code>Remote directory</code> 填写需要部署打的 jar 包位置。<br>这里 build 可以设置打包命令为<code>mvn clear package</code>。<br><code>nohup java -jar XXXX.jar &amp;</code>启动 jar 包，也可以写一些执行脚本在服务器上运行。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512140050.png"></p>
<h1 id="自动触发构建部署"><a href="#自动触发构建部署" class="headerlink" title="自动触发构建部署"></a>自动触发构建部署</h1><h2 id="配置-webhook"><a href="#配置-webhook" class="headerlink" title="配置 webhook"></a>配置 webhook</h2><p>进入 gitlab 选择需要部署的项目，<code>设置 =&gt; 集成</code>里面填写 webhook，链接填写为 jenkins 里面生成的链接，如<code>http://192.168.7.104:18080/project/testDist</code>，安全令牌填写前面 jenkins 的<code>Build Triggers</code>生成的 token。<br>选择 push 触发，分支选择 master，这样 master 分支提交 push 的时候就会触发这个 webhook，保存之后可以 test 测试<code>Push events</code>，如果成功则提示<code> Hook executed successfully: HTTP 200</code>，如果提示<code> Requests to localhost are not allowed</code>，就需要登录管理员账号开启内网请求权限，参照文章第一点<a href="#%E5%AE%89%E8%A3%85-gitlab">安装-gitlab</a></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512141909.png"></p>
<h2 id="查看任务的-log"><a href="#查看任务的-log" class="headerlink" title="查看任务的 log"></a>查看任务的 log</h2><p>配置好 webhook 之后，我们提交一下代码，看下触发钩子的任务 log，进入项目，点击左侧<code>Build History</code></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512142600.png"></p>
<p>进入任务，左侧导航<code>Console Output</code>可查询 jenkins 日志。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512142746.png"></p>
<p><strong>build 生成的文件可在 <code>/var/jenkins_home/workspace</code> 下面查看</strong></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512144015.png"></p>
<p>同样的，maven 构建的项目，我们也能看到 log，maven 项目耗时比较久</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512154419.png"></p>
<h2 id="查看服务器文件"><a href="#查看服务器文件" class="headerlink" title="查看服务器文件"></a>查看服务器文件</h2><p>登录我们配置的部署地址 192.168.7.234，根据我们前面的配置，能看到/home 路径下已经有 dist 文件夹和相应的 jar 包了</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210512154532.png"></p>
]]></content>
      <categories>
        <category>开发</category>
        <category>Devops</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>gitlab</tag>
        <tag>ssh</tag>
        <tag>devops</tag>
        <tag>jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>github图片加载失败问题解决</title>
    <url>/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/github%E5%9B%BE%E7%89%87%E5%8A%A0%E8%BD%BD%E5%A4%B1%E8%B4%A5%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/</url>
    <content><![CDATA[<p>最近 github 上图片一直加载失败，以前是用的 Chrome 插件 Ghelper，最近 Ghelper 开启之后 github 无法访问，这里用了另外一种解决方法。</p>
<span id="more"></span>

<h1 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h1><p>github 上面图片加载有问题。</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>这里我们设置域名指定 ip，以 Windwos 系统为例，文件位置在<code>C:\Windows\System32\drivers\etc</code>，打开之后添加以下代码</p>
<pre class="line-numbers language-none"><code class="language-none"># GitHub Start
192.30.255.112	gist.github.com
192.30.255.112	github.com
192.30.255.112	www.github.com
151.101.56.133	avatars0.githubusercontent.com
151.101.56.133	avatars1.githubusercontent.com
151.101.56.133	avatars2.githubusercontent.com
151.101.56.133	avatars3.githubusercontent.com
151.101.56.133	avatars4.githubusercontent.com
151.101.56.133	avatars5.githubusercontent.com
151.101.56.133	avatars6.githubusercontent.com
151.101.56.133	avatars7.githubusercontent.com
151.101.56.133	avatars8.githubusercontent.com
151.101.56.133	camo.githubusercontent.com
151.101.56.133	cloud.githubusercontent.com
151.101.56.133	gist.githubusercontent.com
151.101.56.133	marketplace-screenshots.githubusercontent.com
151.101.56.133	raw.githubusercontent.com
151.101.56.133	repository-images.githubusercontent.com
151.101.56.133	user-images.githubusercontent.com
# GitHub End<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>再去打开 github，图片加载成功。</p>
]]></content>
      <categories>
        <category>工作笔记</category>
      </categories>
      <tags>
        <tag>github</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo+github-pages搭建个人博客</title>
    <url>/%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/hexo-github-pages%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<p>近日使用 hexo 搭建了个人的博客，搭建好之后写一篇文章记录下过程。<br>hexo 是可以直接生成静态文件，拿静态页面部署，用 github 部署不需要备案，比较方便，唯一的缺点就是访问有点慢。</p>
<span id="more"></span>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>需要先安装好 nodejs、git，注册登录 github，熟悉一些 markdown 语法等暂且不表。</p>
<h1 id="github-新建仓库"><a href="#github-新建仓库" class="headerlink" title="github 新建仓库"></a>github 新建仓库</h1><p>github 上新建一个仓库，名字为 <code>username.git.io</code>，仓库需要配置为 public。这里的 username 就是你 github 的名字，比如 github 用户名是 FreedomAnt，仓库就取名为 <code>freedomant.github.io</code>。<br>这样写的原因是 github-pages 能自动将该仓库用为 github-pages 的域名所在仓库，即后面不用跟项目名了。<br>进入该仓库，进入设置页面<code>Settings =&gt; Options</code>里面有一个<code>GitHub Pages</code>配置，如图所示:<img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20201105171032.png" alt="github pages 设置截图"><br>这里可以设置分支，默认 github 是会新建一个 gh-pages 的分支。</p>
<h1 id="安装-Hexo"><a href="#安装-Hexo" class="headerlink" title="安装 Hexo"></a>安装 Hexo</h1><p><span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlvL3poLWNuL2RvY3Mv">Hexo 文档<i class="fa fa-external-link-alt"></i></span>，这里使用的全局安装</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ npm install -g hexo-cli<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>新建一个项目，项目名就叫 blog。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ hexo init blog<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>有几个快捷键比较常用</p>
<ol>
<li><code>hexo clean</code>清空生成的静态文件和缓存。</li>
<li><code>hexo s</code>是<code>hexo server</code>的缩写，启动一个默认 4000 端口的本地服务。</li>
<li><code>hexo n [name]</code>是<code>hexo new [name]</code>的缩写，新建一篇文章</li>
<li><code>hexo g</code>是<code>hexo generate</code>的缩写，生成静态文件。</li>
<li><code>hexo d</code>是<code>hexo deploy</code>的缩写，部署到配置的仓库或者服务器。</li>
</ol>
<p>生成静态文件和部署可以用一条命令表示<code>hexo g -d</code>或者<code>hexo d -g</code>。<br>安装完成之后有几个主要的文件和目录，配置文件<code>_config.yml</code>，<code>source</code>文件夹是放文章和样式图片等。<code>themes</code>是用于放主题文件。</p>
<h1 id="Hexo-配置"><a href="#Hexo-配置" class="headerlink" title="Hexo 配置"></a>Hexo 配置</h1><p>安装完成之后在<code>_config.yml</code>配置。<br><code>theme: next</code>这里配置主题的名字，主题放 themes 文件夹下。这里配置的是 <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25leHQtdGhlbWUvaGV4by10aGVtZS1uZXh0">next 主题<i class="fa fa-external-link-alt"></i></span>。具体<span class="exturl" data-url="aHR0cHM6Ly90aGVtZS1uZXh0LmpzLm9yZy9kb2NzL2dldHRpbmctc3RhcnRlZC9jb25maWd1cmF0aW9uLmh0bWw=">配置<i class="fa fa-external-link-alt"></i></span><br>这里采用 git 方式部署博客，先安装一个 hexo-deployer-git。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ npm install hexo-deployer-git --save<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>安装完成之后在<code>_config.yml</code>里配置部署的服务。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">deploy</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> git
  <span class="token key atrule">repo</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/FreedomAnt/freedomant.github.io.git
  <span class="token key atrule">branch</span><span class="token punctuation">:</span> gh<span class="token punctuation">-</span>pages<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里分支选择 gh-pages，就是<a href="#github-%E6%96%B0%E5%BB%BA%E4%BB%93%E5%BA%93">github 新建仓库</a>里的生成分支。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ hexo n 文章名称<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里写完文章以后依次输入以下命令：</p>
<p>清空缓存</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ hexo clean<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>本地先跑一个服务看下效果</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ hexo s<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>生成静态文件并部署</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ hexo g -d<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这样就生成了博客，在浏览器输入地址即可访问<code>https://freedomant.github.io</code>，如果你买了域名可以添加到 source 下面的 CNAME 文件。如果需要修改主题的配置文件，可以在项目根目录下面新建一个<code>_config.[theme name].yml</code>，将<code>themes/next/_config.yml</code>里面的内容复制到这个文件，修改主题就在这个文件修改就行。这里用的 next 主题<code>_config.next.yml</code>。这个文件里面的内容在静态页面生成的时候会覆盖掉<code>themes/next/_config.yml</code>的内容。</p>
<h1 id="图床"><a href="#图床" class="headerlink" title="图床"></a>图床</h1><p>图床这里也是白 piao 的 github，先在 github 里面新建一个项目用于图床。token 生成方式在 github 里面，点击右上角头像<code>Settings =&gt; Developers Settings =&gt; Personal access tokens =&gt; Generate new token</code>这里注意勾选 repo 下的选项。如图所示：<br><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20201105175136.png" alt="github 配置图床Token"><br>然后下载 PicGo，PicGo 是一个用于快速上传图片并获取图片 URL 链接的工具，支持很多图床，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL01vbHVuZXJmaW5uL1BpY0dvL3JlbGVhc2Vz">下载地址<i class="fa fa-external-link-alt"></i></span>，下载安装之后点击图床设置，选择 GitHub 图床，配置如下：<br><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20201105174115.png" alt="PicGGo中GitHub图床配置"><br>这里的自定义域名有讲究的，填写<code>https://cdn.jsdelivr.net/gh/FreedomAnt/image@main</code>，用 jsdelivr 的黑科技完成 CDN 加速。</p>
<h1 id="写文章"><a href="#写文章" class="headerlink" title="写文章"></a>写文章</h1><p>这里我使用的 vscode 写的文章，vscode 安装插件<code>Markdown All in One</code>、<code>Markdwon Preview Enhanced</code>等。也安装有 typora 软件，typora 是一个所见即所得(WYSIWYG)的 markdown 软件，非常不错。而且 typora 集成 PicGo，typora 的<code>文件 =&gt; 偏好设置 =&gt; 图像 =&gt; 上传服务设定</code>里面选择 PicGo(app)的方式，PicGo-Core 的命令行的方式不是太方便。集成之后可以在 typora 里面直接上传图片。<br><strong>这里需要注意 PicGo 默认的服务端口开的是 36677，在 PicGo 里<code>PicGo设置 =&gt; 设置Server</code>可设置监听端口，如果想要配置 typora 里面的 PicGo，需要注意测试 PicGo 连接的服务地址端口是不是 36677。</strong></p>
<h1 id="评论插件"><a href="#评论插件" class="headerlink" title="评论插件"></a>评论插件</h1><p>next 主题自带的评论插件里面有<code>changyan | disqus | disqusjs | gitalk | livere | valine</code>，这里我选择的 gitalk，对比了几个之后还是选择了 github 的黑科技。valine 也不错，不过我看到 github 上面写 src 目录停止更新的信息，就还是选择了 gitalk。<br>gitalk 配置需要客户端的 id 和密钥。还是在 github 里面生成。<br>进入 github，点击右上角头像<code>Settings =&gt; Developers Settings =&gt; OAuth Apps =&gt; new OAuth Apps</code>。<code>Homepage URL</code>和<code>Authorization callback URL</code>都填写<code>https://freedomant.github.io/</code>，生成的客户端 id 和密钥填到主题配置里面。</p>
<h1 id="部署到-Vercel"><a href="#部署到-Vercel" class="headerlink" title="部署到 Vercel"></a>部署到 Vercel</h1><p>Vercel 是一个提供使用简单命令就可部署静态页面的服务，由于 github 访问速度慢的原因，在使用测速软件分别测试了很多常见的静态网页部署服务之后，发现比较快的就是国内的 coding 和 gitee，再就是腾讯阿里的对象存储了，Vercel 算是国外里面比较快的了，而且和 github 无缝对接。如果不想花钱买 CDN 加速或者对象存储，可以使用 Vercel，Vercel 以前叫 zeit，安装了之后直接使用一行<code>now XXXX</code>命令就可完成部署。目前已经更名为 Vercel。用 github 关联登录之后，点击<code>Import Preject =&gt; Import Git Repository =&gt; continue</code>填写你的仓库地址<code>https://github.com/FreedomAnt/freedomant.github.io.git</code>。部署命令那不用填写，默认就行。部署好之后就会生成访问的地址了。<br>Vercel 还支持修改默认的分支，进入到关联的项目，点击<code>Settings =&gt; Git =&gt; Production Branch</code>可以修改成博客所在的 gh-pages 分支。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510195450.png"></p>
<p>Vercel 还支持自定义域名，点击<code>Settings =&gt; Domains</code>一般域名后缀填写 XXX.vercel.app。vercel.app 为默认生成后缀。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510195639.png"></p>
<p>至此，部署到 Vercel 成功。<br>当调用命令<code>hexo g -d</code>部署到 github 时，会触发 Vercel 的部署，一键部署到两个地方，完美！</p>
<p><strong>注意：博客原文件和静态页面的分开放两个仓库，博客原文件可以用私有仓库，里面有一些个人配置的信息</strong></p>
]]></content>
      <categories>
        <category>搭建教程</category>
      </categories>
      <tags>
        <tag>github</tag>
        <tag>hexo</tag>
        <tag>github-pages</tag>
        <tag>gitalk</tag>
        <tag>zeit</tag>
        <tag>vercel</tag>
        <tag>markdown</tag>
        <tag>typora</tag>
        <tag>picgo</tag>
        <tag>图床</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx反向代理图片报错解决</title>
    <url>/Bug%E8%A7%A3%E5%86%B3/Nginx/nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%9B%BE%E7%89%87%E6%8A%A5%E9%94%99%E8%A7%A3%E5%86%B3/</url>
    <content><![CDATA[<p>记一次 Nginx 反向代理的报错解决。</p>
<span id="more"></span>

<h1 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h1><p>最近项目为了统一域名，将图片服务器和接口服务器用 Nginx 做了转发处理。</p>
<p>业务场景为：</p>
<ul>
<li>接口：<code>https://testdns/interface/xxx</code>转到<code>http://192.168.1.1:10011/xxx</code></li>
<li>图片：<code>https://testdns/image/xxx.png</code>转到<code>http://192.168.1.2:9000/xxx.png</code></li>
</ul>
<p>Nginx 的反向代理配置为：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span>interface <span class="token punctuation">&#123;</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">10011</span><span class="token operator">/</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>Proto <span class="token variable">$scheme</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   Host              <span class="token variable">$http_host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Real<span class="token operator">-</span>IP         <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For   <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">location</span> <span class="token operator">/</span>image <span class="token punctuation">&#123;</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token punctuation">:</span><span class="token number">9000</span><span class="token operator">/</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>Proto <span class="token variable">$scheme</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   Host              <span class="token variable">$http_host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Real<span class="token operator">-</span>IP         <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For   <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>配置之后发现接口访问没问题，但是图片访问报 400 错。</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><h2 id="单匹配后缀"><a href="#单匹配后缀" class="headerlink" title="单匹配后缀"></a>单匹配后缀</h2><p>使用<code>http://192.168.1.2:9000/xxx.png</code>访问图片是没问题的，也就是说图片服务器本身没问题，那问题就在转发这。</p>
<p>对比之后发现在转发的时候<strong>服务器返回的 contentType 不是<code>image/png</code></strong></p>
<p>这里我们更改代理配置为：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> \<span class="token punctuation">.</span><span class="token punctuation">(</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>gif<span class="token punctuation">)</span>$ <span class="token punctuation">&#123;</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token punctuation">:</span><span class="token number">9000</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>Proto <span class="token variable">$scheme</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   Host              <span class="token variable">$http_host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Real<span class="token operator">-</span>IP         <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For   <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>路径<code>https://testdns/xxx.png</code>图片正常显示。</p>
<blockquote>
<p>注意这里如果用了正则表达式来匹配 location 的话，在 proxy_pass 后面的 url 末尾不能加<code>/</code>，否则 nginx 会报错。</p>
</blockquote>
<h2 id="匹配路径-后缀"><a href="#匹配路径-后缀" class="headerlink" title="匹配路径+后缀"></a>匹配路径+后缀</h2><p>这里由于我们 Nginx 还配置了其他的项目，这里我们业务场景要求还是匹配到<code>/image</code>路径，所以我们这里要修改为匹配到<code>/image</code>路径并且图片格式结尾的话，就转发到<code>http://192.168.1.2:9000</code>。</p>
<p>这里多了一个<code>/image</code>路径，需要用到<code>rewrite</code>。</p>
<p><code>rewrite</code>：结合正则表达式和标志位实现 url 重写以及重定向。</p>
<blockquote>
<p>rewrite 只能放在<code>server&#123;&#125;,location&#123;&#125;,if&#123;&#125;</code>中，并且只能对域名后边的除去传递的参数外的字符串起作用</p>
</blockquote>
<p>这里需要注意 flag 标志位：</p>
<ul>
<li><code>last</code> : 相当于 Apache 的[L]标记，表示完成 rewrite</li>
<li><code>break</code> : 停止执行当前虚拟主机的后续 rewrite 指令集</li>
<li><code>redirect</code> : 返回 302 临时重定向，地址栏会显示跳转后的地址</li>
<li><code>permanent</code> : 返回 301 永久重定向，地址栏会显示跳转后的地址</li>
</ul>
<p>这里就 last 和 break 不好分辨，last 和 break 都能阻止继续执行后面的 rewrite 指令，但是 last 会根据 rewrite 的规则再次发起请求，重新匹配 location 等。</p>
<p>**这里我们需要用<code>break</code>**，所以最终的配置为：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token operator">/</span>image<span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>gif<span class="token punctuation">)</span>$ <span class="token punctuation">&#123;</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.7</span><span class="token number">.210</span><span class="token punctuation">:</span><span class="token number">9000</span><span class="token punctuation">;</span>
    <span class="token keyword">rewrite</span> <span class="token operator">^</span><span class="token operator">/</span>image<span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>jpg<span class="token operator">|</span>png<span class="token operator">|</span>gif<span class="token punctuation">)</span>$ <span class="token operator">/</span>$<span class="token number">1.</span>$<span class="token number">2</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>Proto <span class="token variable">$scheme</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   Host              <span class="token variable">$http_host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Real<span class="token operator">-</span>IP         <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For   <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>表示匹配到路径以<code>/image/</code>开始，并且以图片后缀结尾的话，反向代理到<code>http://192.168.7.210:9000</code>，并重写路径(去掉<code>/image</code>)</p>
<p>最后检查一下配置并重载</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ nginx -t<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ nginx -s reload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>路径<code>https://testdns/image/xxx.png</code>图片正常显示，问题解决。</p>
<h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h1><p>后来发现是自己路径的问题，在接口的时候没有报错而已，正确的写法应该是：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span>interface<span class="token operator">/</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token punctuation">:</span><span class="token number">10011</span><span class="token operator">/</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>Proto <span class="token variable">$scheme</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   Host              <span class="token variable">$http_host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Real<span class="token operator">-</span>IP         <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For   <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">location</span> <span class="token operator">/</span>image<span class="token operator">/</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token punctuation">:</span><span class="token number">9000</span><span class="token operator">/</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>Proto <span class="token variable">$scheme</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   Host              <span class="token variable">$http_host</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Real<span class="token operator">-</span>IP         <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span>   X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For   <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
]]></content>
      <categories>
        <category>Bug解决</category>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>node+npm更新</title>
    <url>/Bug%E8%A7%A3%E5%86%B3/Node/node-npm%E6%9B%B4%E6%96%B0/</url>
    <content><![CDATA[<p>由于家里的电脑很久没使用 node，近期写博客发现 node 版本比较低，需要升级。<br>这里把升级遇到的坑点，记录一下。</p>
<span id="more"></span>

<h1 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h1><p>在试过网上推荐的几个方式更新 node 版本都不行之后，就决定把 node 卸载了重新下载一个新版本安装。卸载再安装之后发现 node 版本倒是更新了，npm 的版本还是停留在老版本。</p>
<p>查看 node 版本：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ node -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看 npm 版本：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ npm -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>经过查找发现在<code>C:\Users\用户名\AppData\Roaming</code>文件夹下有一个 npm 和 npm-cache 文件，这里应该有 npm 的缓存之类的，狠心删除之后，再卸载 node 重新安装一次。npm 终于是更新了。</p>
]]></content>
      <categories>
        <category>Bug解决</category>
        <category>Node</category>
      </categories>
      <tags>
        <tag>npm</tag>
        <tag>npm-cache</tag>
      </tags>
  </entry>
  <entry>
    <title>rocket.chat搭建开源聊天服务器</title>
    <url>/%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/rocket-chat%E6%90%AD%E5%BB%BA%E5%BC%80%E6%BA%90%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
    <content><![CDATA[<p>近日使用 Rocket.Chat 搭建了一个聊天服务器，踩坑较多，写下以备后期查阅。</p>
<span id="more"></span>

<h1 id="启动一个数据库"><a href="#启动一个数据库" class="headerlink" title="启动一个数据库"></a>启动一个数据库</h1><ol>
<li><p>启动一个 mongo 实例并初始化 replicaSet</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ docker run --name db -d mongo:4.0 --smallfiles --replSet rs0 --oplogSize <span class="token number">128</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ docker <span class="token builtin class-name">exec</span> -ti db mongo --eval <span class="token string">"printjson(rs.initiate())"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h1 id="启动-Rocket-Chat"><a href="#启动-Rocket-Chat" class="headerlink" title="启动 Rocket.Chat"></a>启动 Rocket.Chat</h1><ol>
<li><p>启动一个 Rocket.Chat 并连接到 mongo 的实例上</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ docker run -p <span class="token number">3000</span>:3000 --name rocketchat --link db --env <span class="token assign-left variable">MONGO_OPLOG_URL</span><span class="token operator">=</span>mongodb://db:27017/local -d rocket.chat<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h1 id="配置网页端"><a href="#配置网页端" class="headerlink" title="配置网页端"></a>配置网页端</h1><ol>
<li><p>打开浏览器<code>http://localhost:3000</code></p>
</li>
<li><p>配置账号邮箱密码<code>admin/123456</code>，成功之后再增加一个 admin2 的账号<code>admin2/123456</code></p>
<img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210424001637.png" /></li>
</ol>
<h1 id="配置手机端"><a href="#配置手机端" class="headerlink" title="配置手机端"></a>配置手机端</h1><p>由于 Rocket.Chat 的手机端需要配置 https 的服务器，nginx 配置 https 则需要 CA 证书，CA 证书的申请 CSR 的字段<code>common name</code>需要配置具体的域名，这里将域名定为<code>test.fanta.cn</code>并配置解析到本机。</p>
<h2 id="配置域名解析"><a href="#配置域名解析" class="headerlink" title="配置域名解析"></a>配置域名解析</h2><ol>
<li><p>电脑打开<code>C:\Windows\System32\drivers\etc\hosts</code>，增加以下代码</p>
<pre class="line-numbers language-none"><code class="language-none">127.0.0.1       test.fanta.cn<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果编辑之后保存不了，将当前用户的权限提高，右键点击<code>hosts</code>–&gt;属性–&gt;安全–&gt;编辑，选中当前用户，勾选允许</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210424201050.png"></p>
</li>
</ol>
<h2 id="配置-Nginx"><a href="#配置-Nginx" class="headerlink" title="配置 Nginx"></a>配置 Nginx</h2><h3 id="生成自签名证书"><a href="#生成自签名证书" class="headerlink" title="生成自签名证书"></a>生成自签名证书</h3><ol>
<li><p>检测下是否安装 openssl</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ openssl version<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>生成私钥</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ openssl genrsa -des3 -out server.pass.key <span class="token number">2048</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>输入密码</p>
</li>
<li><p>去除私钥中的密码</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ openssl rsa -in server.pass.key -out server.key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>生成 CSR(证书签名请求)</p>
<blockquote>
<p><strong>注意自签名请求 csr 中的 Common Name 必须写域名(这里写 test.fanta.cn)，如果是测试，可以写 localhost</strong></p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ openssl req -new -key server.key -out server.csr<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210424202317.png"></p>
</li>
<li><p>生成自签名 SSL 证书</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># -days 证书有效期</span>
$ openssl x509 -req -days <span class="token number">365</span> -in server.csr -signkey server.key -out server.crt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
<li><p>拷贝密钥和 CA 证书到 Nginx</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cp</span> server.key /etc/nginx/certificate.key
$ <span class="token function">cp</span> server.crt /etc/nginx/certificate.crt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
<li><p>设置秘钥文件权限</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">chmod</span> <span class="token number">400</span> /etc/nginx/certificate.key<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>生成 ssl_dhparam 文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ openssl dhparam -out /etc/nginx/dhparams.pem <span class="token number">2048</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<h3 id="配置反向代理"><a href="#配置反向代理" class="headerlink" title="配置反向代理"></a>配置反向代理</h3><ol>
<li><p>编辑<code>nginx.conf</code>文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">vi</span> /etc/nginx/nginx.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参考<span class="exturl" data-url="aHR0cHM6Ly9yb2NrZXQuY2hhdC9kb2NzL2luc3RhbGxhdGlvbi9kb2NrZXItY29udGFpbmVycy8jNWItc2VsZi1zaWduZWQtc3Ns">官方文档<i class="fa fa-external-link-alt"></i></span></p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># HTTPS Server</span>
    <span class="token keyword">server</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span><span class="token punctuation">;</span>
        <span class="token keyword">server_name</span> test<span class="token punctuation">.</span>fanta<span class="token punctuation">.</span>cn<span class="token punctuation">;</span>

        <span class="token keyword">error_log</span> <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>rocketchat_error<span class="token punctuation">.</span>log<span class="token punctuation">;</span>

        <span class="token keyword">ssl_certificate</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>certificate<span class="token punctuation">.</span>crt<span class="token punctuation">;</span>
        <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>certificate<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
        <span class="token keyword">ssl_dhparam</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>dhparams<span class="token punctuation">.</span>pem<span class="token punctuation">;</span>
        <span class="token keyword">ssl_protocols</span> TLSv1<span class="token punctuation">.</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">ssl_ciphers</span> <span class="token string">'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA'</span><span class="token punctuation">;</span>
        <span class="token keyword">ssl_prefer_server_ciphers</span> on<span class="token punctuation">;</span>
        <span class="token keyword">ssl_session_cache</span> shared<span class="token punctuation">:</span><span class="token keyword">SSL</span><span class="token punctuation">:</span><span class="token number">20</span>m<span class="token punctuation">;</span>
        <span class="token keyword">ssl_session_timeout</span> <span class="token number">180</span>m<span class="token punctuation">;</span>

        <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.4</span><span class="token punctuation">:</span><span class="token number">3000</span><span class="token operator">/</span><span class="token punctuation">;</span>
            <span class="token keyword">proxy_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>
            <span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
            <span class="token keyword">proxy_set_header</span> Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>
            <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span><span class="token punctuation">;</span>
            <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Real<span class="token operator">-</span>IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
            <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
            <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>Proto <span class="token keyword">https</span><span class="token punctuation">;</span>
            <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Nginx<span class="token operator">-</span><span class="token keyword">Proxy</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">proxy_redirect</span> off<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>测试 nginx 配置文件是否正确</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ nginx -t<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>启动 nginx</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">service</span> nginx start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ol>
<p>这时候电脑端打开链接<code>https://test.fanta.cn</code>，Nginx 会报 502 的错误。这里需要防火墙需要打开 3000 端口。如果没有错误，则跳过下面防火墙放开 3000 端口这一步。</p>
<p><strong>我测试的环境用的 Nginx 是安装在 windows 的 wsl 的 ubuntu 系统里面，而我的 docker 是 windows 版本的直接安装在 windows 的，这里需要注意：docker 开放的 3000 端口只是对宿主机(windows10)开放，windows 里面的子系统 wsl 是读不到 docker 里面启动的 RocketChat 的，在 windows 里面<code>ipconfig</code>能看到 windows 的 ip 地址前缀为 192.168，docker 的前缀为 172.24，wsl 的前缀为 172.31。</strong></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722173732.png"></p>
<h2 id="放开-3000-端口"><a href="#放开-3000-端口" class="headerlink" title="放开 3000 端口"></a>放开 3000 端口</h2><p>这时候手机端也是连接不上电脑端的 3000 端口（可以用<code>JuiceSSH</code>本地连接手机之后 telnet 一下电脑的 3000 端口），需要在防火墙侧增加一个 3000 端口开放的规则（这里电脑系统为 win10）。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210424194951.jpg"></p>
<ol>
<li>按下<code>win+s</code>键，搜索“防火墙”。</li>
<li>打开高级安全 Windows Defender 防火墙</li>
<li>新建“入站规则”，选择端口</li>
</ol>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722173729.png"></p>
<ol start="4">
<li>选择特定端口 3000</li>
</ol>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210424181931.png"></p>
<ol start="5">
<li>下一步到完成。</li>
</ol>
<p>这时候电脑端打开<code>https://test.fanta.cn</code>则可以打开 Rocket.Chat</p>
<h2 id="连接服务器"><a href="#连接服务器" class="headerlink" title="连接服务器"></a>连接服务器</h2><h3 id="下载-App"><a href="#下载-App" class="headerlink" title="下载 App"></a>下载 App</h3><p>Android 端 APP 并安装到手机，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1JvY2tldENoYXQvUm9ja2V0LkNoYXQuUmVhY3ROYXRpdmUvcmVsZWFzZXM=">下载地址<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="打开-APP"><a href="#打开-APP" class="headerlink" title="打开 APP"></a>打开 APP</h3><p>填写服务器端地址</p>
<img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722173730.jpg" alt="1" style="width:50%;height:50%" />

<h3 id="配置代理"><a href="#配置代理" class="headerlink" title="配置代理"></a>配置代理</h3><p>手机和电脑端连接同一个 wifi，由于电脑端本地开启了域名解析，手机端也需要开启域名解析才行。这里采用 Fiddle 设置代理的方式把手机连接到电脑，这样手机也有了电脑的域名解析。</p>
<ol>
<li><p>电脑端下载 Fiddle，<span class="exturl" data-url="aHR0cHM6Ly93d3cudGVsZXJpay5jb20vZG93bmxvYWQvZmlkZGxlcg==">下载地址<i class="fa fa-external-link-alt"></i></span></p>
</li>
<li><p>设置 Fiddle</p>
<p>Tools–&gt;Options–&gt;Connections，记住端口号，并勾选<code>Allow remote computers to connect</code></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722173731.png"></p>
</li>
<li><p>手机端在 wifi 里面设置手动代理，地址填写电脑端的地址<code>192.168.1.4</code>，端口填写<code>18888</code>，保存修改</p>
</li>
<li><p>这样就实现了手机都走电脑的代理。就实现了手机端域名解析<code>test.fanta.cn</code></p>
</li>
</ol>
<h3 id="配置完成"><a href="#配置完成" class="headerlink" title="配置完成"></a>配置完成</h3><p>点击连接到电脑的服务器，输入网友端申请的账号密码<code>admin2/123456</code>，就可以与 web 端或者 pc 端的 Rocket.Chat 通信了，对于 Rocket.Chat 还是有很多不了解的地方，用于生产环境的话还需要细细探索。</p>
]]></content>
      <categories>
        <category>搭建教程</category>
      </categories>
      <tags>
        <tag>nginx</tag>
        <tag>rocket.chat</tag>
        <tag>openssl</tag>
        <tag>fiddle</tag>
      </tags>
  </entry>
  <entry>
    <title>prometheus+grafana实现数据采集展示+邮件告警</title>
    <url>/%E5%BC%80%E5%8F%91/Devops/prometheus-grafana%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%E5%B1%95%E7%A4%BA-%E9%82%AE%E4%BB%B6%E5%91%8A%E8%AD%A6/</url>
    <content><![CDATA[<blockquote>
<p><strong>Prometheus Server：Prometheus 服务的主服务器<br>Node Exporter：收集 Host 硬件和操作系统的信息<br>cAdvrisor：负责收集 Host 上运行的容器信息<br>Grafana：用来展示 Prometheus 监控操作界面（给我们提供一个友好的 web 界面）</strong></p>
</blockquote>
<span id="more"></span>

<h1 id="获取-node-exporter"><a href="#获取-node-exporter" class="headerlink" title="获取 node-exporter"></a>获取 node-exporter</h1><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d -p <span class="token number">9100</span>:9100 <span class="token punctuation">\</span>
--name nodeexporter <span class="token punctuation">\</span>
-v d:/docker/node-exporter/host/proc:/host/proc <span class="token punctuation">\</span>
-v d:/docker/node-exporter/host/sys:/host/sys <span class="token punctuation">\</span>
-v d:/docker/node-exporter/rootfs:/rootfs <span class="token punctuation">\</span>
prom/node-exporter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输入<code>http://localhost:9100/</code>即可查看页面</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510172501.png" alt="node-exporter"></p>
<h1 id="获取-cadvisor"><a href="#获取-cadvisor" class="headerlink" title="获取 cadvisor"></a>获取 cadvisor</h1><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d -p <span class="token number">8080</span>:8080 <span class="token punctuation">\</span>
--name cadvisor <span class="token punctuation">\</span>
-v d:/docker/cadvisor/rootfs:/rootfs:ro <span class="token punctuation">\</span>
-v d:/docker/cadvisor/var/run:/var/run:rw <span class="token punctuation">\</span>
-v d:/docker/cadvisor/var/lib/docker:/var/lib/docker:ro <span class="token punctuation">\</span>
google/cadvisor<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输入<code>http://localhost:8080/</code>即可查看页面</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510180058.png" alt="cadvisor"></p>
<h1 id="获取-prometheus"><a href="#获取-prometheus" class="headerlink" title="获取 prometheus"></a>获取 prometheus</h1><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d -p <span class="token number">9090</span>:9090 <span class="token punctuation">\</span>
--name prometheus <span class="token punctuation">\</span>
prom/prometheus<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>输入<code>http://localhost:9090/</code>即可查看页面</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510175743.png" alt="prometheus"></p>
<h1 id="获取-grafana"><a href="#获取-grafana" class="headerlink" title="获取 grafana"></a>获取 grafana</h1><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d -p <span class="token number">3000</span>:3000 <span class="token punctuation">\</span>
--name grafana <span class="token punctuation">\</span>
-v d:/docker/grafana/grafana-storage:/var/lib/grafana <span class="token punctuation">\</span>
grafana/grafana<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>输入<code>http://localhost:3000/</code>即可查看页面<br>初始密码为 admin/admin，首次登陆需要修改密码。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510175902.png" alt="grafana"></p>
<h1 id="获取-alertmanager"><a href="#获取-alertmanager" class="headerlink" title="获取 alertmanager"></a>获取 alertmanager</h1><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d -p <span class="token number">9093</span>:9093 <span class="token punctuation">\</span>
--name alertmanager <span class="token punctuation">\</span>
prom/alertmanager<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>输入<code>http://localhost:9093/</code>即可查看页面</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510180939.png" alt="alertmanager"></p>
<h1 id="数据展示"><a href="#数据展示" class="headerlink" title="数据展示"></a>数据展示</h1><p>修改 prometheus 的配置文件，配置文件在<code>/etc/prometheus/prometheus.yml</code>，以下方式都可以修改：</p>
<ul>
<li>直接进 shell 环境修改。</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker <span class="token builtin class-name">exec</span> -it prometheus <span class="token function">sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">vi</span> /etc/prometheus/prometheus.yml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>删除此 container，重新新建</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d -p <span class="token number">9090</span>:9090 <span class="token punctuation">\</span>
--name prometheus <span class="token punctuation">\</span>
-v d:/docker/prometheus/opt/prometheus.yml:/etc/prometheus/prometheus.yml  <span class="token punctuation">\</span>
prom/prometheus<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就将配置文件映射到本地，修改本地可以达到一样的效果</p>
<ul>
<li>配置文件也可以单独拷贝出来，代码如下</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker <span class="token function">cp</span> prometheus:/etc/prometheus/prometheus.yml ./<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>修改了配置文件之后用以下代码实现热加载</strong></p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">kill</span> -HUP <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里本地地址为<code>192.168.7.104</code>，其中 scrape_configs 的配置部分修改为</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> job_name<span class="token punctuation">:</span> <span class="token string">'prometheus'</span>
    static_configs<span class="token punctuation">:</span>
    <span class="token punctuation">-</span> targets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'192.168.7.104:9090'</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> job_name<span class="token punctuation">:</span> <span class="token string">'cadvisor'</span>
    static_configs<span class="token punctuation">:</span>
    <span class="token punctuation">-</span> targets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'192.168.7.104:8080'</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> job_name<span class="token punctuation">:</span> <span class="token string">'node'</span>
    scrape_interval<span class="token punctuation">:</span> 8s
    static_configs<span class="token punctuation">:</span>
    <span class="token punctuation">-</span> targets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'192.168.7.104:9100'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输入<code>kill -HUP 1</code>重新加载配置文件，在 prometheus 能看到三个 target</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510175401.png" alt="prometheus-targets"></p>
<p>输入<code>http://localhost:3000/</code>进入 grafana 控制台</p>
<h2 id="配置-datasource"><a href="#配置-datasource" class="headerlink" title="配置 datasource"></a>配置 datasource</h2><p>这里选择 prometheus</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510181802.png" alt="新建datasource"></p>
<p>地址填写 prometheus 的地址即可，注意这里需要填写本地局域网 192.168.7.104 地址</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510182205.png" alt="setting"></p>
<p>填写完成之后点击保存并测试</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510182400.png" alt="保存并测试"></p>
<h2 id="查找-dashboard-模板"><a href="#查找-dashboard-模板" class="headerlink" title="查找 dashboard 模板"></a>查找 dashboard 模板</h2><p>进入 grafana 官网找 <span class="exturl" data-url="aHR0cHM6Ly9ncmFmYW5hLmNvbS9ncmFmYW5hL2Rhc2hib2FyZHM=">dashboard 模板<i class="fa fa-external-link-alt"></i></span>，左侧可筛选，记下模板号，这里我们找到一个 8919 的模板</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510183227.png" alt="dashboard 模板"></p>
<h2 id="导入-dashboard-模板"><a href="#导入-dashboard-模板" class="headerlink" title="导入 dashboard 模板"></a>导入 dashboard 模板</h2><p>找到模板 id 之后，到 grafana 页面的 dashboard 页面 import 即可。填入模板号</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510183547.png" alt="import dashboard"></p>
<p>注意这里的 VictoriaMetrics 填入开始配置的 datasource</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510183812.png"></p>
<p>即可看到我们配置的 dashboard 了</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510184239.png" alt="dashboard"></p>
<h1 id="邮件报警"><a href="#邮件报警" class="headerlink" title="邮件报警"></a>邮件报警</h1><h2 id="配置-prometheus-yml"><a href="#配置-prometheus-yml" class="headerlink" title="配置 prometheus.yml"></a>配置 prometheus.yml</h2><p>prometheus.yml 的完整代码为：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># my global config</span>
<span class="token key atrule">global</span><span class="token punctuation">:</span>
  <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 15s <span class="token comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span>
  <span class="token key atrule">evaluation_interval</span><span class="token punctuation">:</span> 15s <span class="token comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span>
  <span class="token comment"># scrape_timeout is set to the global default (10s).</span>

<span class="token comment"># Alertmanager configuration</span>
<span class="token key atrule">alerting</span><span class="token punctuation">:</span>
  <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> 192.168.7.104<span class="token punctuation">:</span><span class="token number">9093</span>

<span class="token comment"># Load rules once and periodically evaluate them according to the global 'evaluation_interval'.</span>
<span class="token key atrule">rule_files</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">"node_down.yml"</span>
  <span class="token comment"># - "second_rules.yml"</span>

<span class="token comment"># A scrape configuration containing exactly one endpoint to scrape:</span>
<span class="token comment"># Here it's Prometheus itself.</span>
<span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>
  <span class="token comment"># The job name is added as a label `job=&lt;job_name>` to any timeseries scraped from this config.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">"prometheus"</span>

    <span class="token comment"># metrics_path defaults to '/metrics'</span>
    <span class="token comment"># scheme defaults to 'http'.</span>

    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.7.104:9090"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">"cadvisor"</span>
    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.7.104:8080"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">"node"</span>
    <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 8s
    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.7.104:9100"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="配置-node-down-yml"><a href="#配置-node-down-yml" class="headerlink" title="配置 node_down.yml"></a>配置 node_down.yml</h2><p>在该配置文件的同级目录下新建 node_down.yml 文件，配置一些报警的信息，断连一分钟则报警，完整代码如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">groups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> name<span class="token punctuation">:</span> node_down
    rules<span class="token punctuation">:</span>
      <span class="token punctuation">-</span> alert<span class="token punctuation">:</span> InstanceDown
        expr<span class="token punctuation">:</span> up == 0
        for<span class="token punctuation">:</span> 1m
        labels<span class="token punctuation">:</span>
          user<span class="token punctuation">:</span> test
        annotations<span class="token punctuation">:</span>
          summary<span class="token punctuation">:</span> <span class="token string">"Instance &#123;&#123; $labels.instance &#125;&#125; down"</span>
          description<span class="token punctuation">:</span> <span class="token string">"&#123;&#123; $labels.instance &#125;&#125; of job &#123;&#123; $labels.job &#125;&#125; has been down for more than 1 minutes."</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="配置-alertmanager-yml"><a href="#配置-alertmanager-yml" class="headerlink" title="配置 alertmanager.yml"></a>配置 alertmanager.yml</h2><p>进入 alertmanager 的 shell</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker <span class="token builtin class-name">exec</span> -it alertmanager <span class="token function">sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>配置 alertmanager 的配置文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">vi</span> /etc/alertmanager/alertmanager.yml<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里我们也可以采用和 prometheus 同样的方式，拷贝配置文件出来修改，或者映射配置文件到本地修改。</p>
<p>这里我配置的为我的 126 邮箱地址发送告警到我的 qq 邮箱地址，完整代码如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">global</span><span class="token punctuation">:</span>
  resolve_timeout<span class="token punctuation">:</span> 5m
  smtp_from<span class="token punctuation">:</span> <span class="token string">"fswuming@126.com"</span>
  smtp_smarthost<span class="token punctuation">:</span> <span class="token string">"smtp.126.com:25"</span>
  smtp_auth_username<span class="token punctuation">:</span> <span class="token string">"fswuming@126.com"</span>
  smtp_auth_password<span class="token punctuation">:</span> <span class="token string">"XXXXXXXXXXX"</span>
  smtp_require_tls<span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">route</span><span class="token punctuation">:</span>
  group_by<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"alertname"</span><span class="token punctuation">]</span>
  group_wait<span class="token punctuation">:</span> 10s
  group_interval<span class="token punctuation">:</span> 10s
  repeat_interval<span class="token punctuation">:</span> 10m
  receiver<span class="token punctuation">:</span> <span class="token string">"email"</span>
<span class="token key atrule">receivers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> name<span class="token punctuation">:</span> <span class="token string">"email"</span>
    email_configs<span class="token punctuation">:</span>
      <span class="token punctuation">-</span> to<span class="token punctuation">:</span> <span class="token string">"925583849@qq.com"</span>
<span class="token key atrule">inhibit_rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> source_match<span class="token punctuation">:</span>
      severity<span class="token punctuation">:</span> <span class="token string">"critical"</span>
    target_match<span class="token punctuation">:</span>
      severity<span class="token punctuation">:</span> <span class="token string">"warning"</span>
    equal<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"alertname"</span><span class="token punctuation">,</span> <span class="token string">"dev"</span><span class="token punctuation">,</span> <span class="token string">"instance"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中 smtp_auth_password 为邮件密码，也可以配置 qq 邮箱的报警，还可以配置企业微信和钉钉相关的报警。</p>
<h2 id="告警测试"><a href="#告警测试" class="headerlink" title="告警测试"></a>告警测试</h2><p>我们把收集信息的节点关闭，查看报警配置是否生效，这里我们将 node-exporter 和 cadvisor 都关闭，查看 prometheus</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510190029.png" alt="prometheus-targets"></p>
<p>可以看到我们已经关闭了 node-exporter 和 cadvisor，一分钟之后，我们的 qq 邮箱收到了告警信息</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510190209.png" alt="告警信息"></p>
<p>以上我们就实现了数据采集到展示并监控告警的过程，其中 grafana 可以配置很多<code>Time series databases</code>和<code>Logging &amp; document databases</code>，包括一些数据库的数据源如 mysql、postgresql 也是可以的，功能强大</p>
]]></content>
      <categories>
        <category>开发</category>
        <category>Devops</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>devops</tag>
        <tag>prometheus</tag>
        <tag>grafana</tag>
        <tag>数据采集</tag>
        <tag>邮件告警</tag>
      </tags>
  </entry>
  <entry>
    <title>tabindex之焦点移动</title>
    <url>/Bug%E8%A7%A3%E5%86%B3/Javascript/tabindex%E4%B9%8B%E7%84%A6%E7%82%B9%E7%A7%BB%E5%8A%A8/</url>
    <content><![CDATA[<p>记一次 <span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSFRNTC9HbG9iYWxfYXR0cmlidXRlcy90YWJpbmRleA==">tabindex<i class="fa fa-external-link-alt"></i></span> 的焦点移动问题解决</p>
<span id="more"></span>

<h1 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h1><p>由于博主目前所处行业是 IPTV，页面需要在 TV 端展示，所以基本上页面和遥控器打交道比较多。<br>这次项目是采用的 Android 的 webview 加载地址的方式拉起 url。<br>页面上用到了 pdfjs 用于浏览 pdf，在浏览器测试没有问题，进入页面聚焦之后可以实现上下翻页，但是在 Android 的 webview 中(模拟器开的 Android9.0 API28)，按“下”方向键没问题，按“上”方向键的时候焦点自动移动到了有 tabindex 的一个 button 上面，导致无法向上翻页。</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>开始尝试了把页面上的 tabindex 的其他位置都去掉，结果按“上”方向键仍然能够自动聚焦到 button 上面，只有另寻他法，最后发现将 tabindex 所在的 dom 设置为不可见 visibility:hidden，焦点就不会自动移动过去了。</p>
]]></content>
      <categories>
        <category>Bug解决</category>
        <category>Javascript</category>
      </categories>
      <tags>
        <tag>tabindex</tag>
      </tags>
  </entry>
  <entry>
    <title>vue+mqtt+protobuf的简单实践(1)</title>
    <url>/%E5%BC%80%E5%8F%91/MQTT/vue-mqtt-protobuf%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E8%B7%B5-1/</url>
    <content><![CDATA[<h1 id="mqtt-协议的简单使用"><a href="#mqtt-协议的简单使用" class="headerlink" title="mqtt 协议的简单使用"></a>mqtt 协议的简单使用</h1><p>MQTT（Message Queuing Telemetry Transport，消息队列遥测传输协议），是一种基于发布/订阅（publish/subscribe）模式的”轻量级”通讯协议，该协议构建于 TCP/IP 协议上，低开销、低带宽占用，在物联网、小型设备等方面应用较广。由 Broker(Server)+Pub/Sub 构成。</p>
<span id="more"></span>

<h2 id="创建一个-Broker"><a href="#创建一个-Broker" class="headerlink" title="创建一个 Broker"></a>创建一个 Broker</h2><p>这里我们使用了开源库<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21vc2NhanMvYWVkZXM=">aedes<i class="fa fa-external-link-alt"></i></span>.broker 的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21vc2NhanMvYWVkZXMvYmxvYi9tYWluL2RvY3MvQWVkZXMubWQ=">文档<i class="fa fa-external-link-alt"></i></span>，client 的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21vc2NhanMvYWVkZXMvYmxvYi9tYWluL2RvY3MvQ2xpZW50Lm1k">文档<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="创建-mqtt-服务"><a href="#创建-mqtt-服务" class="headerlink" title="创建 mqtt 服务"></a>创建 mqtt 服务</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> aedes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./aedes"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"net"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>aedes<span class="token punctuation">.</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="开启服务"><a href="#开启服务" class="headerlink" title="开启服务"></a>开启服务</h3><p>mqtt 协议默认端口是 1883</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">1883</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"server started and listening on port "</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="身份验证"><a href="#身份验证" class="headerlink" title="身份验证"></a>身份验证</h3><p>添加一个用户名密码的身份验证，这里账号密码设置为<code>user/123456</code></p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// 身份验证</span>
aedes<span class="token punctuation">.</span><span class="token function-variable function">authenticate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> username <span class="token operator">===</span> <span class="token string">"user"</span> <span class="token operator">&amp;&amp;</span> password<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果身份验证失败，可以参考<span class="exturl" data-url="aHR0cDovL2RvY3Mub2FzaXMtb3Blbi5vcmcvbXF0dC9tcXR0L3YzLjEuMS9vcy9tcXR0LXYzLjEuMS1vcy5odG1sI19UYWJsZV8zLjFfLQ==">错误码<i class="fa fa-external-link-alt"></i></span>,代码如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">aedes<span class="token punctuation">.</span><span class="token function-variable function">authenticate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">!==</span> <span class="token string">"user"</span> <span class="token operator">||</span> password <span class="token operator">!==</span> <span class="token string">"123456"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Auth error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    error<span class="token punctuation">.</span>returnCode <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="监听客户端"><a href="#监听客户端" class="headerlink" title="监听客户端"></a>监听客户端</h3><ul>
<li>监听客户端连接</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">aedes<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"clientReady"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token string">"Client Connected: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>client <span class="token operator">?</span> client<span class="token punctuation">.</span>id <span class="token operator">:</span> client<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"to broker"</span><span class="token punctuation">,</span>
    aedes<span class="token punctuation">.</span>id
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>监听客户端断开</li>
</ul>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">aedes<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"clientDisconnect"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token string">"Client Disconnected: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>client <span class="token operator">?</span> client<span class="token punctuation">.</span>id <span class="token operator">:</span> client<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"to broker"</span><span class="token punctuation">,</span>
    aedes<span class="token punctuation">.</span>id
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="创建发布端"><a href="#创建发布端" class="headerlink" title="创建发布端"></a>创建发布端</h2><h3 id="开启服务-1"><a href="#开启服务-1" class="headerlink" title="开启服务"></a>开启服务</h3><p>这里我们使用 mqtt 库，接口为<span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2UvbXF0dCNhcGk=">API<i class="fa fa-external-link-alt"></i></span></p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> mqtt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mqtt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="连接到-broker"><a href="#连接到-broker" class="headerlink" title="连接到 broker"></a>连接到 broker</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> client <span class="token operator">=</span> mqtt<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">"mqtt://127.0.0.1:1883"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  username<span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="监听连接"><a href="#监听连接" class="headerlink" title="监听连接"></a>监听连接</h3><p>监听并发布 protobuf 消息</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"connected"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"服务器连接成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>options<span class="token punctuation">.</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> qos<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> retain<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发布主题消息</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="创建订阅端"><a href="#创建订阅端" class="headerlink" title="创建订阅端"></a>创建订阅端</h2><h3 id="开启服务-2"><a href="#开启服务-2" class="headerlink" title="开启服务"></a>开启服务</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> mqtt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mqtt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="连接到-broker-1"><a href="#连接到-broker-1" class="headerlink" title="连接到 broker"></a>连接到 broker</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> client <span class="token operator">=</span> mqtt<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">"mqtt://127.0.0.1:1883"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  username<span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="监听连接-1"><a href="#监听连接-1" class="headerlink" title="监听连接"></a>监听连接</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js">client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"服务器连接成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span>options<span class="token punctuation">.</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> qos<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订阅text消息</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="接收订阅消息"><a href="#接收订阅消息" class="headerlink" title="接收订阅消息"></a>接收订阅消息</h3><pre class="line-numbers language-js" data-language="js"><code class="language-js">client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">topic<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"当前topic："</span><span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="测试-demo"><a href="#测试-demo" class="headerlink" title="测试 demo"></a>测试 demo</h2><ul>
<li>启动服务器<code>node broker.js</code></li>
<li>启动发布端<code>node pub.js</code></li>
<li>启动订阅端<code>node sub.js</code></li>
</ul>
]]></content>
      <categories>
        <category>开发</category>
        <category>MQTT</category>
      </categories>
      <tags>
        <tag>vue</tag>
        <tag>mqtt</tag>
        <tag>protobuf</tag>
      </tags>
  </entry>
  <entry>
    <title>vue+mqtt+protobuf的简单实践(2)</title>
    <url>/%E5%BC%80%E5%8F%91/MQTT/vue-mqtt-protobuf%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E8%B7%B5-2/</url>
    <content><![CDATA[<h1 id="protobuf-的简单使用"><a href="#protobuf-的简单使用" class="headerlink" title="protobuf 的简单使用"></a>protobuf 的简单使用</h1><p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jbi9wcm90b2NvbC1idWZmZXJzLw==">protobuf<i class="fa fa-external-link-alt"></i></span>是 Google 提供的与语言无关，与平台无关的，一个具有高效的协议数据交换格式工具库(类似 Json)，但相比于 Json，Protobuf 有更高的转化效率。</p>
<span id="more"></span>

<h2 id="配置-protobuf-插件-可选"><a href="#配置-protobuf-插件-可选" class="headerlink" title="配置 protobuf 插件(可选)"></a>配置 protobuf 插件(可选)</h2><h3 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h3><p>vscode 里面安装 Clang-Format 和 vscode-proto3 两个插件，其中 Clang-Format 用于格式化，vscode-proto3 用于语法提示、编译等。</p>
<h3 id="配置插件"><a href="#配置插件" class="headerlink" title="配置插件"></a>配置插件</h3><p>下载 llvm 用于 Clang-Format</p>
<p>vscode-proto3 是依赖于 Clang-Format 的，而 Clang-Format 的格式化依赖于 llvm 的 clang，所以这里的格式化要下载 llvm，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xsdm0vbGx2bS1wcm9qZWN0L3JlbGVhc2Vz">下载地址<i class="fa fa-external-link-alt"></i></span>，我这里是 windows 就选择的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xsdm0vbGx2bS1wcm9qZWN0L3JlbGVhc2VzL2Rvd25sb2FkL2xsdm1vcmctMTIuMC4wL0xMVk0tMTIuMC4wLXdpbjY0LmV4ZQ==">windows 版本<i class="fa fa-external-link-alt"></i></span>，下载完成后安装，安装完成之后在当前配置文件里面增加一行配置，后面是你安装的路径。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"clang-format.executable"</span><span class="token operator">:</span> <span class="token string">"C:\\Program Files\\LLVM\\bin\\clang-format.exe"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="编写-proto文件"><a href="#编写-proto文件" class="headerlink" title="编写.proto文件"></a>编写<code>.proto</code>文件</h2><p>这里我们定义一个<code>address.proto</code>，代码如下：</p>
<pre class="line-numbers language-protobuf" data-language="protobuf"><code class="language-protobuf"><span class="token keyword">syntax</span> <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>
<span class="token keyword">package</span> testprotobuf<span class="token punctuation">;</span>
<span class="token keyword">message</span> <span class="token class-name">Address</span> <span class="token punctuation">&#123;</span>
  <span class="token builtin">string</span> province <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token builtin">string</span> city <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token builtin">string</span> county <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们上一步如果安装了格式化插件的话，现在可以实现格式化和语法提示等。</p>
<h2 id="编译并测试"><a href="#编译并测试" class="headerlink" title="编译并测试"></a>编译并测试</h2><h3 id="方式一：使用-protoc"><a href="#方式一：使用-protoc" class="headerlink" title="方式一：使用 protoc"></a>方式一：使用 protoc</h3><h4 id="安装-protoc"><a href="#安装-protoc" class="headerlink" title="安装 protoc"></a>安装 protoc</h4><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Byb3RvY29sYnVmZmVycy9wcm90b2J1Zi9yZWxlYXNlcw==">下载地址<i class="fa fa-external-link-alt"></i></span>，这里我选择的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Byb3RvY29sYnVmZmVycy9wcm90b2J1Zi9yZWxlYXNlcy9kb3dubG9hZC92My4xNS44L3Byb3RvYy0zLjE1Ljgtd2luNjQuemlw">windows 版本<i class="fa fa-external-link-alt"></i></span>，下载之后解压到目录，将目录<code>C:\Program Files\Protoc-3.15.8-win64\bin</code>配置到环境变量中。</p>
<ul>
<li><p>如果配置了 vscode-proto3 插件</p>
<p>在当前项目根目录下新建<code>.vscode/setting.json</code>，代码如下：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"protoc"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"C:\\Program Files\\Protoc-3.15.8-win64\\bin\\protoc.exe"</span><span class="token punctuation">,</span>
    <span class="token property">"options"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"--proto_path=$&#123;workspaceRoot&#125;"</span><span class="token punctuation">,</span>
      <span class="token string">"--js_out=import_style=commonjs,binary:."</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>相关<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3p4aDAvdnNjb2RlLXByb3RvMw==">配置查看<i class="fa fa-external-link-alt"></i></span>，这里的 path 是编译的 protoc 执行地址，options 就是 protoc 里面的 options 参数，可在终端通过<code>protoc --help</code>查看相关配置。<code>$&#123;workspaceRoot&#125;</code>为当前的项目根地址</p>
</li>
</ul>
<h4 id="编译-proto"><a href="#编译-proto" class="headerlink" title="编译 proto"></a>编译 proto</h4><ul>
<li><p>如果配置了 vscode-proto3 插件，在 vscode 端使用组合键<code>Ctrl+Alt+P</code>，点击<code>proto3:Complie This Proto</code>，编译为<code>address_pb.js</code></p>
</li>
<li><p>如果没有配置插件，则直接在终端里面使用</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ protoc --js_out<span class="token operator">=</span>import_style<span class="token operator">=</span>commonjs,binary:. address.proto<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其中格式为<code>--js_out=[OPTIONS:]output_dir</code></p>
</li>
</ul>
<h4 id="node-测试"><a href="#node-测试" class="headerlink" title="node 测试"></a>node 测试</h4><p>添加 google-protobuf 包</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> google-protobuf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>新建文件<code>protoc_node.js</code>，代码如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> pb <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./address_pb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">pb<span class="token punctuation">.</span>Address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
address<span class="token punctuation">.</span><span class="token function">setProvince</span><span class="token punctuation">(</span><span class="token string">"sichuan"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
address<span class="token punctuation">.</span><span class="token function">setCity</span><span class="token punctuation">(</span><span class="token string">"chengdu"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
address<span class="token punctuation">.</span><span class="token function">setCounty</span><span class="token punctuation">(</span><span class="token string">"gaoxin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// var bytes = address.serializeBinary();</span>
<span class="token comment">// var unBytes = pb.Address.deserializeBinary(bytes);</span>

<span class="token keyword">var</span> province <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">getProvince</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> city <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">getCity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> county <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">getCounty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">province:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>province<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">,city:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>city<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">,county:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>county<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>执行文件<code>node protoc_node.js</code></p>
<p>打印结果如下：</p>
<pre class="line-numbers language-none"><code class="language-none">province:sichuan,city:chengdu,county:gaoxin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="web-测试"><a href="#web-测试" class="headerlink" title="web 测试"></a>web 测试</h4><p>web 情况下需要再次编译为 web 可用的 js 文件</p>
<ul>
<li><p>编写 export 文件</p>
<p>新建<code>address_export.js</code>，代码如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> address <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./address_pb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  DataProto<span class="token operator">:</span> address<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>编译为 web 可用文件</p>
<p>​ 编译后文件名为<code>address_web.js</code></p>
<ul>
<li><p>方式一：使用 browserify 编译</p>
<ul>
<li><p>安装文件的引用库</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> -g require<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><p>安装 browserify</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> -g browserify<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
</li>
<li><p>安装 protobuf 的库文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> google-protobuf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>使用 browserify 编译</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ browserify address_export.js -o  address_web.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
</li>
<li><p>方式二：使用 npx 编译</p>
<p><strong>推荐这种方式，不用安装其他库</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ npx browserify address_export.js -o  address_web.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
</li>
</ul>
<p>新建文件<code>protoc_brower.html</code></p>
<p>代码如下：</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>protoc_brower<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>address_web.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      <span class="token keyword">var</span> address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">proto<span class="token punctuation">.</span>testprotobuf<span class="token punctuation">.</span>Address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      address<span class="token punctuation">.</span><span class="token function">setProvince</span><span class="token punctuation">(</span><span class="token string">"sichuan"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      address<span class="token punctuation">.</span><span class="token function">setCity</span><span class="token punctuation">(</span><span class="token string">"chengdu"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      address<span class="token punctuation">.</span><span class="token function">setCounty</span><span class="token punctuation">(</span><span class="token string">"wuhou"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>address<span class="token punctuation">.</span><span class="token function">toObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="方式二：使用-protobufjs"><a href="#方式二：使用-protobufjs" class="headerlink" title="方式二：使用 protobufjs"></a>方式二：使用 protobufjs</h3><h4 id="直接使用"><a href="#直接使用" class="headerlink" title="直接使用"></a>直接使用</h4><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Byb3RvYnVmanMvcHJvdG9idWYuanM=">protobufjs 地址<i class="fa fa-external-link-alt"></i></span>，使用 protobufjs 的情况，可用直接加载<code>address.proto</code>文件</p>
<p>添加 protobufjs 包</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> protobufjs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="node-测试-1"><a href="#node-测试-1" class="headerlink" title="node 测试"></a>node 测试</h5><p>新建文件<code>protobufjs_node.js</code></p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> protobuf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"protobufjs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
protobuf<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"../address.proto"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>

  <span class="token comment">// Obtain a message type</span>
  <span class="token keyword">var</span> address <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">lookupType</span><span class="token punctuation">(</span><span class="token string">"testprotobuf.Address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Exemplary payload</span>
  <span class="token keyword">var</span> payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    province<span class="token operator">:</span> <span class="token string">"sichuan"</span><span class="token punctuation">,</span>
    city<span class="token operator">:</span> <span class="token string">"chengdu"</span><span class="token punctuation">,</span>
    county<span class="token operator">:</span> <span class="token string">"gaoxin"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token comment">// Verify the payload if necessary (i.e. when possibly incomplete or invalid)</span>
  <span class="token keyword">var</span> errMsg <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Create a new message</span>
  <span class="token keyword">var</span> message <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// or use .fromObject if conversion is necessary</span>

  <span class="token comment">// Encode a message to an Uint8Array (browser) or Buffer (node)</span>
  <span class="token keyword">var</span> buffer <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ... do something with buffer</span>

  <span class="token comment">// Decode an Uint8Array (browser) or Buffer (node) to a message</span>
  <span class="token keyword">var</span> message <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ... do something with message</span>

  <span class="token comment">// If the application uses length-delimited buffers, there is also encodeDelimited and decodeDelimited.</span>

  <span class="token comment">// Maybe convert the message back to a plain object</span>
  <span class="token keyword">var</span> object <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">toObject</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>执行文件<code>node protobufjs_node.js</code></p>
<p>结果如下：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123; province: &#39;sichuan&#39;, city: &#39;chengdu&#39;, county: &#39;gaoxin&#39; &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="web-测试-1"><a href="#web-测试-1" class="headerlink" title="web 测试"></a>web 测试</h5><p>新建文件<code>protobufjs_brower.html</code>，添加 js，<code>protobuf.min.js</code>，这里我是下载下来了再添加</p>
<pre class="line-numbers language-html" data-language="html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>X-UA-Compatible<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>IE=edge<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1.0<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>protobufjs_brower<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>protobuf.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
      protobuf<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"../address.proto"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>

        <span class="token comment">// Obtain a message type</span>
        <span class="token keyword">var</span> address <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">lookupType</span><span class="token punctuation">(</span><span class="token string">"testprotobuf.Address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Exemplary payload</span>
        <span class="token keyword">var</span> payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
          province<span class="token operator">:</span> <span class="token string">"sichuan"</span><span class="token punctuation">,</span>
          city<span class="token operator">:</span> <span class="token string">"chengdu"</span><span class="token punctuation">,</span>
          county<span class="token operator">:</span> <span class="token string">"wuhou"</span><span class="token punctuation">,</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

        <span class="token comment">// Verify the payload if necessary (i.e. when possibly incomplete or invalid)</span>
        <span class="token keyword">var</span> errMsg <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Create a new message</span>
        <span class="token keyword">var</span> message <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// or use .fromObject if conversion is necessary</span>

        <span class="token comment">// Encode a message to an Uint8Array (browser) or Buffer (node)</span>
        <span class="token keyword">var</span> buffer <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ... do something with buffer</span>

        <span class="token comment">// Decode an Uint8Array (browser) or Buffer (node) to a message</span>
        <span class="token keyword">var</span> message <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ... do something with message</span>

        <span class="token comment">// If the application uses length-delimited buffers, there is also encodeDelimited and decodeDelimited.</span>

        <span class="token comment">// Maybe convert the message back to a plain object</span>
        <span class="token keyword">var</span> object <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">toObject</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="编译后使用"><a href="#编译后使用" class="headerlink" title="编译后使用"></a>编译后使用</h4><p>由于前端 web 页面直接使用.proto 文件不太好，这里我们转换成 js 文件引入</p>
<h5 id="安装-pbjs"><a href="#安装-pbjs" class="headerlink" title="安装 pbjs"></a>安装 pbjs</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> -g pbjs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看 cli 相关的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Byb3RvYnVmanMvcHJvdG9idWYuanMvYmxvYi9tYXN0ZXIvY2xpL1JFQURNRS5tZCNwYmpzLWZvci1qYXZhc2NyaXB0">命令<i class="fa fa-external-link-alt"></i></span>，或者终端使用以下命令查看</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ pbjs --help<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="编译-proto-1"><a href="#编译-proto-1" class="headerlink" title="编译 proto"></a>编译 proto</h5><p>这里我们使用 json-module 方式，也可以选择其他方式 json、static-module 等。生成文件<code>protobufjs_bundle.js</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ pbjs -t json-module -w commonjs -o protobufjs_bundle.js address.proto<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>或者使用 npx 方式</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ npx pbjs -t json-module -w commonjs -o protobufjs_bundle.js address.proto<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h5 id="node-测试-2"><a href="#node-测试-2" class="headerlink" title="node 测试"></a>node 测试</h5><p>新建文件<code>protobufjs_bundle_node.js</code></p>
<p>代码如下:</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">var</span> protoRoot <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./protobufjs_bundle"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> address <span class="token operator">=</span> protoRoot<span class="token punctuation">.</span><span class="token function">lookupType</span><span class="token punctuation">(</span><span class="token string">"testprotobuf.Address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  province<span class="token operator">:</span> <span class="token string">"sichuan"</span><span class="token punctuation">,</span>
  city<span class="token operator">:</span> <span class="token string">"chengdu"</span><span class="token punctuation">,</span>
  county<span class="token operator">:</span> <span class="token string">"gaoxin"</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> message <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">message = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> buffer <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">buffer = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> decoded <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">decoded = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>decoded<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>执行结果如下：</p>
<pre class="line-numbers language-none"><code class="language-none">message &#x3D; &#123;&quot;province&quot;:&quot;sichuan&quot;,&quot;city&quot;:&quot;chengdu&quot;,&quot;county&quot;:&quot;gaoxin&quot;&#125;
buffer &#x3D; 10,7,115,105,99,104,117,97,110,18,7,99,104,101,110,103,100,117,26,6,103,97,111,120,105,110
decoded &#x3D; &#123;&quot;province&quot;:&quot;sichuan&quot;,&quot;city&quot;:&quot;chengdu&quot;,&quot;county&quot;:&quot;gaoxin&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h5 id="web-测试-2"><a href="#web-测试-2" class="headerlink" title="web 测试"></a>web 测试</h5><p>web 端如果是 require 的方式，会报<code>Require statement not part of import statement</code>错误，可用通过配置<code>.eslintrc.js</code>里面的<code>rules</code>，添加以下规则解决：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"@typescript-eslint/no-var-requires"</span><span class="token operator">:</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里建议还是通过以下代码编译为 es6 的方式：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ npx pbjs -t json-module -w es6 -o protobufjs_es6_bundle.js address.proto<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在 web 端可用通过 import 的方式引入代码</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> protoRoot <span class="token keyword">from</span> <span class="token string">"./protobufjs_es6_bundle.js"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>具体的测试方式和 node 一样的代码，这里就不做演示了，以上就是 protobuf 在 JavaScript 方面的简单使用。</p>
]]></content>
      <categories>
        <category>开发</category>
        <category>MQTT</category>
      </categories>
      <tags>
        <tag>vue</tag>
        <tag>mqtt</tag>
        <tag>protobuf</tag>
      </tags>
  </entry>
  <entry>
    <title>vue+mqtt+protobuf的简单实践(3)</title>
    <url>/%E5%BC%80%E5%8F%91/MQTT/vue-mqtt-protobuf%E7%9A%84%E7%AE%80%E5%8D%95%E5%AE%9E%E8%B7%B5-3/</url>
    <content><![CDATA[<h1 id="vue3-mqtt-protobuf"><a href="#vue3-mqtt-protobuf" class="headerlink" title="vue3+mqtt+protobuf"></a>vue3+mqtt+protobuf</h1><p>这里我们使用 node 端模拟 broker+publish/subscribe，web 端用 vue3+mqtt 模拟 publish/subscribe，测试发现 mqtt 好像不能直接用于浏览器端，可用通过转换来实现<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21xdHRqcy9NUVRULmpzI2Jyb3dzZXI=">Brower 端的使用<i class="fa fa-external-link-alt"></i></span></p>
<span id="more"></span>

<h2 id="node-端"><a href="#node-端" class="headerlink" title="node 端"></a>node 端</h2><p>测试发现 mqtt 支持浏览器的话，需要转换为 websoket 的方式，就是<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21vc2NhanMvYWVkZXMvYmxvYi9tYWluL2RvY3MvRXhhbXBsZXMubWQjbXF0dC1zZXJ2ZXItb3Zlci13ZWJzb2NrZXQtdXNpbmctc2VydmVyLWZhY3Rvcnk=">MQTT over Websockets<i class="fa fa-external-link-alt"></i></span></p>
<h3 id="创建-Broker"><a href="#创建-Broker" class="headerlink" title="创建 Broker"></a>创建 Broker</h3><p>新建<code>broker-ws.js</code>文件，代码如下，这里我们使用了<code>websocket-stream</code>库来实现<code>MQTT over Websockets</code>。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">/**
 * 创建mqtt服务器
 */</span>
<span class="token keyword">const</span> aedes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"aedes"</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> httpServer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"http"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ws <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"websocket-stream"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token number">8888</span><span class="token punctuation">;</span>

ws<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> server<span class="token operator">:</span> httpServer <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> aedes<span class="token punctuation">.</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>

httpServer<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"websocket server listening on port "</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 身份验证</span>
aedes<span class="token punctuation">.</span><span class="token function-variable function">authenticate</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">username:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>username<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">，password：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>password<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> username <span class="token operator">===</span> <span class="token string">"user"</span> <span class="token operator">&amp;&amp;</span> password<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 客户端连接</span>
aedes<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"clientReady"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token string">"Client Connected: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>client <span class="token operator">?</span> client<span class="token punctuation">.</span>id <span class="token operator">:</span> client<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"to broker"</span><span class="token punctuation">,</span>
    aedes<span class="token punctuation">.</span>id
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 客户端断开</span>
aedes<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"clientDisconnect"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token string">"Client Disconnected: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>client <span class="token operator">?</span> client<span class="token punctuation">.</span>id <span class="token operator">:</span> client<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"to broker"</span><span class="token punctuation">,</span>
    aedes<span class="token punctuation">.</span>id
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="创建-client"><a href="#创建-client" class="headerlink" title="创建 client"></a>创建 client</h3><p>新建<code>client-ws.js</code>用于和浏览器端互相发布订阅</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> mqtt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mqtt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> protobuf <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"protobufjs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> address <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> client <span class="token operator">=</span> mqtt<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">"ws://127.0.0.1:8888"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  username<span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

protobuf<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token string">"./address.proto"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> root</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  address <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">lookupType</span><span class="token punctuation">(</span><span class="token string">"testmqtt.Address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务器连接成功，clientId为</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>client<span class="token punctuation">.</span>options<span class="token punctuation">.</span>clientId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"vue-protobuf"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> qos<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订阅消息</span>
  <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发布消息</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">topic<span class="token punctuation">,</span> messageBuffer</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> message <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>messageBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> object <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">toObject</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">接收到</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>client<span class="token punctuation">.</span>options<span class="token punctuation">.</span>clientId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">主题为</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>topic<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">的消息\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
      object
    <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 发布消息
 */</span>
<span class="token keyword">function</span> <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">var</span> payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    province<span class="token operator">:</span> <span class="token string">"sichuan"</span><span class="token punctuation">,</span>
    city<span class="token operator">:</span> <span class="token string">"chengdu"</span><span class="token punctuation">,</span>
    county<span class="token operator">:</span> <span class="token string">"gaoxin"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> errMsg <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> message <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> buffer <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"node-protobuf"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    qos<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    retain<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">setTimeout</span><span class="token punctuation">(</span>postMessage<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="brower-端"><a href="#brower-端" class="headerlink" title="brower 端"></a>brower 端</h2><h3 id="生成-proto-js"><a href="#生成-proto-js" class="headerlink" title="生成 proto.js"></a>生成 proto.js</h3><p>这里我们采用 pbjs 的方式生成浏览器端可用的 js，使用 json-module 的方式</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ npx pbjs -t json-module -w es6 -o address_proto.js address.proto<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="vue-配置"><a href="#vue-配置" class="headerlink" title="vue 配置"></a>vue 配置</h3><p>这里我们新建一个 vue 的项目</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ vue create testmqtt-protobuf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li><p>首先我们增加 mqtt 和 protobufjs 的库</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">$ yarn add mqtt protobufjs<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>将生成的 address_proto.js 拷贝到项目中，并新建<code>mqtt.js</code>文件用于订阅发布</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> connect <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"mqtt"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> protoRoot <span class="token keyword">from</span> <span class="token string">"@/proto/address_proto"</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">mqtt</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">"ws://127.0.0.1:8888"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    username<span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
    password<span class="token operator">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> address <span class="token operator">=</span> protoRoot<span class="token punctuation">.</span><span class="token function">lookupType</span><span class="token punctuation">(</span><span class="token string">"testmqtt.Address"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"connect"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务器连接成功，clientId为</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>client<span class="token punctuation">.</span>options<span class="token punctuation">.</span>clientId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"node-protobuf"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> qos<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 订阅消息</span>
    <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发布消息</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">topic<span class="token punctuation">,</span> messageBuffer</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> message <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>messageBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> object <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">toObject</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">接收到</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>client<span class="token punctuation">.</span>options<span class="token punctuation">.</span>clientId<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">主题为</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>topic<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">的消息\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
        object
      <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 发布消息
   */</span>
  <span class="token keyword">function</span> <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> payload <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      province<span class="token operator">:</span> <span class="token string">"sichuan"</span><span class="token punctuation">,</span>
      city<span class="token operator">:</span> <span class="token string">"chengdu"</span><span class="token punctuation">,</span>
      county<span class="token operator">:</span> <span class="token string">"wuhou"</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> errMsg <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span>errMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> message <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> buffer <span class="token operator">=</span> address<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">"vue-protobuf"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      qos<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      retain<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span>postMessage<span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> mqtt<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 Home.vue 文件中添加 mqtt.js</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> onMounted<span class="token punctuation">,</span> defineComponent <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">"vue"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> mqtt <span class="token keyword">from</span> <span class="token string">"@/utils/mqtt"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> HelloWorld <span class="token keyword">from</span> <span class="token string">"@/components/HelloWorld.vue"</span><span class="token punctuation">;</span> <span class="token comment">// @ is an alias to /src</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineComponent</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  name<span class="token operator">:</span> <span class="token string">"Home"</span><span class="token punctuation">,</span>
  components<span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    HelloWorld<span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token function">mqtt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><blockquote>
<p>如果 vue 用 typescript 的方式，会提示需要定义 module，在<code>shims-vue.d.ts</code>文件中增加<code>declare module &#39;@/utils/mqtt&#39;</code>即可，</p>
<p>如果有提示需要增加返回值的情况，可在 eslint 中关闭，rules 增加<code>&quot;@typescript-eslint/explicit-module-boundary-types&quot;: &quot;off&quot;</code></p>
</blockquote>
<ul>
<li>启动 broker</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ node broker-ws.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>启动 client.js</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ node client-ws.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>启动 vue</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">yarn</span> serve<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这是我们能看到控制台打印为</p>
<ul>
<li>broker</li>
</ul>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210502001809.png" alt="broker"></p>
<ul>
<li><p>client</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210502001842.png" alt="client"></p>
</li>
<li><p>brower</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210502001909.png" alt="brower"></p>
</li>
</ul>
]]></content>
      <categories>
        <category>开发</category>
        <category>MQTT</category>
      </categories>
      <tags>
        <tag>vue</tag>
        <tag>mqtt</tag>
        <tag>protobuf</tag>
      </tags>
  </entry>
  <entry>
    <title>websocket经常自动关闭问题解决</title>
    <url>/Bug%E8%A7%A3%E5%86%B3/Websocket/websocket%E7%BB%8F%E5%B8%B8%E8%87%AA%E5%8A%A8%E5%85%B3%E9%97%AD%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/</url>
    <content><![CDATA[<p>记一次 Websocket 经常 close 问题的解决方式。</p>
<span id="more"></span>

<h1 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h1><p>项目中遇到 websocket 经常掉线的问题，打印错误能看到错误码。</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">websocket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token string">"WebSocket is closed now: code: "</span> <span class="token operator">+</span>
      e<span class="token punctuation">.</span>code <span class="token operator">+</span>
      <span class="token string">",reason: "</span> <span class="token operator">+</span>
      e<span class="token punctuation">.</span>reason <span class="token operator">+</span>
      <span class="token string">",wasClean: "</span> <span class="token operator">+</span>
      e<span class="token punctuation">.</span>wasClean
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>code</code>: code 是错误码，是整数类型</li>
<li><code>reason</code>: reason 是断开原因，是字符串</li>
<li><code>wasClean</code>: wasClean 表示是否正常断开，是布尔值。一般异常断开时，该值为 false</li>
</ul>
<p>这里我们打印到的错误码为 1006：<code>保留</code>. 用于期望收到状态码时连接非正常关闭 (也就是说, 没有发送关闭帧).</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>这里由于我们的 Websocket 是用 Nginx 做了代理</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span>chat<span class="token operator">/</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>backend<span class="token punctuation">;</span>
    <span class="token keyword">proxy_http_version</span> <span class="token number">1.1</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> Upgrade <span class="token variable">$http_upgrade</span><span class="token punctuation">;</span>
    <span class="token keyword">proxy_set_header</span> Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Nginx 有一个代理超时机制，如果超过默认的 60 秒时间，代理会自动关闭，详见<span class="exturl" data-url="aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL2h0dHAvd2Vic29ja2V0Lmh0bWw=">文档<i class="fa fa-external-link-alt"></i></span></p>
<p>解决方式有两种：</p>
<ol>
<li><p>通过修改 Nginx 的<span class="exturl" data-url="aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL2h0dHAvbmd4X2h0dHBfcHJveHlfbW9kdWxlLmh0bWwjcHJveHlfcmVhZF90aW1lb3V0">proxy_read_timeout<i class="fa fa-external-link-alt"></i></span>字段来修改默认代理时间，将时间写长一点。</p>
</li>
<li><p>通过心跳的方式来检查连接是否仍有效。客户端定时发送<code>ping</code>到服务器，服务器收到之后返回<code>pong</code>。</p>
</li>
</ol>
<p>这里我们采用第二种方式，增加心跳检测来检查连接，检测到服务器离线之后自动重连。</p>
<p>代码如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">let</span> websocket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> websocketUrl <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> heartbeatTimer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> reconnectTimer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">websocketInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  websocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>websocketUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  websocket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"WebSocket is open now."</span><span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reconnectTimer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>reconnectTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">heartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  websocket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">heartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token string">"pong"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">//todo</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  websocket<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"WebSocket error observed."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  websocket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
      <span class="token string">"WebSocket is closed now: code: "</span> <span class="token operator">+</span>
        e<span class="token punctuation">.</span>code <span class="token operator">+</span>
        <span class="token string">",reason: "</span> <span class="token operator">+</span>
        e<span class="token punctuation">.</span>reason <span class="token operator">+</span>
        <span class="token string">",wasClean: "</span> <span class="token operator">+</span>
        e<span class="token punctuation">.</span>wasClean<span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">heartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>heartbeatTimer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>heartbeatTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">//每隔10秒钟发送一次心跳，避免websocket连接因超时而自动断开</span>
  heartbeatTimer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"ping"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function">reconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>reconnectTimer<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>reconnectTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">//每隔3秒钟重连一次</span>
  reconnectTimer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">websocketInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token function">websocketInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
]]></content>
      <categories>
        <category>Bug解决</category>
        <category>Websocket</category>
      </categories>
      <tags>
        <tag>websocket</tag>
      </tags>
  </entry>
  <entry>
    <title>wordpres搭建简易网站</title>
    <url>/%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/wordpres%E6%90%AD%E5%BB%BA%E7%AE%80%E6%98%93%E7%BD%91%E7%AB%99/</url>
    <content><![CDATA[<p>搭建网站的工具和平台有很多，常见的就有 wordpress，国内的有 pageadmin、metinfo、禅知等。还有自助建站的凡科等等。</p>
<p>wordpress 是一个 php 开发的博客平台，由于使用甚广，也有很多网站的主题和模板，用来搭建简易网站的例子也很多，这里我们就使用 wordpress 来搭建简易网站。</p>
<span id="more"></span>

<h1 id="创建宝塔"><a href="#创建宝塔" class="headerlink" title="创建宝塔"></a>创建宝塔</h1><p>这里我们选用 docker 安装<span class="exturl" data-url="aHR0cHM6Ly9odWIuZG9ja2VyLmNvbS9yL3BjaDE4L2Jhb3Rh">宝塔<i class="fa fa-external-link-alt"></i></span>，这里 docker 的宝塔是自带了 LNMP(linux+nginx+mysql+php)环境，后面安装 wordpress 的时候就省事很多。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -tid --name baota -p <span class="token number">80</span>:80 -p <span class="token number">443</span>:443 -p <span class="token number">8888</span>:8888 -p <span class="token number">888</span>:888 --privileged<span class="token operator">=</span>true --shm-size<span class="token operator">=</span>1g -v D:<span class="token punctuation">\</span>docker<span class="token punctuation">\</span>baota<span class="token punctuation">\</span>wwwroot:/www/wwwroot pch18/baota<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>启动之后输入 <code>http://localhost:8888/</code>打开宝塔登录页面，输入账号<code>username</code>密码<code>password</code>，这里如果忘记了登录密码的话，可以进宝塔的服务器</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker <span class="token builtin class-name">exec</span> -it baota <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>输入<code>bt</code>命令</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ bt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>能看到可以修改密码</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722113138.png" alt="bt命令"></p>
<p>这里我们修改密码为<code>123456</code>，然后登录进宝塔。登录之后有一个需要填写宝塔账号的，这里我是 F12 然后去掉了弹框。。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722145554.jpg" alt="宝塔面板"></p>
<h1 id="创建网站"><a href="#创建网站" class="headerlink" title="创建网站"></a>创建网站</h1><h2 id="下载-wordpress"><a href="#下载-wordpress" class="headerlink" title="下载 wordpress"></a>下载 wordpress</h2><p>在官网上下载<span class="exturl" data-url="aHR0cHM6Ly93b3JkcHJlc3Mub3JnLw==">wordpress<i class="fa fa-external-link-alt"></i></span>，注意网址是<code>https://wordpress.org/</code>，这里容易进到另外一个网址<code>https://wordpress.com/</code>，这个<code>.com</code>是可托管 wordpress 的网站。</p>
<h2 id="添加网站"><a href="#添加网站" class="headerlink" title="添加网站"></a>添加网站</h2><p>宝塔菜单栏选择网站–&gt;添加站点，这里我是用本机的，添加了一个<code>127.0.0.1</code>，然后再添加一个数据库。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722113728.png" alt="添加网站"></p>
<p>解压前面下载的 wordpress 压缩包，由于我们映射了目录出来，这里我们可以直接拷贝 wordpress 解压之后的文件到<code>D:\docker\baota\wwwroot\127.0.0.1</code>文件夹。原来的文件夹里文件可以直接删除。</p>
<p>如果没有映射出来的话，进入宝塔菜单栏选择&lt;文件&gt;，选择<code>127.0.0.1</code>文件夹，这里宝塔是通过 vhost 来创建的。将解压后的文件拷贝到<code>127.0.0.1</code>的文件夹的根目录，由于上传不能超过 800 个文件，这里可以上传了之后再解压，注意解压之后的文件一定要放到<code>127.0.0.1</code>的文件夹下。</p>
<p>上传之后如下图：</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722151649.png"></p>
<p>宝塔菜单栏点击设置–&gt;网站目录，去掉防跨站攻击。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722114004.png"></p>
<p>点击伪静态–&gt;选择<code>wordpress</code>，再保存。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722150349.png"></p>
<h2 id="配置-wordpress"><a href="#配置-wordpress" class="headerlink" title="配置 wordpress"></a>配置 wordpress</h2><p>输入网址<code>http://127.0.0.1</code>，打开 wordpress 启动配置页面。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722151758.png" alt="wordpress启动配置页"></p>
<p>宝塔菜单栏选择数据库，查看数据库的用户名、密码、数据库名称等信息。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722151908.png" alt="宝塔-数据库"></p>
<p>填入我们的宝塔建的数据库的数据库名字，用户名和密码。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722151931.png" alt="填入wordpress"></p>
<p>再填写一些基本信息之后点击安装 wordpress。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722152044.png"></p>
<h2 id="配置主题"><a href="#配置主题" class="headerlink" title="配置主题"></a>配置主题</h2><p>用刚刚创建的用户名<code>test</code>，密码<code>123456</code>登录 wordpress。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722171949.png"></p>
<p>选择外观–&gt;主题，我们可以把没有启用的主题删掉，点击主题详情之后，右下角有一个删除的按钮，点击之后可以删掉。</p>
<p>这里主题推荐几个模板比较多的，首先<span class="exturl" data-url="aHR0cHM6Ly9hdmFkYS50aGVtZS1mdXNpb24uY29tLw==">Avada 主题<i class="fa fa-external-link-alt"></i></span>是非常受欢迎的，模板有 83 个之多，选择很多，如果是购买正版，购买网址在<span class="exturl" data-url="aHR0cHM6Ly90aGVtZWZvcmVzdC5uZXQv">themeforest<i class="fa fa-external-link-alt"></i></span>，可以享受持续更新。网上有破解和汉化的版本，某宝也可以购买，小心挂马，注意甄别。如果不想选收费的，这里推荐一个免费的主题，同样模板非常多，就是<span class="exturl" data-url="aHR0cHM6Ly93cGFzdHJhLmNvbS8=">Astra 主题<i class="fa fa-external-link-alt"></i></span>，可以在官网找模板，也可以在<span class="exturl" data-url="aHR0cHM6Ly93ZWJzaXRlZGVtb3MubmV0Lz90eXBlPWZyZWUmcGFnZS1idWlsZGVyPWVsZW1lbnRvcg==">模板网址<i class="fa fa-external-link-alt"></i></span>找。支持 Elementor、Beaver Builder、Brizy、Gutenberg 等 4 个模板编辑，免费和收费模板共 150+，免费的都有 95 个，可谓是非常多了。</p>
<p>当然还有其他主题也很不错，比如 Neve 主题，也提供了很多模板，少量的免费，大部分的收费。还有 OceanWP 也很不错，其他受欢迎的还有 GeneratePress 等。我们这里就安装 Astra 并启用。</p>
<h2 id="选择模板"><a href="#选择模板" class="headerlink" title="选择模板"></a>选择模板</h2><p>点击主题之后能看到开始使用的按钮。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722154703.png"></p>
<p>提示我们安装<code>Starter Templates</code>的模板插件。</p>
<p>wordpress 左侧菜单选择插件，搜索出<code>Starter Templaters</code>并安装，能看到左侧菜单多出了一个<code>Starter Templaters</code>选项。这里我们选择比较常用的<code>Elementor</code></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722171950.png"></p>
<p>可以看到很多的模板</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722171946.png"></p>
<p>选择一个模板之后可以选择单个页面导入或者整体导入。这里我们选择整体导入</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722171945.png"></p>
<p>然后会填写一些信息。填写之后等待导入。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722155656.png"></p>
<p>导入完成之后点击预览</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722160100.png"></p>
<p>能看到网站已经搭建成功。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722171948.png"></p>
<p>如果有修改和调整，比如文字图片的调整可以点击<code>使用Elementor</code>编辑。里面的媒体文件、文章等都可以在 wordpress 里面找到，导入模板的时候是导入过的。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722171947.png"></p>
<h1 id="网站迁移"><a href="#网站迁移" class="headerlink" title="网站迁移"></a>网站迁移</h1><p>如果网站需要迁移，主要是两个部分的，一个是数据库，一个是文件。</p>
<h2 id="网站文件迁移"><a href="#网站文件迁移" class="headerlink" title="网站文件迁移"></a>网站文件迁移</h2><p>文件的话需要把<code>127.0.0.1</code>的文件夹下的东西都打包整体拷贝，注意根目录下<code>wp-config.php</code>里的配置需要换成生产环境下数据库的主机、账号名、密码、数据库名称。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722171951.png"></p>
<h2 id="数据库迁移"><a href="#数据库迁移" class="headerlink" title="数据库迁移"></a>数据库迁移</h2><p>数据库的话可以生成 sql 导入，这里进入宝塔面板，点击左侧数据库。选择管理</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722161031.png"></p>
<p>进入 phpadmin 之后选择导出</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210722171952.png"></p>
<p>生成的 sql 文件之后记得把里面的站点文件<code>127.0.0.1</code>换成生产环境需要用到的域名或者 ip，注意如果是 https 的话需要将相应的 http 改成 https。</p>
<p>将 sql 文件导入到生产环境的数据库，将网址文件放到建立的网站根目录下，网站迁移成功。</p>
]]></content>
      <categories>
        <category>搭建教程</category>
      </categories>
      <tags>
        <tag>wordpress</tag>
        <tag>astra</tag>
      </tags>
  </entry>
  <entry>
    <title>使用docker+minio实现对象存储</title>
    <url>/%E5%BC%80%E5%8F%91/%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8/%E4%BD%BF%E7%94%A8docker-minio%E5%AE%9E%E7%8E%B0%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8/</url>
    <content><![CDATA[<p>本文主要介绍通过 docker+minio 实现对象存储的环境搭建。<span class="exturl" data-url="aHR0cDovL2RvY3MubWluaW8ub3JnLmNuL2RvY3Mv">minio 文档<i class="fa fa-external-link-alt"></i></span></p>
<span id="more"></span>

<h1 id="创建-minio-服务端"><a href="#创建-minio-服务端" class="headerlink" title="创建 minio 服务端"></a>创建 minio 服务端</h1><p>创建 minio 服务器并设置账号密码为 admin/12345678，密码至少需要 8 位数。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -d -p <span class="token number">9000</span>:9000 --name minio -v d:<span class="token punctuation">\</span>docker<span class="token punctuation">\</span>minio<span class="token punctuation">\</span>data:/data -e <span class="token string">"MINIO_ACCESS_KEY=admin"</span> -e <span class="token string">"MINIO_SECRET_KEY=12345678"</span> minio/minio server /data<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这时候打开浏览器输入<code>http://127.0.0.1:9000/</code>能访问到 minio，输入账号密码即可进入。<br>进入页面之后新建一个 bucket，取名 testpic，然后上传几张图片。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210510171513.png" alt="minio"></p>
<h1 id="创建-minio-客户端"><a href="#创建-minio-客户端" class="headerlink" title="创建 minio 客户端"></a>创建 minio 客户端</h1><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker run -itd --name minioclient --entrypoint<span class="token operator">=</span>/bin/sh minio/mc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="客户端连接到服务端"><a href="#客户端连接到服务端" class="headerlink" title="客户端连接到服务端"></a>客户端连接到服务端</h1><p>启动客户端进入控制台</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker <span class="token builtin class-name">exec</span> -it minioclient <span class="token function">sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>添加管理配置文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">mc</span> config <span class="token function">host</span> <span class="token function">add</span> minio http://localhost:9000 admin <span class="token number">12345678</span> --api s3v4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>添加了一个名为 minio 的服务端，添加完成后可通过</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">cat</span> /root/.mc/config.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看配置文件如下</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"10"</span><span class="token punctuation">,</span>
  <span class="token property">"aliases"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"gcs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://storage.googleapis.com"</span><span class="token punctuation">,</span>
      <span class="token property">"accessKey"</span><span class="token operator">:</span> <span class="token string">"YOUR-ACCESS-KEY-HERE"</span><span class="token punctuation">,</span>
      <span class="token property">"secretKey"</span><span class="token operator">:</span> <span class="token string">"YOUR-SECRET-KEY-HERE"</span><span class="token punctuation">,</span>
      <span class="token property">"api"</span><span class="token operator">:</span> <span class="token string">"S3v2"</span><span class="token punctuation">,</span>
      <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"dns"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"local"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"http://localhost:9000"</span><span class="token punctuation">,</span>
      <span class="token property">"accessKey"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
      <span class="token property">"secretKey"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
      <span class="token property">"api"</span><span class="token operator">:</span> <span class="token string">"S3v4"</span><span class="token punctuation">,</span>
      <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"auto"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"minio"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"http://localhost:9000"</span><span class="token punctuation">,</span>
      <span class="token property">"accessKey"</span><span class="token operator">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
      <span class="token property">"secretKey"</span><span class="token operator">:</span> <span class="token string">"12345678"</span><span class="token punctuation">,</span>
      <span class="token property">"api"</span><span class="token operator">:</span> <span class="token string">"s3v4"</span><span class="token punctuation">,</span>
      <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"auto"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"play"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://play.min.io"</span><span class="token punctuation">,</span>
      <span class="token property">"accessKey"</span><span class="token operator">:</span> <span class="token string">"Q3AM3UQ867SPQQA43P2F"</span><span class="token punctuation">,</span>
      <span class="token property">"secretKey"</span><span class="token operator">:</span> <span class="token string">"zuf+tfteSlswRu7BJ86wekitnifILbZam1KYY3TG"</span><span class="token punctuation">,</span>
      <span class="token property">"api"</span><span class="token operator">:</span> <span class="token string">"S3v4"</span><span class="token punctuation">,</span>
      <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"auto"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"s3"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://s3.amazonaws.com"</span><span class="token punctuation">,</span>
      <span class="token property">"accessKey"</span><span class="token operator">:</span> <span class="token string">"YOUR-ACCESS-KEY-HERE"</span><span class="token punctuation">,</span>
      <span class="token property">"secretKey"</span><span class="token operator">:</span> <span class="token string">"YOUR-SECRET-KEY-HERE"</span><span class="token punctuation">,</span>
      <span class="token property">"api"</span><span class="token operator">:</span> <span class="token string">"S3v4"</span><span class="token punctuation">,</span>
      <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"dns"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="配置对象外部访问"><a href="#配置对象外部访问" class="headerlink" title="配置对象外部访问"></a>配置对象外部访问</h1><p>这时候还不能通过外部访问到图片，如果输入<code>http://localhost:9000/testpic/avatar.png</code>会提示输入账号密码。<br>添加外部访问策略如下</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">mc</span> policy <span class="token builtin class-name">set</span> public minio/testpic<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>添加成功之后即可实现外部访问图片。</p>
]]></content>
      <categories>
        <category>开发</category>
        <category>对象存储</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>minio</tag>
      </tags>
  </entry>
  <entry>
    <title>使用puppeteer实现自动登录和测试页面</title>
    <url>/%E5%BC%80%E5%8F%91/%E6%B5%8B%E8%AF%95/%E4%BD%BF%E7%94%A8puppeteer%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%8A%A8%E7%99%BB%E5%BD%95%E5%92%8C%E6%B5%8B%E8%AF%95%E9%A1%B5%E9%9D%A2/</url>
    <content><![CDATA[<p>近日需要用到自动登录的方式，于是找来了流行的 puppeteer 实现自动登录并测试页面，现记录一下实现的方式。</p>
<span id="more"></span>

<h1 id="获取-Browser-实例"><a href="#获取-Browser-实例" class="headerlink" title="获取 Browser 实例"></a>获取 Browser 实例</h1><p>关于 puppeteer 的文档可以查看<span class="exturl" data-url="aHR0cHM6Ly96aGFvcWl6ZS5naXRodWIuaW8vcHVwcGV0ZWVyLWFwaS16aF9DTi8=">Puppeteer<i class="fa fa-external-link-alt"></i></span><br>首先引入 puppeteer 库，这里我们选择的是 puppeteer 而不是 puppeteer-core，简单是说区别就是</p>
<ol>
<li>puppeteer-core 不会自动下载 Chromium</li>
<li>puppeteer-core 会忽略 PUPPETEER_*环境变量</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> browser <span class="token operator">=</span> <span class="token keyword">await</span> puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  headless<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  args<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"--start-maximized"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  ignoreDefaultArgs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"--enable-automation"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  defaultViewport<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>参数解释：</p>
<ul>
<li><code>headless: false</code><br>为了更好的看到现象，采用的非 headless，默认情况 headless 是 true</li>
<li><code>args: [&quot;--start-maximized&quot;]</code>内容铺满视频框。</li>
<li><code>ignoreDefaultArgs: [&quot;--enable-automation&quot;]</code>不显示测试环境控制的提示。</li>
<li><code>defaultViewport: null</code> 视口大小设置为全屏，默认是 800X600 的框。</li>
</ul>
<p>更多参数可参考<span class="exturl" data-url="aHR0cHM6Ly9wZXRlci5zaC9leHBlcmltZW50cy9jaHJvbWl1bS1jb21tYW5kLWxpbmUtc3dpdGNoZXMv">List Of Chromium Command Line Switches<i class="fa fa-external-link-alt"></i></span></p>
<p>这里是用 launch 的方式创建的 Browser 实例，也可以用 connect 方式</p>
<ul>
<li>puppeteer.connect: 连接一个已经开启浏览器 websoket 链接的 Chrome 实例</li>
<li>puppeteer.launch: 每次都启动一个 Chrome 实例</li>
</ul>
<p>connect 方式需要以 <code>remote-debugging-port</code> 参数启动 Chrome，具体参数参照<span class="exturl" data-url="aHR0cHM6Ly9jaHJvbWVkZXZ0b29scy5naXRodWIuaW8vZGV2dG9vbHMtcHJvdG9jb2wvI2hvdy1kby1pLWFjY2Vzcy10aGUtYnJvd3Nlci10YXJnZXQ=">Chrome DevTools Protocol<i class="fa fa-external-link-alt"></i></span></p>
<ol>
<li><p>以 <code>remote-debugging-port</code> 参数启动 Chrome</p>
<img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20201202165028.png" style="zoom:50%" /></li>
<li><p>通过<code>http://$&#123;host&#125;:$&#123;port&#125;/json/version</code>获取到浏览器的一些信息。其中有 webSocketDebuggerUrl<br><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20201202165029.png" alt="查看Chrome信息"></p>
</li>
<li><p>实现连接</p>
</li>
</ol>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">puppeteer<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  browserWSEndpoint<span class="token operator">:</span> webSocketDebuggerUrl<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h1 id="测试自动登录"><a href="#测试自动登录" class="headerlink" title="测试自动登录"></a>测试自动登录</h1><p>由于我们项目采用了验证码，一般情况下有验证码的自动登录比较麻烦，如果验证码复杂的话需要借助验证码识别平台来做，如果用程序来破解涉及到灰度化，二值化，去除噪点，字符分割，训练模型，识别等等一系列的东西，用 OCR 识别等。这里我们就采用简单的方式来做，在申请验证码的时候接口返回了验证码的 base64 字符，我们获取到这个字符来解码。</p>
<p>代码如下</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> bPage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">pages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> bPage<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">"http://ip:port/projectName/pages/login.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> finalResponse <span class="token operator">=</span> <span class="token keyword">await</span> bPage<span class="token punctuation">.</span><span class="token function">waitForResponse</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=></span>
    response<span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"http://ip:port/projectName/getVerify"</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> finalResponse<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> codeStr <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token string">"base64"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> bPage<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"input[name=code]"</span><span class="token punctuation">,</span> codeStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> bPage<span class="token punctuation">.</span><span class="token function">waitForSelector</span><span class="token punctuation">(</span><span class="token string">"input[name=userName]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> bPage<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"input[name=userName]"</span><span class="token punctuation">,</span> <span class="token string">"xxxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> bPage<span class="token punctuation">.</span><span class="token function">waitForSelector</span><span class="token punctuation">(</span><span class="token string">"input[name=password]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> bPage<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">"input[name=password]"</span><span class="token punctuation">,</span> <span class="token string">"xxxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> bPage<span class="token punctuation">.</span><span class="token function">waitForSelector</span><span class="token punctuation">(</span><span class="token string">"input[name=code]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>responseStr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  bPage<span class="token punctuation">.</span><span class="token function">waitForNavigation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  bPage<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token string">"button[lay-submit]"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="测试按键"><a href="#测试按键" class="headerlink" title="测试按键"></a>测试按键</h1><p>我们前端项目是在 TV 端，需要使用按键来测试页面。这里我们测试了之后保存页面的截图。<br>需要注意的是由于 js 在页面加载之后执行，这里做了一个延时 2s 的操作，具体的按键名称可以在 puppeteer 仓库中搜索<code>Keyboard</code>查找到<code>USKeyboardLayout.ts</code>，里面有详细按键名称。</p>
<p>代码如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> fPage <span class="token operator">=</span> <span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> fPage<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">"http://ip:port/projectName/page/index.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> fPage<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> fPage<span class="token punctuation">.</span>keyboard<span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span><span class="token string">"ArrowRight"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> fPage<span class="token punctuation">.</span>keyboard<span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span><span class="token string">"ArrowRight"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> fPage<span class="token punctuation">.</span>keyboard<span class="token punctuation">.</span><span class="token function">down</span><span class="token punctuation">(</span><span class="token string">"Enter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> fPage<span class="token punctuation">.</span><span class="token function">screenshot</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> path<span class="token operator">:</span> <span class="token string">"screenshot.png"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> fPage<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
]]></content>
      <categories>
        <category>开发</category>
        <category>测试</category>
      </categories>
      <tags>
        <tag>puppeteer</tag>
      </tags>
  </entry>
  <entry>
    <title>搭建简易流媒体服务器</title>
    <url>/%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/%E6%90%AD%E5%BB%BA%E7%AE%80%E6%98%93%E6%B5%81%E5%AA%92%E4%BD%93%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
    <content><![CDATA[<p>搭建流媒体服务器主要有三个部分，服务端+推流端+拉流端</p>
<ul>
<li><p>服务端：srs、nginx-rtmp</p>
</li>
<li><p>推流端：obs-studio、ffmpeg</p>
</li>
<li><p>拉流端：vlc 或者其他播放器</p>
</li>
</ul>
<p>这里我们基于 srs+obs-studio/ffmpeg+vlc 实现搭建流媒体服务器，srs 与 nginx 以及其他流媒体服务端对比可以<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29zc3JzL3Nycy93aWtpL3YxX0NOX0NvbXBhcmU=">查看<i class="fa fa-external-link-alt"></i></span></p>
<span id="more"></span>

<h1 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h1><p>SRS(Simple Realtime Server)是一个简单高效的实时视频服务器，支持 RTMP/WebRTC/HLS/HTTP-FLV/SRT/GB28181。<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29zc3JzL3Nycw==">开源地址<i class="fa fa-external-link-alt"></i></span>，这里我们使用 3.0 的版本，v4 版本新增<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29zc3JzL3Nycy93aWtpL3Y0X0NOX1dlYlJUQyNjb25maWctY2FuZGlkYXRl">webrtc<i class="fa fa-external-link-alt"></i></span>，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29zc3JzL3Nycy93aWtpL3YzX0NOX0hvbWU=">文档地址<i class="fa fa-external-link-alt"></i></span>，以 docker 的方式简易安装。<span class="exturl" data-url="aHR0cHM6Ly9vc3Nycy5uZXQv">官网地址<i class="fa fa-external-link-alt"></i></span>，RTMP 默认端口是 1935</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ docker run -p <span class="token number">1935</span>:1935 -p <span class="token number">1985</span>:1985 -p <span class="token number">8080</span>:8080 --name<span class="token operator">=</span>srs ossrs/srs:3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>启动之后打开<code>http://192.168.8.123:8080/</code>，可以看到 SRS 已经启动成功</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210508155727.png" alt="SRS"></p>
<ul>
<li>若希望做低延迟直播（3-5 秒），可用 HTTP-FLV，播放器用<span class="exturl" data-url="aHR0cDovL2JpbGliaWxpLmdpdGh1Yi5pby9mbHYuanMvZGVtbw==">flv.js<i class="fa fa-external-link-alt"></i></span>，H5/MSE 播放 HTTP-FLV</li>
<li>若对延迟不敏感（5-10 秒），跨平台比较好，可用 HLS，播放器用<span class="exturl" data-url="aHR0cHM6Ly9obHMtanMubmV0bGlmeS5jb20vZGVtbw==">hls.js<i class="fa fa-external-link-alt"></i></span>，H5/MSE 播放 HLS</li>
<li>若希望超低延迟（1 秒内），只需要支持主流的浏览器，可用 WebRTC，播放器用<span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguOC4xMjM6ODA4MC9wbGF5ZXJzL3J0Y19wbGF5ZXIuaHRtbA==">RTC 播放器<i class="fa fa-external-link-alt"></i></span></li>
</ul>
<blockquote>
<p>如果想要自己编译，代码如下：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">git</span> clone -b <span class="token number">3</span>.0release https://gitee.com/ossrs/srs.git <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> srs/trunk <span class="token operator">&amp;&amp;</span> ./configure <span class="token operator">&amp;&amp;</span> <span class="token function">make</span> <span class="token operator">&amp;&amp;</span> ./objs/srs -c conf/srs.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>其中配置文件为<code>conf/srs.conf</code>，日志为<code>./objs/srs.log</code></p>
</blockquote>
<h1 id="推流端"><a href="#推流端" class="headerlink" title="推流端"></a>推流端</h1><h2 id="OBS-Studio"><a href="#OBS-Studio" class="headerlink" title="OBS Studio"></a>OBS Studio</h2><p>OBS Studio 是一个直播录制软件，应用广泛，开源免费，<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL29ic3Byb2plY3Qvb2JzLXN0dWRpby9yZWxlYXNlcw==">开源下载地址<i class="fa fa-external-link-alt"></i></span>，<span class="exturl" data-url="aHR0cHM6Ly9vYnNwcm9qZWN0LmNvbS8=">官网下载地址<i class="fa fa-external-link-alt"></i></span></p>
<p>选择适合自己系统的安装包，下载完成之后安装。</p>
<p>点击左下角“来源”的“+”号，选择媒体源</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210508160224.png" alt="选择来源"></p>
<p>这里我们选择一个本地的视频文件播放</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210508160458.png" alt="选择文件"></p>
<p>点击右下角设置—&gt;推流，填入我们的服务器地址<code>rtmp://192.168.8.123:1935/live</code>，串流密钥（即自定义的流名称）<code>livestream</code></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210508161121.png" alt="设置推流"></p>
<p>设置完成之后点击右下角“开始推流”，在 docker 控制台能看到打印的信息。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210508164251.png" alt="docker打印信息"></p>
<h2 id="FFmpeg"><a href="#FFmpeg" class="headerlink" title="FFmpeg"></a>FFmpeg</h2><p>如果需要用 ffmpeg 推流的话，在前面的 container(名称为 srs)里面已经有 ffmpeg，我们进入 srs 的控制台:</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker <span class="token builtin class-name">exec</span> -it srs <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在目录<code>/usr/local/srs/</code>下新建一个文件夹 doc</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">mkdir</span> doc<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>新建一个终端，本机环境我们先切换到本机需要拷贝的目录，再拷贝文件到容器：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ docker <span class="token function">cp</span> test.mp4 srs:/usr/local/srs/doc/test.mp4<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>到 srs 容器的 shell 中，先切换到 ffmpeg 命令目录，再推 rtmp 流到 srs：</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token builtin class-name">cd</span> /usr/local/srs/objs/ffmpeg/bin
$ ./ffmpeg -re -i /usr/local/srs/doc/test.mp4 -c copy -f flv -y rtmp://localhost/live/livestream<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210628192204.png" alt="rtmp推流"></p>
<p>切换到 hls 的目录下面能看到切片好的文件</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token builtin class-name">cd</span> /usr/local/srs/objs/nginx/html/live<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>注意：如果使用 ffmpeg 推 rtmp 流，这里的输出格式指定为 flv，即<code>-f flv</code></strong></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210628192404.png" alt="切片的ts文件"></p>
<h1 id="拉流端"><a href="#拉流端" class="headerlink" title="拉流端"></a>拉流端</h1><p>打开 VLC 播放器，选择媒体–&gt;打开网络串流。输入地址</p>
<ul>
<li>RTMP 地址<code>rtmp://192.168.8.123:1935/live/livestream</code></li>
<li>H5(HTTP-FLV)地址<code>http://192.168.8.123:8080/live/livestream.flv</code></li>
<li>H5(HLS)地址<code>http://192.168.8.123:8080/live/livestream.m3u8</code></li>
</ul>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210508164643.png" alt="VLC播放"></p>
<p>H5 的地址也可以用本地在线的 SRS 播放器<code>http://192.168.8.123:8080/players/srs_player.html</code></p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210628192547.png" alt="srs播放器"></p>
<p>如果需要采集摄像头的话，在 obs-studio 的左下角”来源”选择”视频采集设备”即可。</p>
]]></content>
      <categories>
        <category>搭建教程</category>
      </categories>
      <tags>
        <tag>srs</tag>
        <tag>live</tag>
      </tags>
  </entry>
  <entry>
    <title>数据可视化工具选型参考</title>
    <url>/%E5%BC%80%E5%8F%91/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96/%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7%E9%80%89%E5%9E%8B%E5%8F%82%E8%80%83/</url>
    <content><![CDATA[<p>本文主要对比现在的一些可视化工具方便技术选型。</p>
<span id="more"></span>

<h1 id="数据可视化工具"><a href="#数据可视化工具" class="headerlink" title="数据可视化工具"></a>数据可视化工具</h1><ul>
<li>Leaflet|28.9K|适合移动设备</li>
<li>Chartist.js|12.3K|创建响应式图表</li>
<li>d3|93.6K|svg+canvas+html</li>
<li>Plotly|12.2K|使用该工具通过上传 CSV 文件或连接到 SQL 数据库来创建 D3.js 图表和地图</li>
</ul>
<h1 id="纯可视化图表生成类"><a href="#纯可视化图表生成类" class="headerlink" title="纯可视化图表生成类"></a>纯可视化图表生成类</h1><ul>
<li>Echarts|42.8K|百度产品</li>
<li>AntV|蚂蚁金服</li>
<li>Highcharts|9.7K|可视化库，商用付费</li>
</ul>
<h1 id="可视化报表类"><a href="#可视化报表类" class="headerlink" title="可视化报表类"></a>可视化报表类</h1><ul>
<li>FineReport|报表软件，企业级应用，工作用小屏，决策用大屏。办公用微软，经营用帆软。</li>
</ul>
<h1 id="商业智能分析"><a href="#商业智能分析" class="headerlink" title="商业智能分析"></a>商业智能分析</h1><ul>
<li>Tableau|内置常用的分析图表，和一些数据分析模型</li>
<li>FineBI|内置丰富图表，不需要代码调用，可直接拖拽生成。可用于业务数据的快速分析，制作 dashboard，也可构建可视化大屏。</li>
<li>PowerBI|继 Excel 之后推出的 BI 产品，可以和 Excel 无缝连接使用，创建个性化的数据看板。</li>
</ul>
<h1 id="可视化大屏类"><a href="#可视化大屏类" class="headerlink" title="可视化大屏类"></a>可视化大屏类</h1><ul>
<li>DataV|主要用于业务数据与地理信息融合的大数据可视化,通过简单的拖拽配置就能生成可视化大屏或者仪表盘.</li>
<li>FineReport</li>
<li>数字冰雹</li>
</ul>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><ul>
<li>Chart.js|50.2K|Simple HTML5 Charts using the <code>&lt;canvas&gt;</code> tag</li>
<li>recharts|14.7K|Redefined chart library built with React and D3</li>
<li>charts|13.5K|Simple, responsive, modern SVG Charts with zero dependencies</li>
<li>dashboards|10.8K|Responsive dashboard templates 📊✨</li>
<li>G2|10K|📊 A highly interactive data-driven visualization grammar for statistical charts.</li>
<li>ZRender|4.5K|二维绘图引擎，它提供 Canvas、SVG、VML 等多种渲染方式。ZRender 也是 ECharts 的渲染器。</li>
</ul>
<hr>
<p>选型对比</p>
<blockquote>
<p>商业：阿里 DataV|腾讯云图|百度 Sugar</p>
<p>开发：Echarts|AntV|D3</p>
</blockquote>
<p>echarts 缺失灵活性的同时，带来的是使用上的便利。社区 echarts &gt; antv</p>
<hr>
<h2 id="WebGL"><a href="#WebGL" class="headerlink" title="WebGL"></a>WebGL</h2><p>一种 3D 绘图协议，这种绘图技术标准允许把 JavaScript 和 OpenGL ES 2.0 结合在一起，通过增加 OpenGL ES 2.0 的一个 JavaScript 绑定，WebGL 可以为 HTML5 Canvas 提供硬件 3D 加速渲染，这样 Web 开发人员就可以借助系统显卡来在浏览器里更流畅地展示 3D 场景和模型了，还能创建复杂的导航和数据视觉化。</p>
<h2 id="Three-js"><a href="#Three-js" class="headerlink" title="Three.js"></a>Three.js</h2><p>一款运行在浏览器中的 3D 引擎，你可以用它创建各种三维场景，包括了摄影机、光影、材质等各种对象。</p>
<h2 id="Unity"><a href="#Unity" class="headerlink" title="Unity"></a>Unity</h2><p>游戏引擎开发商，实时 3D 互动内容创作和运营平台。包括游戏开发、美术、建筑、汽车设计、影视制作在内的创作者运用 Unity 实现。</p>
]]></content>
      <categories>
        <category>开发</category>
        <category>数据可视化</category>
      </categories>
      <tags>
        <tag>数据可视化</tag>
      </tags>
  </entry>
  <entry>
    <title>回车换行问题</title>
    <url>/Bug%E8%A7%A3%E5%86%B3/Git/%E5%9B%9E%E8%BD%A6%E6%8D%A2%E8%A1%8C%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>记录一次换行符引发的问题。</p>
<span id="more"></span>

<h1 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h1><p>使用 git 提交的时候报错提示如下：<br>warning: LF will be replaced by CRLF in js/utils.js.<br>The file will have its original line endings in your working directory</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><ul>
<li>CR (Carriage Return) 回车</li>
<li>LR (Line Feed) 换行</li>
<li>CRLF (Carriage Return Line Feed) 回车换行</li>
</ul>
<p>早期的 MAC 系统使用 CR 进行换行，现在统一成 LF，Uninx 系统都是使用的 LF 换行，而 Windows 系统使用的 CRLF 当作换行。所以在多人协同开发的时候会造成兼容性问题。</p>
<h2 id="core-autocrlf"><a href="#core-autocrlf" class="headerlink" title="core.autocrlf"></a>core.autocrlf</h2><p>git 提供了一个<code>core.autocrlf</code>的配置，可以自动完成换行的转换，详见<span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS9kb2NzL2dpdC1jb25maWc=">git-config<i class="fa fa-external-link-alt"></i></span></p>
<ul>
<li>true<br>自动完成转换，在 push 的时候自动将换行符从 CRLF 换成 LF，在 pull 的时候将 LF 换成 CRLF。</li>
<li>input<br>push 转换，pull 不转换</li>
<li>false<br>都不转换</li>
</ul>
<p>这里设置全局<code>--global</code> 里的 <code>core.autocrlf</code> 为 false。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ <span class="token function">git</span> config --global core.autocrlf <span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这样设置之后有些可能有 LF 和 CRLF 混乱的问题，即出现 CRLF 和 LF 共同出现的情况。</p>
<h2 id="gitattributes"><a href="#gitattributes" class="headerlink" title=".gitattributes"></a>.gitattributes</h2><p>git 提供一个<code>.gitattributes</code>文件用于配置该项目一些属性配置，详见<span class="exturl" data-url="aHR0cHM6Ly9naXQtc2NtLmNvbS9kb2NzL2dpdGF0dHJpYnV0ZXM=">gitattributes<i class="fa fa-external-link-alt"></i></span></p>
<p>每行的格式为<code>pattern attr1 attr2 ...</code><br>pattern 配置</p>
<pre class="line-numbers language-none"><code class="language-none">* 匹配所有文件
*.txt 匹配所有 txt 文件<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="text"><a href="#text" class="headerlink" title="text"></a>text</h3><p>其中 text 属性可以启用并控制行尾规范化</p>
<ul>
<li>text<br>在路径上设置属性可启用行尾规范化并将路径标记为文本文件。行尾转换不会猜测内容类型。</li>
<li>-text<br>Git 在签入或签出时不要尝试任何行尾转换。</li>
<li>auto<br>标记该路径以进行自动行尾转换。如果 Git 决定内容为文本，则其行尾在签入时转换为 LF。使用 CRLF 提交文件后，不会进行任何转换。</li>
<li>未指定<br>如果 text 未指定该属性，则 Git 使用 core.autocrlf 配置变量来确定是否应转换文件。</li>
</ul>
<h3 id="eol"><a href="#eol" class="headerlink" title="eol"></a>eol</h3><p>属性设置在工作目录中使用的特定行尾样式。</p>
<ul>
<li>crlf<br>此设置强制 Git 在签入时对此文件的行尾进行规范化，并在签出文件时将其转换为 CRLF。</li>
<li>lf<br>此设置强制 Git 在签入时将行尾标准化为 LF，并在签出文件时阻止转换为 CRLF。</li>
</ul>
<p>可设置如下</p>
<pre class="line-numbers language-none"><code class="language-none">* text eol&#x3D;lf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="editorconfig"><a href="#editorconfig" class="headerlink" title="editorconfig"></a>editorconfig</h2><p>也可以设置一个 <span class="exturl" data-url="aHR0cHM6Ly9lZGl0b3Jjb25maWcub3JnLw==">editorconfig<i class="fa fa-external-link-alt"></i></span> 来解决行尾转换的问题。这样在保存的时候自动规范化文件的内容。<br>editorconfig 的配置如下：</p>
<pre class="line-numbers language-none"><code class="language-none">end_of_line &#x3D; lf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
]]></content>
      <categories>
        <category>Bug解决</category>
        <category>Git</category>
      </categories>
      <tags>
        <tag>autocrlf</tag>
        <tag>crlf</tag>
        <tag>lf</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库字符集不匹配</title>
    <url>/Bug%E8%A7%A3%E5%86%B3/Database/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%97%E7%AC%A6%E9%9B%86%E4%B8%8D%E5%8C%B9%E9%85%8D/</url>
    <content><![CDATA[<h1 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h1><p>开发中遇到一个数据库字符集的问题 Caused by: java.sql.SQLException: Illegal mix of collations (latin1_swedish_ci,IMPLICIT) and (utf8_general_ci,COERCIBLE) for operation ‘=’</p>
<span id="more"></span>

<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>设置数据库的字符集为 utf-8</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">ALTER table action CONVERT TO CHARACTER SET utf8<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
]]></content>
      <categories>
        <category>Bug解决</category>
        <category>Database</category>
      </categories>
      <tags>
        <tag>database</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库连接报错</title>
    <url>/Bug%E8%A7%A3%E5%86%B3/Database/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5%E6%8A%A5%E9%94%99/</url>
    <content><![CDATA[<h1 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h1><p>使用mysql包连接数据库的时候报错：<code>Client does not support authentication protocol requested by server; consider upgrading MySQL client</code></p>
<span id="more"></span>

<p>进入数据库</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ mysql -u root -p<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看数据库版本</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">select version();<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>mysql8 之前的版本中加密规则是mysql_native_password,而在mysql8之后,加密规则是caching_sha2_password</strong></p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>参考<span class="exturl" data-url="aHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvNTAwOTMxNDQvbXlzcWwtOC0wLWNsaWVudC1kb2VzLW5vdC1zdXBwb3J0LWF1dGhlbnRpY2F0aW9uLXByb3RvY29sLXJlcXVlc3RlZC1ieS1zZXJ2ZXI=">解决方法<i class="fa fa-external-link-alt"></i></span></p>
<p>进入数据库之后修改加密规则，其中<code>123456</code>为数据库的登录密码。</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED WITH mysql_native_password BY &#39;123456&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>刷新权限</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">FLUSH PRIVILEGES;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查看表中信息是否生效</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">use mysql;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">select user,host,plugin from user where user&#x3D;&#39;root&#39;;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210719191852.png" alt="查看权限"></p>
<blockquote>
<p>如果仍然报错，可以去掉<code>@&#39;localhost&#39;</code>再试下</p>
</blockquote>
]]></content>
      <categories>
        <category>Bug解决</category>
        <category>Database</category>
      </categories>
      <tags>
        <tag>database</tag>
      </tags>
  </entry>
  <entry>
    <title>文档在线预览</title>
    <url>/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/%E6%96%87%E6%A1%A3%E5%9C%A8%E7%BA%BF%E9%A2%84%E8%A7%88/</url>
    <content><![CDATA[<p>项目上需要在线预览 office 文件，项目为外面是 Android webview 壳子，里面为前端 H5 页面，在网上搜集了一些在线预览 office 的解决方式，整理出来。</p>
<span id="more"></span>

<h1 id="网上资源"><a href="#网上资源" class="headerlink" title="网上资源"></a>网上资源</h1><ol>
<li>微软提供的在线预览，地址为<code>https://view.officeapps.live.com/op/embed.aspx?src=外网office文件地址</code>。</li>
<li>百度文库、金山 WPS 都提供收费在线预览，或者业内付费产品有<span class="exturl" data-url="aHR0cDovL3d3dy55b3pvZGNzLmNvbS8=">永中 office<i class="fa fa-external-link-alt"></i></span>、<span class="exturl" data-url="aHR0cDovL3d3dy5vZmZpY2V3ZWIzNjUuY29tLw==">office365<i class="fa fa-external-link-alt"></i></span>、<span class="exturl" data-url="aHR0cHM6Ly93d3cuaWRvY3YuY29tLw==">idocv<i class="fa fa-external-link-alt"></i></span></li>
<li>通过隐式 intent 调用手机中的文档处理相关的 app</li>
<li>更换 webview 为腾讯 X5 内核，但不支持在线预览</li>
<li>office web apps 需要 windows 服务器，已更名为 office online</li>
<li>file-online-preview 基于 springboot 实现，已改名为 kkFileView</li>
<li>openoffice/Aspose</li>
</ol>
<h1 id="自己编写"><a href="#自己编写" class="headerlink" title="自己编写"></a>自己编写</h1><p>如果要自己编写的话，在前端这块</p>
<ul>
<li>excel 可以用 sheetjs</li>
<li>word 可以用 mammoth.js</li>
<li>pdf 可以用 pdf.js</li>
</ul>
<p>最后项目采用的开源的 <strong>kkFileView</strong></p>
]]></content>
      <categories>
        <category>工作笔记</category>
      </categories>
      <tags>
        <tag>office</tag>
        <tag>preview</tag>
      </tags>
  </entry>
  <entry>
    <title>elasticsearch未授权访问问题解决</title>
    <url>/Bug%E8%A7%A3%E5%86%B3/Elasticsearch/elasticsearch%E6%9C%AA%E6%8E%88%E6%9D%83%E8%AE%BF%E9%97%AE%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/</url>
    <content><![CDATA[<p>近日有扫描发现 elasticsearch 出现未授权访问的问题，这里记录一下解决过程。</p>
<span id="more"></span>

<h1 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h1><p>扫描方通过<code>elasticsearch head</code>进入 web 页面，连接到 elasticsearch 的服务器，能查看到 es 的相关信息。</p>
<h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>先分析一下现象产生，elasticsearch 安装之后又安装了<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21vYnovZWxhc3RpY3NlYXJjaC1oZWFk">elasticsearch head<i class="fa fa-external-link-alt"></i></span>以便于查看 elasticsearch 的信息。<code>elasticsearch head</code>默认在<code>9100</code>端口。</p>
<h2 id="关闭-elasticsearch-head-可选"><a href="#关闭-elasticsearch-head-可选" class="headerlink" title="关闭 elasticsearch head(可选)"></a>关闭 elasticsearch head(可选)</h2><p>查找<code>elasticsearch head</code>进程，我们在<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21vYnovZWxhc3RpY3NlYXJjaC1oZWFkL2Jsb2IvbWFzdGVyL3BhY2thZ2UuanNvbg==">文档<i class="fa fa-external-link-alt"></i></span>中可以看到<code>elasticsearch head</code>是以 grunt 的方式启动的。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ ps -ef|grep grunt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查找到相关进程，再 kill 掉。也关闭跨域，只允许 elasticsearch 本机访问，在<code>elasticsearch.yml</code>中设置<code>http.cors.enabled: false</code>。</p>
<h2 id="增加-elasticsearch-自身安全认证"><a href="#增加-elasticsearch-自身安全认证" class="headerlink" title="增加 elasticsearch 自身安全认证"></a>增加 elasticsearch 自身安全认证</h2><p>我们可以通过增加 elasticsearch 的自身安全设置来避免未授权访问，es 版本这里是 6.x，有以下几种方式：</p>
<ol>
<li>使用官方推荐的 shield 插件(收费)</li>
<li>使用<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FzcXVlcmEvZWxhc3RpY3NlYXJjaC1odHRwLWJhc2lj">elasticsearch-http-basic<i class="fa fa-external-link-alt"></i></span>，<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnNlYXJjaC1ndWFyZC5jb20v">searchguard 插件<i class="fa fa-external-link-alt"></i></span>(免费)</li>
<li>架设 nginx 反向代理服务器，并设置<code>http basic</code>认证来实现 elasticsearch 的登录认证。</li>
</ol>
<p>这里 shield 插件收费的先排除了，<code>elasticsearch-http-basic</code>的话是有<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FzcXVlcmEvZWxhc3RpY3NlYXJjaC1odHRwLWJhc2ljI3ZlcnNpb24tbWFwcGluZw==">版本限制<i class="fa fa-external-link-alt"></i></span>，而且 github 上面已经不维护了。</p>
<table>
<thead>
<tr>
<th>Http Basic Plugin</th>
<th>elasticsearch</th>
</tr>
</thead>
<tbody><tr>
<td>v1.5.1(master)</td>
<td>1.5.1, 1.5.2, 1.6.0, 1.7.0</td>
</tr>
<tr>
<td>v1.5.0</td>
<td>1.5.0</td>
</tr>
<tr>
<td>v1.4.0</td>
<td>1.4.0</td>
</tr>
<tr>
<td>v1.3.0</td>
<td>1.3.0</td>
</tr>
<tr>
<td>v1.2.0</td>
<td>1.2.0</td>
</tr>
<tr>
<td>1.1.0</td>
<td>1.0.0</td>
</tr>
<tr>
<td>1.0.4</td>
<td>0.90.7</td>
</tr>
</tbody></table>
<p>searchguard 配置有一点繁琐。这里我们选用第三种，Nginx 做反向代理的方式。</p>
<p>在 location 配置下面增加以下：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">/</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">#关键点，配置帐号密码</span>
    <span class="token keyword">auth_basic</span> <span class="token string">"login"</span><span class="token punctuation">;</span> <span class="token comment">#提示信息</span>
    <span class="token keyword">auth_basic_user_file</span> <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token operator">/</span>vhosts<span class="token operator">/</span>password<span class="token operator">/</span>es<span class="token punctuation">;</span> <span class="token comment">#密码文件</span>
    <span class="token keyword">autoindex</span> on<span class="token punctuation">;</span>
    <span class="token comment">#配置转发等</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里密码文件通过<span class="exturl" data-url="aHR0cHM6Ly90b29sLm9zY2hpbmEubmV0L2h0cGFzc3dk">htpasswd<i class="fa fa-external-link-alt"></i></span>来生成就可以。</p>
<p>然后修改 elasticsearch.yml 里的<code>network.host: 127.0.0.1</code>，如果不在同一个机器上就将<code>network.host</code>选项设置为 nginx 服务器的 ip 就可以了。</p>
<p>然后我们访问 elasticsearch 的时候就需要输入用户名密码了。</p>
]]></content>
      <categories>
        <category>Bug解决</category>
        <category>Elasticsearch</category>
      </categories>
      <tags>
        <tag>elasticsearch</tag>
      </tags>
  </entry>
  <entry>
    <title>chatbot搭建-闲聊机器人</title>
    <url>/%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/chatbot%E6%90%AD%E5%BB%BA-%E9%97%B2%E8%81%8A%E6%9C%BA%E5%99%A8%E4%BA%BA/</url>
    <content><![CDATA[<p>想要随时秒回信息？想要聊天打发时间？那你可能需要一个闲聊的机器人，这里我们来搭建一个简单的闲聊机器人。</p>
<span id="more"></span>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>目前来说微信可能是我们平台聊天最常见的工具了，我们这里想要实现一个微信的自动聊天回复，这里我们在 github 上查找了相关的项目，有一个 star 比较多的<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xpdHRsZWNvZGVyc2gvSXRDaGF0">ItChat<i class="fa fa-external-link-alt"></i></span>，是一个开源的微信个人号接口，使用的 Python。不过由于后来微信改了 web 方式，目前用 web 不能直接登录，ItChat 就一直没有更新，最近更新是在大约三年前了。</p>
<p>这里我找到另外一个 wechat 接口的项目<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlY2hhdHkvd2VjaGF0eQ==">wechaty<i class="fa fa-external-link-alt"></i></span>，可以绕开 web 协议，采用的 ipad 的协议来做，不过需要提供 token，这里可以<span class="exturl" data-url="aHR0cHM6Ly93ZWNoYXR5LmpzLm9yZy9kb2NzL3B1cHBldC1zZXJ2aWNlcy8=">查看<i class="fa fa-external-link-alt"></i></span>，有短期的 token，需要发文章获得，加入开发者提供 PR 的话可以拥有一个长期的 token，如果不想这么麻烦，也可以直接购买 token。</p>
<p>最近有大佬发现 UOS 下微信桌面版协议可以实现登录，无疑是将 web 版的微信盘活了，见<span class="exturl" data-url="aHR0cHM6Ly93ZWNoYXR5LmpzLm9yZy8yMDIxLzA0LzEzL3dlY2hhdHktdW9zLXdlYi8=">重磅：使用 UOS 微信桌面版协议登录，wechaty 免费版 web 协议重放荣光<i class="fa fa-external-link-alt"></i></span>，主要在请求头加上两个参数 extspam 和 client-version。见<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3dlY2hhdHkvd2VjaGF0eS1wdXBwZXQtd2VjaGF0L2lzc3Vlcy8xMjc=">issues<i class="fa fa-external-link-alt"></i></span></p>
<p>有插件也可以实现，见<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FkYW15aS93ZWNocm9tZQ==">插件<i class="fa fa-external-link-alt"></i></span>，这里有一点不太好就是 token 是硬编码了，token 生成见<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0JsdWVTa3ktMDcvd2VjaGF0LXRva2Vu">wechat-token<i class="fa fa-external-link-alt"></i></span>。</p>
<p>这里我们根据<span class="exturl" data-url="aHR0cHM6Ly93ZWNoYXR5LmpzLm9yZy9kb2NzLw==">官方文档<i class="fa fa-external-link-alt"></i></span>，里面有很多例子。</p>
<h1 id="建立一个-bot"><a href="#建立一个-bot" class="headerlink" title="建立一个 bot"></a>建立一个 bot</h1><p>新建一个 bot</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ mkdir testwechaty
$ cd testwechaty
$ npm init -y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>主要这里主要添加三个包，这里的 puppet 我们就用<code>wechaty-puppet-wechat</code></p>
<ul>
<li>wechaty</li>
<li>qrcode-terminal</li>
<li>wechat-puppet-wechat</li>
</ul>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ yarn add wechaty qrcode-terminal wechat-puppet-wechat<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>方便调试这里再加一个 nodemen，文件改变就自动更新</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ yarn add -D nodemon<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在项目根目录下新建 index.js，直接贴代码如下：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> Wechaty <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"wechaty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Qrterminal <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"qrcode-terminal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">"wechat-puppet-wechat"</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> bot <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Wechaty</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  name<span class="token punctuation">,</span> <span class="token comment">// generate xxxx.memory-card.json and save login data for the next login</span>
  puppet<span class="token operator">:</span> <span class="token string">"wechaty-puppet-wechat"</span><span class="token punctuation">,</span> <span class="token comment">//默认就是wechaty-puppet-wechat</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//二维码生成</span>
<span class="token keyword">function</span> <span class="token function">onScan</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Scan QR Code to login: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>code<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>url<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Qrterminal<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> small<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//登录</span>
<span class="token keyword">function</span> <span class="token function">onLogin</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">贴心小助理</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>user<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">登录了</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//消息</span>
<span class="token keyword">function</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//登出</span>
<span class="token keyword">function</span> <span class="token function">onLogout</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">小助手</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>user<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">已经登出</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//出错</span>
<span class="token keyword">function</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

bot<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"scan"</span><span class="token punctuation">,</span> onScan<span class="token punctuation">)</span><span class="token punctuation">;</span>
bot<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"login"</span><span class="token punctuation">,</span> onLogin<span class="token punctuation">)</span><span class="token punctuation">;</span>
bot<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"logout"</span><span class="token punctuation">,</span> onLogout<span class="token punctuation">)</span><span class="token punctuation">;</span>
bot<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> onMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
bot<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">"error"</span><span class="token punctuation">,</span> onError<span class="token punctuation">)</span><span class="token punctuation">;</span>
bot
  <span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"开始登陆微信"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在<code>package.json</code>里面的 scripts 添加</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"nodemon -e js ./index.js"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>启动项目</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ npm run start<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后扫描控制台的二维码就能实现登录了。</p>
<h1 id="第三方聊天-API-接入"><a href="#第三方聊天-API-接入" class="headerlink" title="第三方聊天 API 接入"></a>第三方聊天 API 接入</h1><p>这里考察了一下常见的聊天 API</p>
<ol>
<li><p>小冰</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cueGlhb2ljZS5jb20v">小冰<i class="fa fa-external-link-alt"></i></span>这里网上有<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lhbndpaS9tc3hpYW9pY2VhcGk=">微博接入<i class="fa fa-external-link-alt"></i></span>的方式，在<span class="exturl" data-url="aHR0cHM6Ly9jbi5iaW5nLmNvbS8=">必应<i class="fa fa-external-link-alt"></i></span>的右边也有小冰，查看 network 也能实现接入，不过微博那个需要 cookie，没有的话小冰应该也会失效。</p>
</li>
<li><p>图灵机器人</p>
<p><span class="exturl" data-url="aHR0cDovL3d3dy50dXJpbmdhcGkuY29tLw==">图灵机器人<i class="fa fa-external-link-alt"></i></span>是常被提起的一个三方 API，不过未认证用户每天限制发送的条数很少，即使认证了发送的条数也不多。</p>
</li>
<li><p>腾讯智能对话平台 TBP</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9wcm9kdWN0L3RicA==">腾讯智能对话<i class="fa fa-external-link-alt"></i></span>目前在测试阶段，需要申请测试资格才可以引入。</p>
</li>
<li><p>天行机器人</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cudGlhbmFwaS5jb20vYXBpdmlldy80Nw==">天行机器人<i class="fa fa-external-link-alt"></i></span>需要认证，认证之后有一定数量的免费条数。</p>
</li>
<li><p>青云客</p>
<p><span class="exturl" data-url="aHR0cDovL2FwaS5xaW5neXVua2UuY29tLw==">青云客<i class="fa fa-external-link-alt"></i></span>是一个免费的，简易的聊天机器人 API，不过聊天情况有点不太理想，可能语料差点。</p>
</li>
<li><p>海知智能</p>
<p><span class="exturl" data-url="aHR0cDovL3J1eWkuYWkv">海知智能<i class="fa fa-external-link-alt"></i></span>是一个不仅限于聊天的 AI。</p>
</li>
<li><p>思知</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9jb25zb2xlLm93bnRoaW5rLmNvbS8=">思知<i class="fa fa-external-link-alt"></i></span>是一个免费的聊天 AI，可以不申请 appid。</p>
</li>
<li><p>茉莉机器人</p>
<p><span class="exturl" data-url="aHR0cDovL3d3dy5pdHBrLmNuLw==">茉莉机器人<i class="fa fa-external-link-alt"></i></span>接入倒是很方便，就是响应有点慢。</p>
</li>
</ol>
<p>这里我们选用了思知智能，接口调用方式可以<span class="exturl" data-url="aHR0cHM6Ly93d3cub3dudGhpbmsuY29tL2RvY3MvcGxhdGZvcm0v">参考文档<i class="fa fa-external-link-alt"></i></span>，可以不用申请 appid，也可以申请了使用自己的机器人。</p>
<p>先添加 http 请求的库 axios:</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ yarn add axios<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>添加库到 index.js</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"axios"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们修改获取信息的代码 onMessage 如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> contact <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">talker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token keyword">await</span> contact<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> text <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> toContactSelf <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">name: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">,text：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>text<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">"xiaoming"</span> <span class="token operator">&amp;&amp;</span> toContactSelf<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> bot<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>Type<span class="token punctuation">.</span>Text<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://api.ownthink.com/bot?appid=xxx&amp;userid=xxx&amp;spoken=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>
        text
      <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">let</span> json <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> msg<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>data<span class="token punctuation">.</span>data<span class="token punctuation">.</span>info<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Request Failed"</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">await</span> msg<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">"发文字我们才能好好聊天哦~"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里我们是设置了只有 xiaoming 发过来的非群的文本信息我们才响应机器人回答。</p>
<img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/20210807172327.jpg" style="zoom:50%" />

<p>总体来说支持的比较少，只能发文字和文件，api 例子中的用<code>wechaty-puppet-wechat</code>很多不能发，建议需要多功能的换 ipad 的协议，<span class="exturl" data-url="aHR0cHM6Ly93ZWNoYXR5LmpzLm9yZy9kb2NzL3B1cHBldC1zZXJ2aWNlcy9jb21wYXRpYmlsaXR5Lw==">参考能力<i class="fa fa-external-link-alt"></i></span>。</p>
<p>目前只做了一个闲聊的机器人，如果要做咨询型或者任务型的还是需要加上NLP（包含NLU语言理解、NLG语音生成等），需要了解意图 、实体等概念，需要加入中文的语料，分词等。NLP这里推荐rasa，开源的。rasa包含两个rasa NLU和rasa Core。</p>
<p>rasa NLU(主要用于理解用户消息，包括意图识别、实体识别、填充槽位值等，把用户的自然语言输入转换为结构化数据 )；rasa Core 对话管理平台，类似于对话系统中DPL(对话策略学习)、DST(对话策略跟踪)。</p>
<p>如果想用现成的NLP平台有api.ai，现在叫<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RpYWxvZ2Zsb3c=">Dialogflow<i class="fa fa-external-link-alt"></i></span>，如果涉及到语音的话，需要加入ASR（语音识别）、TTS（语音合成），技术栈可选择BotPress+Rasa+wechaty+mongodb。</p>
]]></content>
      <categories>
        <category>搭建教程</category>
      </categories>
      <tags>
        <tag>chatbot</tag>
        <tag>wechaty</tag>
      </tags>
  </entry>
  <entry>
    <title>Threejs屏幕坐标和世界坐标</title>
    <url>/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/Threejs%E5%B1%8F%E5%B9%95%E5%9D%90%E6%A0%87%E5%92%8C%E4%B8%96%E7%95%8C%E5%9D%90%E6%A0%87/</url>
    <content><![CDATA[<p>这里记录一下Three.js中屏幕坐标与世界坐标互转。</p>
<span id="more"></span>

<p>Three.js中如果要点击一个场景中的物体，需要用到屏幕坐标和世界坐标的互转，转换需要以下几步</p>
<p>屏幕坐标=&gt;标准设备坐标=&gt;世界坐标，我们常用的屏幕坐标系如下，左上角是原点。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/202209082058272.png" alt="常用坐标系"></p>
<p>而标准设备坐标采用右手坐标系，示例图如下：</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/202209082058998.png" alt="右手坐标系"></p>
<h1 id="屏幕坐标转世界坐标"><a href="#屏幕坐标转世界坐标" class="headerlink" title="屏幕坐标转世界坐标"></a>屏幕坐标转世界坐标</h1><p>转换步骤如下：</p>
<ol>
<li><p>这里我们设canvas坐标系的宽为 $w$ ，高为 $h$ ，Three.js中的中心点就是$w/2$,$h/2$,</p>
</li>
<li><p>假设有一个点canvas坐标为(x,y)，那么这个点相对于Three.js中的中心点就是<br>$$<br>x_1=-(\frac{w}{2}-x)<br>$$</p>
<p>$$<br>y_1=(\frac{h}{2}-y)<br>$$</p>
<p><strong>注意x轴和y轴的方向。</strong></p>
</li>
<li><p>将$x_1$,$y_1$标准化到[-1,1]之间，需要再除以Three.js的中心点，转换如下：<br>$$<br>x_1=\frac{-(\frac{w}{2}-x)}{\frac{w}{2}}=\frac{2x}{w}-1<br>$$</p>
<p>$$<br>y_1=\frac{(\frac{h}{2}-y)}{\frac{h}{2}}=-\frac{2y}{h}+1<br>$$</p>
</li>
</ol>
<p>使用代码表示：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> x <span class="token operator">=</span> event<span class="token punctuation">.</span>clientX<span class="token punctuation">;</span><span class="token comment">//鼠标单击坐标X</span>
<span class="token keyword">const</span> y <span class="token operator">=</span> event<span class="token punctuation">.</span>clientY<span class="token punctuation">;</span><span class="token comment">//鼠标单击坐标Y</span>

<span class="token comment">// 屏幕坐标转标准设备坐标</span>
<span class="token keyword">const</span> x1 <span class="token operator">=</span> <span class="token punctuation">(</span> x <span class="token operator">/</span> window<span class="token punctuation">.</span>innerWidth <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> y1 <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span> y <span class="token operator">/</span> window<span class="token punctuation">.</span>innerHeight <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> stdVector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//0.5为约定俗成</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>设备坐标转世界坐标</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> worldVector <span class="token operator">=</span> stdVector<span class="token punctuation">.</span><span class="token function">unproject</span><span class="token punctuation">(</span>camera<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h1 id="世界坐标转屏幕坐标"><a href="#世界坐标转屏幕坐标" class="headerlink" title="世界坐标转屏幕坐标"></a>世界坐标转屏幕坐标</h1><p>世界坐标转屏幕坐标与上面相反，推导出公式为：</p>
<p>$$<br>x=x_1*\frac{w}{2}+\frac{w}{2}<br>$$</p>
<p>$$<br>y=-y_1*\frac{h}{2}+\frac{h}{2}<br>$$</p>
<p>使用代码表示：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token keyword">const</span> centerX <span class="token operator">=</span> window<span class="token punctuation">.</span>innerWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> centerY <span class="token operator">=</span> window<span class="token punctuation">.</span>innerHeight <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> standardVec <span class="token operator">=</span> worldVector<span class="token punctuation">.</span><span class="token function">project</span><span class="token punctuation">(</span>camera<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> screenX <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>centerX <span class="token operator">*</span> standardVec<span class="token punctuation">.</span>x <span class="token operator">+</span> centerX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> screenY <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token operator">-</span>centerY <span class="token operator">*</span> standardVec<span class="token punctuation">.</span>y <span class="token operator">+</span> centerY<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      <categories>
        <category>工作笔记</category>
      </categories>
      <tags>
        <tag>Three.js</tag>
      </tags>
  </entry>
  <entry>
    <title>AVP项目性能优化总结</title>
    <url>/%E5%B7%A5%E4%BD%9C%E7%AC%94%E8%AE%B0/AVP%E9%A1%B9%E7%9B%AE%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<p>我们在项目开发中都会遇到一些性能方面的问题，这里主要记录总结一下我在 AVP 项目中遇到的问题，以及解决方法。</p>
<span id="more"></span>

<h1 id="问题-amp-解决方法"><a href="#问题-amp-解决方法" class="headerlink" title="问题&amp;解决方法"></a>问题&amp;解决方法</h1><h2 id="问题-1：频繁切换-Tab-导致页面卡顿"><a href="#问题-1：频繁切换-Tab-导致页面卡顿" class="headerlink" title="问题 1：频繁切换 Tab 导致页面卡顿"></a>问题 1：频繁切换 Tab 导致页面卡顿</h2><p><strong>原因分析：</strong> 在切换 tab 的时候会频繁的调用页面的生命周期，可以从页面的生命周期着手，js 是单线程，造成卡死应该是线程一直阻塞</p>
<p><strong>解决方式：</strong> 经过排查，发现在 Threejs 中的创建 CylinderGeometry 有分段的参数 segments，为了线条更平滑，分段数的值会填写得比较大，查看相关 API 源码发现，Threejs 会根据你填写的分段数进行 for 循环计算顶点。Threejs 中部分源码如下所示：</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/202209082035856.png" alt="部分源码"></p>
<p>如果分段数过大，for 循环会造成严重的 js 阻塞，页面卡顿很严重，这里我们把分段数改小，呈现的图形视觉上能看清即可，比如圆弧，数值大致在 20 左右即可。</p>
<h2 id="问题-2：页面内存泄漏"><a href="#问题-2：页面内存泄漏" class="headerlink" title="问题 2：页面内存泄漏"></a>问题 2：页面内存泄漏</h2><p><strong>原因分析：</strong> 这里我们采用发送模拟数据的方式测试，模拟数据发送速度快，方便观察内存泄漏的情况，如果有创建的变量以及几何体存在未释放的情况，会造成内存泄漏。</p>
<p><strong>解决方式：</strong></p>
<ol>
<li><p>帧动画需要移除<code>cancelAnimationFrame(frameNum)</code></p>
</li>
<li><p>在 Threejs 中每一个创建的 geometry 和 material，包括 material 中包含的 texture，都需要清除，调用 dispose 方法，如果包含有多种 mesh，例如 environment，需要遍历 traverse 来清除 mesh，代码如下：</p>
 <pre class="line-numbers language-js" data-language="js"><code class="language-js">environment<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token keyword">instanceof</span> <span class="token class-name">Mesh</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        item<span class="token punctuation">.</span>geometry<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>material<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>mesh 可以清除并移除</p>
 <pre class="line-numbers language-js" data-language="js"><code class="language-js">mesh<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mesh<span class="token punctuation">.</span><span class="token function">removeFromParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
<li><p>WebGLRenderer 也需要清除</p>
 <pre class="line-numbers language-js" data-language="js"><code class="language-js">renderer<span class="token punctuation">.</span>renderLists<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
renderer<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
renderer<span class="token punctuation">.</span><span class="token function">forceContextLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
</ol>
<p>可以使用 WebGLRenderer 的 info 属性可查询图形内存和渲染过程中的一些统计信息，这里用来查看内存中还剩余多少 geometry 和 material。</p>
<p><img data-src="https://cdn.jsdelivr.net/gh/FreedomAnt/image@main/img/202209082042749.png" alt="查看剩余"></p>
<h2 id="问题-3：页面运行一段时间卡死"><a href="#问题-3：页面运行一段时间卡死" class="headerlink" title="问题 3：页面运行一段时间卡死"></a>问题 3：页面运行一段时间卡死</h2><p><strong>原因分析：</strong> 业务场景为：登录之后订阅接收历史轨迹线，后端发送历史轨迹线是一个点一个点的发送，前端在另一个页面需要呈现总的历史轨迹线，历史轨迹线不清空，测试发现在历史轨迹线大量接收且绘制线段的情况下运行一段时间页面会卡死。主要有两个原因：</p>
<ol>
<li>历史轨迹线需要存取 5 万个点，每一个点是 xyz 三个坐标，就是 15 万长度的数组，存取采用的存取到 sessionStorage，由于发送数据的速度很快，约 10ms~20ms，就会频繁的操作 storage，造成性能问题，且数组很大，大数组的删除添加也会造成一定的性能问题。</li>
<li>在画历史轨迹线的时候采用的先定义一个总的数组，也就是 15 万个值的一个数组，画轨迹线的时候会频繁的操作这个数组<strong>并根据这个数组更新线段</strong>，会造成很大的性能压力。</li>
</ol>
<p><strong>解决方式：</strong></p>
<ol>
<li>首先解决第一个问题，这里我们采用类似 buff 的形式，使用一个临时数组来存放收到的历史点位，定义一个存放 1000 个点的数组，长度为 3000，挂在 window 下面，如果存满了，再向 storage 里面写，storage 里面存满 15 万个点之后，如果临时数组满了，就先删除 storage 里面前面的 3000 个点，再将临时数组 push 到 storage 里面。</li>
<li>第二个问题采用分段画线的方式，进入页面的时候，把 storage 里面的总数组和 window 里面的临时数组 concat，然后初始化线段，初始化的时候将总数组分段画线，这里以 1000 个点(即 3000 长度的数组)为 thunk，每一个都画一条线段并添加到 group 里面，并建立一个临时的 tempLine，点位数组长度为 3000，放在 group 第一位，用来存放新接收的点位，当临时线段的点长度满 3000，就将点位新建一个 line 并 push 到 group 末尾，清空 tempLine，如果总的 line 数量达到了存满 5 万个点，就删除第二个 line(第一个为 tempLine)。</li>
</ol>
<h2 id="问题-4：页面接收到原有的-listener-数据"><a href="#问题-4：页面接收到原有的-listener-数据" class="headerlink" title="问题 4：页面接收到原有的 listener 数据"></a>问题 4：页面接收到原有的 listener 数据</h2><p><strong>原因分析：</strong> 经过测试发现，在 Electron 主进程和渲染进程通信桥接的过程中，由于 listener 发送接收挂在 window 下面，在注册了 listener 之后没有及时的清除掉，页面刷新后导致新建的 listener 收到了原注册的 listener 本该收到的数据。</p>
<p><strong>解决方式：</strong> 在每次注册了相关的 listener 之后，在页面生命周期结束的时候要记得 remove 掉该 listener，相关代码如下：</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">receive<span class="token operator">:</span> <span class="token punctuation">(</span>channel<span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token function-variable function">listener</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args<span class="token operator">:</span> any<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token parameter">Function</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> <span class="token function-variable function">tempListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> Electron<span class="token punctuation">.</span>IpcRendererEvent<span class="token punctuation">,</span> data<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token function">listener</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ipcRenderer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> tempListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        ipcRenderer<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> tempListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>也可通过<code>ipcRenderer.eventNames</code>和<code>ipcRenderer.listenerCount</code>查看某个 channel 还剩多少 listener。</p>
<h2 id="问题-5：子组件频繁更新"><a href="#问题-5：子组件频繁更新" class="headerlink" title="问题 5：子组件频繁更新"></a>问题 5：子组件频繁更新</h2><p><strong>原因分析：</strong> 在 React 中，我们知道任一的 props 改变或者 setState，组件都会被更新，原有的逻辑是父组件接收到数据，由 props 传到子组件，父组件频繁的接收数据通过 props 传到子组件，导致子组件频繁刷新。</p>
<p><strong>解决方式：</strong></p>
<ol>
<li>直接通过 props 传几组数据方式不太好，这里改为父组件调用子组件的方法，子组件通过 useImperativeHandle 暴露函数，父组件接收到数据之后调用此函数</li>
<li>如果子组件要更新父组件的内容，不用把父组件的变量参数都传到子组件，可通过 props 的方式传递父组件的函数，子组件来调用该函数</li>
<li>子组件为避免频繁更新，需要加上<code>React.memo</code></li>
<li>可缓存的函数使用 useCallback</li>
</ol>
<h2 id="其他优化"><a href="#其他优化" class="headerlink" title="其他优化"></a>其他优化</h2><h3 id="删除冗余代码"><a href="#删除冗余代码" class="headerlink" title="删除冗余代码"></a>删除冗余代码</h3><p>删除掉冗余代码，例如<code>line.computeLineDistances()</code>实际没有用到距离，可删除，减少 threejs 内部操作。</p>
<h3 id="提取重复代码"><a href="#提取重复代码" class="headerlink" title="提取重复代码"></a>提取重复代码</h3><p>threejs 的模型比较耗内存，频繁加载同一模型的情况下，可将模型提取到 umi 的 useModel 中</p>
<h3 id="在-render-中少做操作"><a href="#在-render-中少做操作" class="headerlink" title="在 render 中少做操作"></a>在 render 中少做操作</h3><p>一般来说我们调用 render 根据 requestAnimationFrame 来做的操作，调用非常频繁，在 render 里面需要少做其他操作，比如 resize，可提取到外部操作一次即可。</p>
<h3 id="部分几何体替换"><a href="#部分几何体替换" class="headerlink" title="部分几何体替换"></a>部分几何体替换</h3><p>有部分几何体只实现了简单的功能，可用其他代替，例如 TextGeometry，实际中没有用到 3D 的场景，可使用 canvas 贴图来代替。</p>
<h3 id="部分逻辑优化"><a href="#部分逻辑优化" class="headerlink" title="部分逻辑优化"></a>部分逻辑优化</h3><p>原有的线障碍物的方式是两个点，需求是根据两个点来画出一个厚度 50 的长方体，原有的方式是通过两个点计算出长方体顶部的 4 个点来绘制，代码未加注释的情况下晦涩难懂，这里改为根据两个点的长度和中心点先画一个长方体 BoxGeometry，再根据原有的两个点连接成的线段与 X 轴的夹角来计算长方体的旋转弧度。代码精简易读。</p>
<h3 id="其他注意点："><a href="#其他注意点：" class="headerlink" title="其他注意点："></a>其他注意点：</h3><p>●  多个地方用同一个引用的话，对象的操作会影响到其他的引用，需要 clone 一份新的数据，例如 carModel、PDC 里面的点位 reverse 等。<br>●  数组循环过程中不能有删除当前数组的操作<br>●  数组操作的时候，例如 7 除以 10，用除法<code>7/10</code>，不要用<code>7*0.1</code>这种乘法的方式，会有精度问题<br>●  如果两个物体的绘制有重叠并且闪烁的情况，考虑 Material 的<code>depthTest</code>属性设置为<code>false</code><br>●  摄像头的属性改变之后需要设置<code>camera.updateProjectionMatrix()</code><br>●  注意 OrthographicCamera 相机镜头的远近是使用 minZoom 和 maxZoom，PerspectiveCamera 相机镜头的远近使用 minDistance 和 maxDistance<br>●  如果场景 Scene 旋转了，这时候用 CameraHelper 不太好观察，CameraHelper 的图形还是没有旋转的图形，需要设置摄像头的正方向，即<code>camera.up.set(0,0,1)</code>。<br>●  设置 OrbitControls 的原点<code>control.target</code>的时候需要注意，如果有 reset 的情况，原点设置了之后需要保存当前原点并更新，即</p>
<pre class="line-numbers language-js" data-language="js"><code class="language-js">control<span class="token punctuation">.</span>target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">135</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
control<span class="token punctuation">.</span><span class="token function">saveState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
control<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      <categories>
        <category>工作笔记</category>
      </categories>
      <tags>
        <tag>Three.js</tag>
        <tag>Electron</tag>
      </tags>
  </entry>
</search>
